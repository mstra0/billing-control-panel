<?php
// ============================================================
// CONTROL PANEL - Single File
// PHP 5.6 Compatible - Final Build
// ============================================================
//
// PHASE 1: CONFIG & WRAPPER FUNCTIONS
//
// ============================================================

// Set timezone to avoid warnings in PHP 5.6
date_default_timezone_set("UTC");

// ------------------------------------------------------------
// CONFIGURATION
// ------------------------------------------------------------

// MOCK MODE: Set to true for local testing, false for production
define("MOCK_MODE", true);

// Shared drive symlink path (customize this for production)
define("SHARED_BASE_PATH", "/var/www/html/shared");

// Subdirectories (used when MOCK_MODE is false)
define("PATH_GENERATED", SHARED_BASE_PATH . "/generated"); // Cron outputs reports here
define("PATH_PENDING", SHARED_BASE_PATH . "/pending"); // Dead-drop for config CSVs
define("PATH_ARCHIVE", SHARED_BASE_PATH . "/archive"); // Historical record

// File patterns
define("REPORT_PREFIX", "DataX_");
define("CONFIG_PREFIX", "config_");

// Pagination
define("ITEMS_PER_PAGE", 50);

// ------------------------------------------------------------
// REMOTE DATABASE WRAPPER FUNCTIONS
// ------------------------------------------------------------
// Implement these with your existing DB classes for READ-ONLY access
// Example: require_once '/path/to/your/db.class.php';
// ------------------------------------------------------------

/**
 * Execute a SELECT query on REMOTE database, return array of rows
 *
 * @param string $sql    SQL query with ? placeholders
 * @param array  $params Parameters to bind
 * @return array         Array of associative arrays
 */
function remote_db_query($sql, $params = [])
{
    // TODO: Replace with your remote DB implementation
    // STUB: Returns empty array
    return [];
}

// ------------------------------------------------------------
// LOCAL SQLITE DATABASE
// ------------------------------------------------------------

$_sqlite_db = null;

/**
 * Get SQLite database connection (singleton)
 *
 * @return SQLite3
 */
function sqlite_db()
{
    global $_sqlite_db;

    if ($_sqlite_db === null) {
        // Use test database if TEST_MODE is defined
        if (defined("TEST_MODE") && TEST_MODE && defined("TEST_DB_PATH")) {
            $db_path = TEST_DB_PATH;
        } else {
            $db_path = get_shared_path() . "/control_panel.db";
        }

        $_sqlite_db = new SQLite3($db_path);
        $_sqlite_db->enableExceptions(true);
        $_sqlite_db->busyTimeout(5000);

        // Enable foreign keys
        $_sqlite_db->exec("PRAGMA foreign_keys = ON");

        // Initialize schema if needed
        sqlite_init_schema();

        // Run migrations
        sqlite_run_migrations();
    }

    return $_sqlite_db;
}

/**
 * Execute a SELECT query on local SQLite, return array of rows
 *
 * @param string $sql    SQL query with ? placeholders
 * @param array  $params Parameters to bind
 * @return array         Array of associative arrays
 */
function sqlite_query($sql, $params = [])
{
    $db = sqlite_db();
    $stmt = $db->prepare($sql);

    if ($stmt === false) {
        return [];
    }

    // Bind parameters
    $i = 1;
    foreach ($params as $param) {
        if (is_int($param)) {
            $stmt->bindValue($i, $param, SQLITE3_INTEGER);
        } elseif (is_float($param)) {
            $stmt->bindValue($i, $param, SQLITE3_FLOAT);
        } elseif (is_null($param)) {
            $stmt->bindValue($i, null, SQLITE3_NULL);
        } else {
            $stmt->bindValue($i, $param, SQLITE3_TEXT);
        }
        $i++;
    }

    $result = $stmt->execute();
    $rows = [];

    while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
        $rows[] = $row;
    }

    return $rows;
}

/**
 * Execute an INSERT/UPDATE/DELETE on local SQLite
 *
 * @param string $sql    SQL query with ? placeholders
 * @param array  $params Parameters to bind
 * @return bool          Success/failure
 */
function sqlite_execute($sql, $params = [])
{
    $db = sqlite_db();
    $stmt = $db->prepare($sql);

    if ($stmt === false) {
        return false;
    }

    // Bind parameters
    $i = 1;
    foreach ($params as $param) {
        if (is_int($param)) {
            $stmt->bindValue($i, $param, SQLITE3_INTEGER);
        } elseif (is_float($param)) {
            $stmt->bindValue($i, $param, SQLITE3_FLOAT);
        } elseif (is_null($param)) {
            $stmt->bindValue($i, null, SQLITE3_NULL);
        } else {
            $stmt->bindValue($i, $param, SQLITE3_TEXT);
        }
        $i++;
    }

    return $stmt->execute() !== false;
}

/**
 * Get last insert ID from SQLite
 *
 * @return int
 */
function sqlite_last_id()
{
    return sqlite_db()->lastInsertRowID();
}

/**
 * Initialize SQLite schema
 */
function sqlite_init_schema()
{
    global $_sqlite_db;

    $schema = "
    -- ============================================================
    -- CORE ENTITIES (synced from remote or manually managed)
    -- ============================================================

    CREATE TABLE IF NOT EXISTS customers (
        id INTEGER PRIMARY KEY,
        name TEXT NOT NULL,
        discount_group_id INTEGER,
        lms_id INTEGER REFERENCES lms(id),  -- FK to lms table (required for billing)
        status TEXT DEFAULT 'active' CHECK(status IN ('active', 'paused', 'decommissioned')),
        contract_start_date TEXT,
        created_at TEXT DEFAULT (datetime('now')),
        updated_at TEXT DEFAULT (datetime('now'))
    );

    CREATE TABLE IF NOT EXISTS discount_groups (
        id INTEGER PRIMARY KEY,
        name TEXT NOT NULL,
        created_at TEXT DEFAULT (datetime('now'))
    );

    CREATE TABLE IF NOT EXISTS services (
        id INTEGER PRIMARY KEY,
        name TEXT NOT NULL,
        created_at TEXT DEFAULT (datetime('now'))
    );

    -- ============================================================
    -- TRANSACTION TYPES (from displayname_to_type.csv)
    -- Maps display names to EFX codes for billing system
    -- ============================================================

    CREATE TABLE IF NOT EXISTS transaction_types (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        type TEXT NOT NULL,              -- grouping category
        display_name TEXT NOT NULL,      -- internal system display name
        efx_code TEXT NOT NULL,          -- EFX system code
        efx_displayname TEXT,            -- EBDIC-constrained name
        service_id INTEGER,              -- link to service if applicable
        created_at TEXT DEFAULT (datetime('now')),
        UNIQUE(efx_code, display_name)
    );

    CREATE INDEX IF NOT EXISTS idx_transaction_types_efx
        ON transaction_types(efx_code);

    -- ============================================================
    -- SERVICE BILLING FLAGS (by_hit, zero_null, bav_by_trans)
    -- Default flags per service, can be overridden at group/customer level
    -- ============================================================

    CREATE TABLE IF NOT EXISTS service_billing_flags (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        level TEXT NOT NULL CHECK(level IN ('default', 'group', 'customer')),
        level_id INTEGER,  -- NULL for default, group_id for group, customer_id for customer
        service_id INTEGER NOT NULL,
        efx_code TEXT NOT NULL,
        by_hit INTEGER DEFAULT 1,        -- 0 or 1
        zero_null INTEGER DEFAULT 0,     -- 0 or 1
        bav_by_trans INTEGER DEFAULT 0,  -- 0 or 1
        effective_date TEXT NOT NULL DEFAULT (date('now')),
        created_at TEXT DEFAULT (datetime('now')),
        FOREIGN KEY (service_id) REFERENCES services(id)
    );

    CREATE INDEX IF NOT EXISTS idx_service_billing_flags_lookup
        ON service_billing_flags(level, level_id, service_id, efx_code, effective_date);

    -- ============================================================
    -- PRICING TIERS (append-only, hierarchical)
    -- ============================================================

    CREATE TABLE IF NOT EXISTS pricing_tiers (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        effective_date TEXT NOT NULL DEFAULT (date('now')),
        level TEXT NOT NULL CHECK(level IN ('default', 'group', 'customer')),
        level_id INTEGER,  -- NULL for default, group_id for group, customer_id for customer
        service_id INTEGER NOT NULL,
        volume_start INTEGER NOT NULL,
        volume_end INTEGER,  -- NULL = unlimited
        price_per_inquiry REAL NOT NULL,
        created_at TEXT DEFAULT (datetime('now')),
        FOREIGN KEY (service_id) REFERENCES services(id)
    );

    CREATE INDEX IF NOT EXISTS idx_pricing_tiers_lookup
        ON pricing_tiers(level, level_id, service_id, effective_date);

    -- ============================================================
    -- CUSTOMER SETTINGS (append-only)
    -- ============================================================

    CREATE TABLE IF NOT EXISTS customer_settings (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        customer_id INTEGER NOT NULL,
        effective_date TEXT NOT NULL DEFAULT (date('now')),
        monthly_minimum REAL,
        uses_annualized INTEGER DEFAULT 0,
        annualized_start_date TEXT,
        look_period_months INTEGER,
        created_at TEXT DEFAULT (datetime('now')),
        FOREIGN KEY (customer_id) REFERENCES customers(id)
    );

    CREATE INDEX IF NOT EXISTS idx_customer_settings_lookup
        ON customer_settings(customer_id, effective_date);

    -- ============================================================
    -- ESCALATORS (append-only)
    -- ============================================================

    CREATE TABLE IF NOT EXISTS customer_escalators (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        customer_id INTEGER NOT NULL,
        effective_date TEXT NOT NULL DEFAULT (date('now')),
        escalator_start_date TEXT NOT NULL,
        year_number INTEGER NOT NULL,
        escalator_percentage REAL DEFAULT 0,
        fixed_adjustment REAL DEFAULT 0,
        created_at TEXT DEFAULT (datetime('now')),
        FOREIGN KEY (customer_id) REFERENCES customers(id)
    );

    CREATE INDEX IF NOT EXISTS idx_escalators_lookup
        ON customer_escalators(customer_id, year_number, effective_date);

    CREATE TABLE IF NOT EXISTS escalator_delays (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        customer_id INTEGER NOT NULL,
        year_number INTEGER NOT NULL,
        delay_months INTEGER DEFAULT 1,
        applied_date TEXT DEFAULT (datetime('now')),
        created_at TEXT DEFAULT (datetime('now')),
        FOREIGN KEY (customer_id) REFERENCES customers(id)
    );

    -- ============================================================
    -- BUSINESS RULES (append-only masks)
    -- ============================================================

    CREATE TABLE IF NOT EXISTS business_rules (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        customer_id INTEGER NOT NULL,
        rule_name TEXT NOT NULL,
        rule_description TEXT,
        synced_at TEXT DEFAULT (datetime('now')),
        FOREIGN KEY (customer_id) REFERENCES customers(id)
    );

    CREATE TABLE IF NOT EXISTS business_rule_masks (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        customer_id INTEGER NOT NULL,
        rule_name TEXT NOT NULL,
        is_masked INTEGER DEFAULT 0,
        effective_date TEXT NOT NULL DEFAULT (date('now')),
        created_at TEXT DEFAULT (datetime('now')),
        FOREIGN KEY (customer_id) REFERENCES customers(id)
    );

    CREATE INDEX IF NOT EXISTS idx_rule_masks_lookup
        ON business_rule_masks(customer_id, rule_name, effective_date);

    -- ============================================================
    -- LMS (Loan Management System) - Revenue Tracking
    -- ============================================================

    -- LMS is sourced from: connectors table + [second source TBD]
    -- Status synced from source; commission_rate is local only
    CREATE TABLE IF NOT EXISTS lms (
        id INTEGER PRIMARY KEY,
        name TEXT NOT NULL,
        status TEXT DEFAULT 'active' CHECK(status IN ('active', 'paused', 'decommissioned')),
        commission_rate REAL,  -- NULL = inherit from system default (LOCAL ONLY)
        last_synced TEXT,
        created_at TEXT DEFAULT (datetime('now')),
        updated_at TEXT DEFAULT (datetime('now'))
    );

    -- System settings (for default commission rate, etc.)
    CREATE TABLE IF NOT EXISTS system_settings (
        key TEXT PRIMARY KEY,
        value TEXT,
        updated_at TEXT DEFAULT (datetime('now'))
    );

    -- COGS per service (synced from main DB)
    CREATE TABLE IF NOT EXISTS service_cogs (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        service_id INTEGER NOT NULL,
        cogs_rate REAL NOT NULL,
        effective_date TEXT NOT NULL DEFAULT (date('now')),
        created_at TEXT DEFAULT (datetime('now')),
        FOREIGN KEY (service_id) REFERENCES services(id)
    );

    CREATE INDEX IF NOT EXISTS idx_service_cogs_lookup
        ON service_cogs(service_id, effective_date);

    -- ============================================================
    -- BILLING REPORTS (imported from billing system)
    -- ============================================================

    CREATE TABLE IF NOT EXISTS billing_reports (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        report_type TEXT NOT NULL CHECK(report_type IN ('daily', 'monthly')),
        report_year INTEGER NOT NULL,
        report_month INTEGER NOT NULL,
        report_date TEXT NOT NULL,  -- Full date for daily reports
        imported_at TEXT DEFAULT (datetime('now')),
        file_path TEXT,
        record_count INTEGER
    );

    CREATE INDEX IF NOT EXISTS idx_billing_reports_lookup
        ON billing_reports(report_type, report_year, report_month);

    CREATE TABLE IF NOT EXISTS billing_report_lines (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        report_id INTEGER NOT NULL,
        year INTEGER NOT NULL,
        month INTEGER NOT NULL,
        customer_id INTEGER NOT NULL,
        customer_name TEXT,
        hit_code TEXT,
        tran_displayname TEXT,
        actual_unit_cost REAL,
        count INTEGER,
        revenue REAL,
        efx_code TEXT,
        billing_id TEXT,
        FOREIGN KEY (report_id) REFERENCES billing_reports(id),
        FOREIGN KEY (customer_id) REFERENCES customers(id)
    );

    CREATE INDEX IF NOT EXISTS idx_billing_lines_customer
        ON billing_report_lines(customer_id, year, month);

    CREATE INDEX IF NOT EXISTS idx_billing_lines_report
        ON billing_report_lines(report_id);

    -- ============================================================
    -- SYNC LOG (track remote syncs)
    -- ============================================================

    CREATE TABLE IF NOT EXISTS sync_log (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        entity_type TEXT NOT NULL,
        synced_at TEXT DEFAULT (datetime('now')),
        record_count INTEGER,
        status TEXT DEFAULT 'success'
    );
    ";

    $_sqlite_db->exec($schema);
}

/**
 * Run database migrations for schema updates
 */
function sqlite_run_migrations()
{
    global $_sqlite_db;

    // Migration 1: Add lms_id column to customers if it doesn't exist
    $result = $_sqlite_db->query("PRAGMA table_info(customers)");
    $has_lms_id = false;
    while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
        if ($row["name"] === "lms_id") {
            $has_lms_id = true;
            break;
        }
    }
    if (!$has_lms_id) {
        $_sqlite_db->exec(
            "ALTER TABLE customers ADD COLUMN lms_id INTEGER REFERENCES lms(id)"
        );
    }

    // Migration 2: Add status column to lms if it doesn't exist
    $result = $_sqlite_db->query("PRAGMA table_info(lms)");
    $has_status = false;
    while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
        if ($row["name"] === "status") {
            $has_status = true;
            break;
        }
    }
    if (!$has_status) {
        $_sqlite_db->exec(
            "ALTER TABLE lms ADD COLUMN status TEXT DEFAULT 'active'"
        );
    }
}

// ------------------------------------------------------------
// SQLITE HELPER FUNCTIONS
// ------------------------------------------------------------

/**
 * Get the current (latest effective) record for an entity
 *
 * @param string $table      Table name
 * @param array  $conditions Key-value pairs for WHERE clause
 * @return array|null        Single row or null
 */
function sqlite_get_current($table, $conditions)
{
    $where = [];
    $params = [];

    foreach ($conditions as $key => $value) {
        $where[] = "$key = ?";
        $params[] = $value;
    }

    $where[] = "effective_date <= date('now')";
    $where_str = implode(" AND ", $where);

    $sql = "SELECT * FROM $table WHERE $where_str ORDER BY effective_date DESC, id DESC LIMIT 1";
    $rows = sqlite_query($sql, $params);

    return !empty($rows) ? $rows[0] : null;
}

/**
 * Get all current records (latest effective for each unique entity)
 *
 * @param string $table       Table name
 * @param string $group_by    Column(s) to group by
 * @param array  $conditions  Additional WHERE conditions
 * @param int    $page        Page number (1-indexed)
 * @param int    $per_page    Items per page
 * @return array              Array of rows
 */
function sqlite_get_all_current(
    $table,
    $group_by,
    $conditions = [],
    $page = 1,
    $per_page = ITEMS_PER_PAGE
) {
    $where = ["effective_date <= date('now')"];
    $params = [];

    foreach ($conditions as $key => $value) {
        $where[] = "$key = ?";
        $params[] = $value;
    }

    $where_str = implode(" AND ", $where);
    $offset = ($page - 1) * $per_page;

    // Subquery to get latest effective_date for each group
    $sql = "
        SELECT t1.* FROM $table t1
        INNER JOIN (
            SELECT $group_by, MAX(effective_date) as max_date
            FROM $table
            WHERE $where_str
            GROUP BY $group_by
        ) t2 ON t1.$group_by = t2.$group_by AND t1.effective_date = t2.max_date
        WHERE $where_str
        ORDER BY t1.id DESC
        LIMIT ? OFFSET ?
    ";

    $params[] = $per_page;
    $params[] = $offset;

    return sqlite_query($sql, $params);
}

/**
 * Count total records for pagination
 *
 * @param string $table      Table name
 * @param array  $conditions WHERE conditions
 * @return int
 */
function sqlite_count($table, $conditions = [])
{
    $where = ["1=1"];
    $params = [];

    foreach ($conditions as $key => $value) {
        $where[] = "$key = ?";
        $params[] = $value;
    }

    $where_str = implode(" AND ", $where);
    $sql = "SELECT COUNT(*) as cnt FROM $table WHERE $where_str";
    $rows = sqlite_query($sql, $params);

    return !empty($rows) ? (int) $rows[0]["cnt"] : 0;
}

/**
 * Simple pagination info
 *
 * @param int $total      Total records
 * @param int $page       Current page
 * @param int $per_page   Items per page
 * @return array          Pagination info
 */
function paginate($total, $page = 1, $per_page = ITEMS_PER_PAGE)
{
    $total_pages = max(1, ceil($total / $per_page));
    $page = max(1, min($page, $total_pages));
    return [
        "total" => $total,
        "per_page" => $per_page,
        "current" => $page,
        "total_pages" => $total_pages,
        "has_prev" => $page > 1,
        "has_next" => $page < $total_pages,
        "from" => $total > 0 ? (($page - 1) * $per_page) + 1 : 0,
        "to" => min($page * $per_page, $total),
    ];
}

/**
 * Render pagination HTML with numbered pages
 * @param array $pagination - from paginate()
 * @param string $base_url - base URL with action (e.g., "?action=customers")
 * @param array $params - additional query params to preserve (e.g., search, filters)
 */
function render_pagination($pagination, $base_url, $params = [])
{
    if ($pagination["total_pages"] <= 1) {
        return;
    }

    $current = $pagination["current"];
    $total_pages = $pagination["total_pages"];

    // Build URL helper
    $build_url = function($page) use ($base_url, $params) {
        $params["page"] = $page;
        $query = http_build_query($params);
        return $base_url . (strpos($base_url, "?") !== false ? "&" : "?") . $query;
    };

    echo '<div class="pagination">';

    // Previous
    if ($pagination["has_prev"]) {
        echo '<a href="' . h($build_url($current - 1)) . '">&laquo; Prev</a>';
    } else {
        echo '<span class="disabled">&laquo; Prev</span>';
    }

    // Page numbers with ellipsis
    $range = 2; // Pages to show on each side of current
    $start = max(1, $current - $range);
    $end = min($total_pages, $current + $range);

    // Always show first page
    if ($start > 1) {
        echo '<a href="' . h($build_url(1)) . '">1</a>';
        if ($start > 2) {
            echo '<span class="ellipsis">...</span>';
        }
    }

    // Middle pages
    for ($i = $start; $i <= $end; $i++) {
        if ($i == $current) {
            echo '<span class="active">' . $i . '</span>';
        } else {
            echo '<a href="' . h($build_url($i)) . '">' . $i . '</a>';
        }
    }

    // Always show last page
    if ($end < $total_pages) {
        if ($end < $total_pages - 1) {
            echo '<span class="ellipsis">...</span>';
        }
        echo '<a href="' . h($build_url($total_pages)) . '">' . $total_pages . '</a>';
    }

    // Next
    if ($pagination["has_next"]) {
        echo '<a href="' . h($build_url($current + 1)) . '">Next &raquo;</a>';
    } else {
        echo '<span class="disabled">Next &raquo;</span>';
    }

    echo '</div>';

    // Info text
    echo '<div class="pagination-info">';
    echo 'Showing ' . $pagination["from"] . '-' . $pagination["to"] . ' of ' . $pagination["total"];
    echo '</div>';
}

/**
 * Render search bar HTML
 * @param string $action - the action name
 * @param array $options - search options
 */
function render_search_bar($action, $options = [])
{
    $search = isset($options["search"]) ? $options["search"] : "";
    $placeholder = isset($options["placeholder"]) ? $options["placeholder"] : "Search...";
    $filters = isset($options["filters"]) ? $options["filters"] : [];
    $extra_params = isset($options["params"]) ? $options["params"] : [];

    echo '<form method="GET" class="search-bar">';
    echo '<input type="hidden" name="action" value="' . h($action) . '">';

    // Extra hidden params
    foreach ($extra_params as $key => $value) {
        echo '<input type="hidden" name="' . h($key) . '" value="' . h($value) . '">';
    }

    // Search input
    echo '<input type="text" name="search" value="' . h($search) . '" placeholder="' . h($placeholder) . '">';

    // Filter dropdowns
    foreach ($filters as $filter) {
        $name = $filter["name"];
        $label = isset($filter["label"]) ? $filter["label"] : "";
        $filter_options = $filter["options"];
        $current = isset($filter["current"]) ? $filter["current"] : "";

        echo '<select name="' . h($name) . '">';
        foreach ($filter_options as $value => $text) {
            $selected = ($current === (string)$value) ? ' selected' : '';
            echo '<option value="' . h($value) . '"' . $selected . '>' . h($text) . '</option>';
        }
        echo '</select>';
    }

    echo '<button type="submit" class="btn">Search</button>';

    // Clear button if search or filters are active
    $has_active = !empty($search);
    foreach ($filters as $filter) {
        if (!empty($filter["current"])) {
            $has_active = true;
            break;
        }
    }
    if ($has_active) {
        echo '<a href="?action=' . h($action) . '" class="btn" style="background: #6c757d;">Clear</a>';
    }

    echo '</form>';
}

/**
 * Seed mock data for testing (only if tables are empty)
 */
function sqlite_seed_mock_data()
{
    if (!MOCK_MODE) {
        return;
    }

    // Check if already seeded
    $customers = sqlite_query("SELECT COUNT(*) as cnt FROM customers");
    if ($customers[0]["cnt"] > 0) {
        return;
    }

    // Seed discount groups
    sqlite_execute(
        "INSERT INTO discount_groups (id, name) VALUES (1, 'Enterprise Partners')"
    );
    sqlite_execute(
        "INSERT INTO discount_groups (id, name) VALUES (2, 'Standard Tier')"
    );
    sqlite_execute(
        "INSERT INTO discount_groups (id, name) VALUES (3, 'Startup Program')"
    );

    // Seed services
    sqlite_execute(
        "INSERT INTO services (id, name) VALUES (1, 'Identity Verification')"
    );
    sqlite_execute(
        "INSERT INTO services (id, name) VALUES (2, 'Address Validation')"
    );
    sqlite_execute(
        "INSERT INTO services (id, name) VALUES (3, 'Phone Lookup')"
    );
    sqlite_execute(
        "INSERT INTO services (id, name) VALUES (4, 'Email Verification')"
    );
    sqlite_execute(
        "INSERT INTO services (id, name) VALUES (5, 'Background Check')"
    );

    // Seed customers
    $customers_data = [
        [1, "Acme Corp", 1, "active", "2024-01-01"],
        [2, "Globex Inc", 1, "active", "2024-03-15"],
        [3, "Initech", 2, "active", "2023-06-01"],
        [4, "Umbrella Corp", 2, "paused", "2023-09-01"],
        [5, "Stark Industries", 1, "active", "2024-06-01"],
        [6, "Wayne Enterprises", null, "active", "2022-01-01"],
        [7, "Oscorp", 3, "active", "2025-01-01"],
        [8, "LexCorp", 2, "decommissioned", "2021-01-01"],
        [9, "Cyberdyne", 1, "active", "2024-09-01"],
        [10, "Tyrell Corp", null, "active", "2023-01-01"],
    ];

    foreach ($customers_data as $c) {
        sqlite_execute(
            "INSERT INTO customers (id, name, discount_group_id, status, contract_start_date) VALUES (?, ?, ?, ?, ?)",
            $c
        );
    }

    // Seed system default pricing tiers (level = 'default', level_id = NULL)
    $default_tiers = [
        // Service 1: Identity Verification
        ["default", null, 1, 0, 1000, 0.5],
        ["default", null, 1, 1001, 5000, 0.4],
        ["default", null, 1, 5001, null, 0.3],
        // Service 2: Address Validation
        ["default", null, 2, 0, 1000, 0.25],
        ["default", null, 2, 1001, 5000, 0.2],
        ["default", null, 2, 5001, null, 0.15],
        // Service 3: Phone Lookup
        ["default", null, 3, 0, 500, 0.75],
        ["default", null, 3, 501, 2000, 0.6],
        ["default", null, 3, 2001, null, 0.45],
        // Service 4: Email Verification
        ["default", null, 4, 0, 2000, 0.1],
        ["default", null, 4, 2001, 10000, 0.08],
        ["default", null, 4, 10001, null, 0.05],
        // Service 5: Background Check
        ["default", null, 5, 0, 100, 5.0],
        ["default", null, 5, 101, 500, 4.5],
        ["default", null, 5, 501, null, 4.0],
    ];

    foreach ($default_tiers as $t) {
        sqlite_execute(
            "INSERT INTO pricing_tiers (level, level_id, service_id, volume_start, volume_end, price_per_inquiry, effective_date)
             VALUES (?, ?, ?, ?, ?, ?, '2024-01-01')",
            $t
        );
    }

    // Seed group-level overrides (Enterprise Partners gets discount)
    $group_tiers = [
        // Enterprise Partners (group 1) - 20% off Identity Verification
        ["group", 1, 1, 0, 1000, 0.4],
        ["group", 1, 1, 1001, 5000, 0.32],
        ["group", 1, 1, 5001, null, 0.24],
    ];

    foreach ($group_tiers as $t) {
        sqlite_execute(
            "INSERT INTO pricing_tiers (level, level_id, service_id, volume_start, volume_end, price_per_inquiry, effective_date)
             VALUES (?, ?, ?, ?, ?, ?, '2024-01-01')",
            $t
        );
    }

    // Seed customer-level override (Wayne Enterprises has custom deal)
    $customer_tiers = [
        // Wayne Enterprises (customer 6) - special Background Check pricing
        ["customer", 6, 5, 0, 100, 4.0],
        ["customer", 6, 5, 101, 500, 3.5],
        ["customer", 6, 5, 501, null, 3.0],
    ];

    foreach ($customer_tiers as $t) {
        sqlite_execute(
            "INSERT INTO pricing_tiers (level, level_id, service_id, volume_start, volume_end, price_per_inquiry, effective_date)
             VALUES (?, ?, ?, ?, ?, ?, '2024-01-01')",
            $t
        );
    }

    // Seed customer settings
    sqlite_execute(
        "INSERT INTO customer_settings (customer_id, monthly_minimum, uses_annualized, look_period_months, effective_date)
         VALUES (1, 500.00, 0, NULL, '2024-01-01')"
    );
    sqlite_execute(
        "INSERT INTO customer_settings (customer_id, monthly_minimum, uses_annualized, annualized_start_date, look_period_months, effective_date)
         VALUES (6, 1000.00, 1, '2022-01-01', 6, '2022-01-01')"
    );

    // Seed escalators
    sqlite_execute(
        "INSERT INTO customer_escalators (customer_id, escalator_start_date, year_number, escalator_percentage, fixed_adjustment, effective_date)
         VALUES (1, '2024-01-01', 1, 0, 0, '2024-01-01')"
    );
    sqlite_execute(
        "INSERT INTO customer_escalators (customer_id, escalator_start_date, year_number, escalator_percentage, fixed_adjustment, effective_date)
         VALUES (1, '2024-01-01', 2, 5.0, 0, '2024-01-01')"
    );
    sqlite_execute(
        "INSERT INTO customer_escalators (customer_id, escalator_start_date, year_number, escalator_percentage, fixed_adjustment, effective_date)
         VALUES (1, '2024-01-01', 3, 10.0, 0, '2024-01-01')"
    );

    // Seed business rules
    sqlite_execute(
        "INSERT INTO business_rules (customer_id, rule_name, rule_description) VALUES (1, 'RULE_SKIP_EMPTY', 'Skip empty records')"
    );
    sqlite_execute(
        "INSERT INTO business_rules (customer_id, rule_name, rule_description) VALUES (1, 'RULE_VALIDATE_SSN', 'Validate SSN format')"
    );
    sqlite_execute(
        "INSERT INTO business_rules (customer_id, rule_name, rule_description) VALUES (1, 'RULE_CHECK_DUPLICATES', 'Check for duplicates')"
    );

    // Mask one rule
    sqlite_execute(
        "INSERT INTO business_rule_masks (customer_id, rule_name, is_masked, effective_date)
         VALUES (1, 'RULE_SKIP_EMPTY', 1, '2024-06-01')"
    );
}

// ------------------------------------------------------------
// PATH HELPER FUNCTIONS
// ------------------------------------------------------------

/**
 * Get the shared base path
 * Returns mock path in MOCK_MODE, production path otherwise
 *
 * @return string
 */
function get_shared_path()
{
    if (MOCK_MODE) {
        return dirname(__FILE__) . "/test_shared";
    }
    return SHARED_BASE_PATH;
}

/**
 * Get path for generated reports (cron output)
 *
 * @return string
 */
function get_generated_path()
{
    return get_shared_path() . "/generated";
}

/**
 * Get path for pending configs (dead-drop)
 *
 * @return string
 */
function get_pending_path()
{
    return get_shared_path() . "/pending";
}

/**
 * Get path for archived configs (historical)
 *
 * @return string
 */
function get_archive_path()
{
    return get_shared_path() . "/archive";
}

/**
 * Ensure all required directories exist
 *
 * @return array Errors if any directories couldn't be created
 */
function ensure_directories()
{
    $errors = [];
    $paths = [get_generated_path(), get_pending_path(), get_archive_path()];

    foreach ($paths as $path) {
        if (!is_dir($path)) {
            if (!@mkdir($path, 0755, true)) {
                $errors[] = "Could not create directory: $path";
            }
        }
    }

    return $errors;
}

// ------------------------------------------------------------
// UTILITY FUNCTIONS
// ------------------------------------------------------------

/**
 * Safe string for filenames
 *
 * @param string $str
 * @return string
 */
function safe_filename($str)
{
    return preg_replace("/[^a-zA-Z0-9_\-\.]/", "_", $str);
}

/**
 * Generate timestamped filename
 *
 * @param string $prefix
 * @param string $extension
 * @return string
 */
function generate_filename($prefix, $extension = "csv")
{
    return $prefix . date("Y-m-d_His") . "." . $extension;
}

/**
 * Get human-readable file size
 *
 * @param int $bytes
 * @return string
 */
function format_filesize($bytes)
{
    $units = ["B", "KB", "MB", "GB"];
    $i = 0;
    while ($bytes >= 1024 && $i < count($units) - 1) {
        $bytes /= 1024;
        $i++;
    }
    return round($bytes, 2) . " " . $units[$i];
}

/**
 * Sanitize output for HTML
 *
 * @param string $str
 * @return string
 */
function h($str)
{
    return htmlspecialchars($str, ENT_QUOTES, "UTF-8");
}

/**
 * Format percentage
 *
 * @param float $float
 * @return string
 */
function format_percentage($float)
{
    return number_format($float, 1) . "%";
}

// ============================================================
// END PHASE 1
// ============================================================

// ============================================================
// PHASE 2: CORE LOGIC
// CSV Handling, File Management, DB Operations
// ============================================================

// ------------------------------------------------------------
// CSV FUNCTIONS
// ------------------------------------------------------------

/**
 * Parse a CSV file into array of associative arrays
 * First row is treated as headers
 *
 * @param string $filepath
 * @return array|false Array of rows, or false on failure
 */
function csv_read($filepath)
{
    if (!file_exists($filepath) || !is_readable($filepath)) {
        return false;
    }

    $handle = fopen($filepath, "r");
    if ($handle === false) {
        return false;
    }

    $headers = fgetcsv($handle);
    if ($headers === false) {
        fclose($handle);
        return false;
    }

    // Clean headers (trim whitespace, handle BOM)
    $headers = array_map(function ($h) {
        $h = trim($h);
        // Remove UTF-8 BOM if present
        $h = preg_replace("/^\xEF\xBB\xBF/", "", $h);
        return $h;
    }, $headers);

    $rows = [];
    while (($data = fgetcsv($handle)) !== false) {
        // Skip empty rows
        if (count($data) === 1 && empty($data[0])) {
            continue;
        }

        // Pad or trim data to match headers
        $data = array_pad($data, count($headers), "");
        $data = array_slice($data, 0, count($headers));

        $rows[] = array_combine($headers, $data);
    }

    fclose($handle);
    return $rows;
}

/**
 * Write array of associative arrays to CSV
 *
 * @param string $filepath
 * @param array  $rows      Array of associative arrays
 * @param array  $headers   Optional headers (auto-detect from first row if not provided)
 * @return bool
 */
function csv_write($filepath, $rows, $headers = null)
{
    if (empty($rows) && empty($headers)) {
        return false;
    }

    $handle = fopen($filepath, "w");
    if ($handle === false) {
        return false;
    }

    // Determine headers
    if ($headers === null && !empty($rows)) {
        $headers = array_keys($rows[0]);
    }

    // Write headers
    fputcsv($handle, $headers);

    // Write rows
    foreach ($rows as $row) {
        $line = [];
        foreach ($headers as $header) {
            $line[] = isset($row[$header]) ? $row[$header] : "";
        }
        fputcsv($handle, $line);
    }

    fclose($handle);
    return true;
}

/**
 * Get CSV headers only (for preview/validation)
 *
 * @param string $filepath
 * @return array|false
 */
function csv_get_headers($filepath)
{
    if (!file_exists($filepath) || !is_readable($filepath)) {
        return false;
    }

    $handle = fopen($filepath, "r");
    if ($handle === false) {
        return false;
    }

    $headers = fgetcsv($handle);
    fclose($handle);

    if ($headers === false) {
        return false;
    }

    // Clean headers
    return array_map(function ($h) {
        $h = trim($h);
        $h = preg_replace("/^\xEF\xBB\xBF/", "", $h);
        return $h;
    }, $headers);
}

/**
 * Count rows in CSV (excluding header)
 *
 * @param string $filepath
 * @return int|false
 */
function csv_count_rows($filepath)
{
    if (!file_exists($filepath) || !is_readable($filepath)) {
        return false;
    }

    $count = 0;
    $handle = fopen($filepath, "r");
    if ($handle === false) {
        return false;
    }

    // Skip header
    fgetcsv($handle);

    while (($data = fgetcsv($handle)) !== false) {
        if (!(count($data) === 1 && empty($data[0]))) {
            $count++;
        }
    }

    fclose($handle);
    return $count;
}

// ------------------------------------------------------------
// FILE LISTING FUNCTIONS
// ------------------------------------------------------------

/**
 * List files in a directory matching a pattern
 *
 * @param string $directory
 * @param string $pattern    Glob pattern (e.g., '*.csv')
 * @param string $sort       'name', 'date', 'size'
 * @param string $order      'asc', 'desc'
 * @return array             Array of file info arrays
 */
function list_files(
    $directory,
    $pattern = "*.csv",
    $sort = "date",
    $order = "desc"
) {
    $files = [];

    if (!is_dir($directory)) {
        return $files;
    }

    $glob_pattern = rtrim($directory, "/") . "/" . $pattern;
    $matches = glob($glob_pattern);

    if ($matches === false) {
        return $files;
    }

    foreach ($matches as $filepath) {
        if (is_file($filepath)) {
            $files[] = [
                "path" => $filepath,
                "name" => basename($filepath),
                "size" => filesize($filepath),
                "modified" => filemtime($filepath),
                "readable" => is_readable($filepath),
            ];
        }
    }

    // Sort
    usort($files, function ($a, $b) use ($sort, $order) {
        switch ($sort) {
            case "name":
                $cmp = strcasecmp($a["name"], $b["name"]);
                break;
            case "size":
                $cmp = $a["size"] - $b["size"];
                break;
            case "date":
            default:
                $cmp = $a["modified"] - $b["modified"];
                break;
        }
        return $order === "desc" ? -$cmp : $cmp;
    });

    return $files;
}

/**
 * List report files (from generated directory)
 *
 * @return array
 */
function list_reports()
{
    return list_files(
        get_generated_path(),
        REPORT_PREFIX . "*.csv",
        "date",
        "desc"
    );
}

/**
 * List archived config files
 *
 * @return array
 */
function list_archived_configs()
{
    return list_files(
        get_archive_path(),
        CONFIG_PREFIX . "*.csv",
        "date",
        "desc"
    );
}

/**
 * List pending config files (not yet processed)
 *
 * @return array
 */
function list_pending_configs()
{
    return list_files(
        get_pending_path(),
        CONFIG_PREFIX . "*.csv",
        "date",
        "desc"
    );
}

// ------------------------------------------------------------
// FILE OPERATIONS
// ------------------------------------------------------------

/**
 * Handle config CSV upload
 * Validates, moves to pending, and archives
 *
 * @param array  $uploaded_file  $_FILES array element
 * @param string $description    Optional description for archive
 * @return array                 ['success' => bool, 'message' => string, 'filename' => string]
 */
function handle_config_upload($uploaded_file, $description = "")
{
    $result = [
        "success" => false,
        "message" => "",
        "filename" => "",
    ];

    // Check for upload errors
    if ($uploaded_file["error"] !== UPLOAD_ERR_OK) {
        $errors = [
            UPLOAD_ERR_INI_SIZE => "File exceeds upload_max_filesize",
            UPLOAD_ERR_FORM_SIZE => "File exceeds MAX_FILE_SIZE",
            UPLOAD_ERR_PARTIAL => "File was only partially uploaded",
            UPLOAD_ERR_NO_FILE => "No file was uploaded",
            UPLOAD_ERR_NO_TMP_DIR => "Missing temporary folder",
            UPLOAD_ERR_CANT_WRITE => "Failed to write file to disk",
            UPLOAD_ERR_EXTENSION => "Upload stopped by extension",
        ];
        $result["message"] = isset($errors[$uploaded_file["error"]])
            ? $errors[$uploaded_file["error"]]
            : "Unknown upload error";
        return $result;
    }

    // Validate file type
    $ext = strtolower(pathinfo($uploaded_file["name"], PATHINFO_EXTENSION));
    if ($ext !== "csv") {
        $result["message"] = "Only CSV files are allowed";
        return $result;
    }

    // Validate CSV structure (must have headers and at least some data)
    $headers = csv_get_headers($uploaded_file["tmp_name"]);
    if ($headers === false || empty($headers)) {
        $result["message"] = "Invalid CSV file: could not read headers";
        return $result;
    }

    // Generate filename
    $filename = generate_filename(CONFIG_PREFIX, "csv");

    // Ensure directories exist
    $dir_errors = ensure_directories();
    if (!empty($dir_errors)) {
        $result["message"] = implode("; ", $dir_errors);
        return $result;
    }

    // Copy to pending (dead-drop)
    $pending_path = get_pending_path() . "/" . $filename;
    if (!move_uploaded_file($uploaded_file["tmp_name"], $pending_path)) {
        $result["message"] =
            "Failed to move uploaded file to pending directory";
        return $result;
    }

    // Copy to archive
    $archive_path = get_archive_path() . "/" . $filename;
    if (!copy($pending_path, $archive_path)) {
        // Non-fatal, but log it
        error_log("Warning: Could not archive config file to $archive_path");
    }

    $result["success"] = true;
    $result["message"] = "Config file uploaded successfully";
    $result["filename"] = $filename;

    return $result;
}

/**
 * Download a file (outputs directly)
 *
 * @param string $filepath
 * @param string $download_name  Optional custom download filename
 * @return bool                  False if file not found/readable
 */
function download_file($filepath, $download_name = null)
{
    if (!file_exists($filepath) || !is_readable($filepath)) {
        return false;
    }

    if ($download_name === null) {
        $download_name = basename($filepath);
    }

    $mime = "text/csv";
    $ext = strtolower(pathinfo($filepath, PATHINFO_EXTENSION));
    if ($ext === "xlsx") {
        $mime =
            "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet";
    }

    header("Content-Type: " . $mime);
    header(
        "Content-Disposition: attachment; filename=\"" . $download_name . "\""
    );
    header("Content-Length: " . filesize($filepath));
    header("Cache-Control: no-cache, must-revalidate");
    header("Pragma: no-cache");

    readfile($filepath);
    return true;
}

/**
 * Validate a file path is within allowed directories
 * Prevents directory traversal attacks
 *
 * @param string $filepath
 * @return bool
 */
function is_valid_filepath($filepath)
{
    $real_path = realpath($filepath);
    if ($real_path === false) {
        return false;
    }

    $allowed_dirs = [
        realpath(get_generated_path()),
        realpath(get_pending_path()),
        realpath(get_archive_path()),
    ];

    foreach ($allowed_dirs as $dir) {
        if ($dir !== false && strpos($real_path, $dir) === 0) {
            return true;
        }
    }

    return false;
}

// ============================================================
// END PHASE 2
// ============================================================

// ============================================================
// PHASE 3: ROUTER
// Action dispatch and request handling
// ============================================================

// ------------------------------------------------------------
// REQUEST HANDLING
// ------------------------------------------------------------

/**
 * Get current action from request
 *
 * @return string
 */
function get_action()
{
    return isset($_GET["action"]) ? $_GET["action"] : "dashboard";
}

/**
 * Get request parameter (GET or POST)
 *
 * @param string $key
 * @param mixed  $default
 * @return mixed
 */
function get_param($key, $default = null)
{
    if (isset($_POST[$key])) {
        return $_POST[$key];
    }
    if (isset($_GET[$key])) {
        return $_GET[$key];
    }
    return $default;
}

/**
 * Redirect to an action
 *
 * @param string $action
 * @param array  $params
 */
function redirect($action, $params = [])
{
    $params["action"] = $action;
    $url = "?" . http_build_query($params);
    header("Location: " . $url);
    exit();
}

/**
 * Set a flash message (stored in session)
 *
 * @param string $type    'success', 'error', 'info'
 * @param string $message
 */
function set_flash($type, $message)
{
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }
    $_SESSION["flash"] = ["type" => $type, "message" => $message];
}

/**
 * Get and clear flash message
 *
 * @return array|null
 */
function get_flash()
{
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }
    if (isset($_SESSION["flash"])) {
        $flash = $_SESSION["flash"];
        unset($_SESSION["flash"]);
        return $flash;
    }
    return null;
}

// ------------------------------------------------------------
// ACTION HANDLERS
// ------------------------------------------------------------

/**
 * Dashboard action - overview of system status
 */
function action_dashboard()
{
    // Get counts for dashboard
    $services = sqlite_query("SELECT COUNT(*) as cnt FROM services");
    $groups = sqlite_query("SELECT COUNT(*) as cnt FROM discount_groups");
    $customers_active = sqlite_query(
        "SELECT COUNT(*) as cnt FROM customers WHERE status = 'active'"
    );
    $customers_all = sqlite_query("SELECT COUNT(*) as cnt FROM customers");

    // Get alerts
    $alerts = get_dashboard_alerts();

    $data = [
        "service_count" => $services[0]["cnt"],
        "group_count" => $groups[0]["cnt"],
        "customer_active" => $customers_active[0]["cnt"],
        "customer_total" => $customers_all[0]["cnt"],
        "reports" => list_reports(),
        "pending_configs" => list_pending_configs(),
        "alerts" => $alerts,
    ];
    render_dashboard($data);
}

/**
 * Get dashboard alerts (upcoming events, warnings)
 */
function get_dashboard_alerts()
{
    $alerts = [];

    // 1. Upcoming escalator anniversaries (within 30 days)
    $upcoming_escalators = get_upcoming_escalators(30);
    foreach ($upcoming_escalators as $esc) {
        $alerts[] = [
            "type" => "warning",
            "icon" => "calendar",
            "message" =>
                "Escalator Year " .
                $esc["year_number"] .
                " for <strong>" .
                h($esc["customer_name"]) .
                "</strong> activates on " .
                $esc["effective_date"],
            "link" =>
                "?action=escalator_edit&customer_id=" . $esc["customer_id"],
        ];
    }

    // 2. Customers with masked business rules
    $masked_rules = get_customers_with_masked_rules();
    foreach ($masked_rules as $mr) {
        $alerts[] = [
            "type" => "info",
            "icon" => "mask",
            "message" =>
                "<strong>" .
                h($mr["customer_name"]) .
                "</strong> has " .
                $mr["masked_count"] .
                " masked business rule(s)",
            "link" =>
                "?action=business_rule_edit&customer_id=" . $mr["customer_id"],
        ];
    }

    // 3. Paused customers reminder
    $paused = sqlite_query(
        "SELECT id, name FROM customers WHERE status = 'paused'"
    );
    foreach ($paused as $p) {
        $alerts[] = [
            "type" => "warning",
            "icon" => "pause",
            "message" =>
                "<strong>" . h($p["name"]) . "</strong> is currently paused",
            "link" => "?action=pricing_customer_edit&customer_id=" . $p["id"],
        ];
    }

    // 4. Annualized tier resets coming up (within 30 days)
    $upcoming_resets = get_upcoming_annualized_resets(30);
    foreach ($upcoming_resets as $reset) {
        $alerts[] = [
            "type" => "info",
            "icon" => "refresh",
            "message" =>
                "Annualized tier reset for <strong>" .
                h($reset["customer_name"]) .
                "</strong> on " .
                $reset["reset_date"],
            "link" =>
                "?action=pricing_customer_edit&customer_id=" .
                $reset["customer_id"] .
                "&tab=settings",
        ];
    }

    return $alerts;
}

/**
 * Get escalators coming up in the next N days
 */
function get_upcoming_escalators($days = 30)
{
    $results = [];

    // Get all customers with escalators
    $customers = sqlite_query(
        "SELECT DISTINCT c.id, c.name FROM customers c
         INNER JOIN customer_escalators ce ON c.id = ce.customer_id
         WHERE c.status = 'active'"
    );

    $today = date("Y-m-d");
    $future = date("Y-m-d", strtotime("+$days days"));

    foreach ($customers as $customer) {
        $escalators = get_current_escalators($customer["id"]);
        if (empty($escalators)) {
            continue;
        }

        $start_date = $escalators[0]["escalator_start_date"];
        if (!$start_date) {
            continue;
        }

        // Check each year's anniversary
        foreach ($escalators as $esc) {
            $year = $esc["year_number"];
            $delay_months = get_total_delay_months($customer["id"], $year);

            // Calculate when this escalator takes effect
            $anniversary = date(
                "Y-m-d",
                strtotime(
                    $start_date .
                        " + " .
                        ($year - 1) .
                        " years + $delay_months months"
                )
            );

            // Check if it's within the window
            if ($anniversary >= $today && $anniversary <= $future) {
                $results[] = [
                    "customer_id" => $customer["id"],
                    "customer_name" => $customer["name"],
                    "year_number" => $year,
                    "effective_date" => $anniversary,
                    "percentage" => $esc["escalator_percentage"],
                ];
            }
        }
    }

    // Sort by date
    usort($results, function ($a, $b) {
        return strcmp($a["effective_date"], $b["effective_date"]);
    });

    return array_slice($results, 0, 5); // Limit to 5
}

/**
 * Get customers with masked business rules
 */
function get_customers_with_masked_rules()
{
    $results = [];

    $customers = sqlite_query(
        "SELECT DISTINCT c.id, c.name FROM customers c
         INNER JOIN business_rules br ON c.id = br.customer_id
         WHERE c.status = 'active'"
    );

    foreach ($customers as $customer) {
        $rules = get_customer_rules($customer["id"]);
        $masked_count = 0;

        foreach ($rules as $rule) {
            if (get_rule_mask_status($customer["id"], $rule["rule_name"])) {
                $masked_count++;
            }
        }

        if ($masked_count > 0) {
            $results[] = [
                "customer_id" => $customer["id"],
                "customer_name" => $customer["name"],
                "masked_count" => $masked_count,
            ];
        }
    }

    return $results;
}

/**
 * Get annualized tier resets coming up
 */
function get_upcoming_annualized_resets($days = 30)
{
    $results = [];

    $settings = sqlite_query(
        "SELECT cs.*, c.name as customer_name
         FROM customer_settings cs
         INNER JOIN customers c ON cs.customer_id = c.id
         WHERE cs.uses_annualized = 1
         AND cs.annualized_start_date IS NOT NULL
         AND c.status = 'active'
         AND cs.effective_date = (
             SELECT MAX(cs2.effective_date) FROM customer_settings cs2
             WHERE cs2.customer_id = cs.customer_id AND cs2.effective_date <= date('now')
         )"
    );

    $today = date("Y-m-d");
    $future = date("Y-m-d", strtotime("+$days days"));
    $current_year = date("Y");

    foreach ($settings as $setting) {
        if (!$setting["annualized_start_date"]) {
            continue;
        }

        // Calculate next reset date (same month/day as start, in current or next year)
        $start = $setting["annualized_start_date"];
        $start_md = substr($start, 5); // MM-DD

        $reset_this_year = $current_year . "-" . $start_md;
        $reset_next_year = $current_year + 1 . "-" . $start_md;

        $reset_date =
            $reset_this_year >= $today ? $reset_this_year : $reset_next_year;

        if ($reset_date >= $today && $reset_date <= $future) {
            $results[] = [
                "customer_id" => $setting["customer_id"],
                "customer_name" => $setting["customer_name"],
                "reset_date" => $reset_date,
            ];
        }
    }

    return $results;
}

// ============================================================
// BILLING CALENDAR FUNCTIONS
// ============================================================

/**
 * Get events for a specific month (escalators, resets, etc.)
 */
function get_month_events($year, $month)
{
    $events = [
        "escalators" => [],
        "resets" => [],
        "new_customers" => [],
        "paused_customers" => [],
        "warnings" => [],
    ];

    $month_start = sprintf("%04d-%02d-01", $year, $month);
    $month_end = date("Y-m-t", strtotime($month_start));

    // Get escalators for this month
    $customers = sqlite_query(
        "SELECT DISTINCT c.id, c.name, c.contract_start_date FROM customers c
         INNER JOIN customer_escalators ce ON c.id = ce.customer_id
         WHERE c.status = 'active'"
    );

    foreach ($customers as $customer) {
        $escalators = get_current_escalators($customer["id"]);
        if (empty($escalators)) {
            continue;
        }

        $start_date = $escalators[0]["escalator_start_date"];
        if (!$start_date) {
            continue;
        }

        foreach ($escalators as $esc) {
            $esc_year = $esc["year_number"];
            if ($esc_year <= 1) {
                continue;
            } // Year 1 is baseline, no escalation event

            $delay_months = get_total_delay_months($customer["id"], $esc_year);
            $anniversary = date(
                "Y-m-d",
                strtotime(
                    $start_date .
                        " + " .
                        ($esc_year - 1) .
                        " years + $delay_months months"
                )
            );

            // Check if this anniversary falls in our month
            if ($anniversary >= $month_start && $anniversary <= $month_end) {
                $events["escalators"][] = [
                    "customer_id" => $customer["id"],
                    "customer_name" => $customer["name"],
                    "year_number" => $esc_year,
                    "effective_date" => $anniversary,
                    "percentage" => $esc["escalator_percentage"],
                    "fixed_adjustment" => $esc["fixed_adjustment"],
                    "has_delay" => $delay_months > 0,
                    "delay_months" => $delay_months,
                ];
            }
        }
    }

    // Get annualized resets for this month
    $settings = sqlite_query(
        "SELECT cs.*, c.name as customer_name
         FROM customer_settings cs
         INNER JOIN customers c ON cs.customer_id = c.id
         WHERE cs.uses_annualized = 1
         AND cs.annualized_start_date IS NOT NULL
         AND c.status = 'active'
         AND cs.effective_date = (
             SELECT MAX(cs2.effective_date) FROM customer_settings cs2
             WHERE cs2.customer_id = cs.customer_id AND cs2.effective_date <= date('now')
         )"
    );

    foreach ($settings as $setting) {
        if (!$setting["annualized_start_date"]) {
            continue;
        }

        $start_md = substr($setting["annualized_start_date"], 5); // MM-DD
        $reset_date = sprintf("%04d-%s", $year, $start_md);

        if ($reset_date >= $month_start && $reset_date <= $month_end) {
            $events["resets"][] = [
                "customer_id" => $setting["customer_id"],
                "customer_name" => $setting["customer_name"],
                "reset_date" => $reset_date,
            ];
        }
    }

    // Get paused customers
    $paused = sqlite_query(
        "SELECT id, name FROM customers WHERE status = 'paused'"
    );
    $events["paused_customers"] = $paused;

    // Check for warnings
    // - Customers without LMS
    $no_lms = sqlite_query(
        "SELECT id, name FROM customers WHERE status = 'active' AND (lms_id IS NULL OR lms_id = 0)"
    );
    foreach ($no_lms as $c) {
        $events["warnings"][] = [
            "type" => "no_lms",
            "message" => $c["name"] . " has no LMS assigned",
            "customer_id" => $c["id"],
            "customer_name" => $c["name"],
        ];
    }

    return $events;
}

/**
 * Check if a month is "complete" (monthly report ingested)
 */
function is_month_complete($year, $month)
{
    $result = sqlite_query(
        "SELECT COUNT(*) as cnt FROM billing_reports
         WHERE report_type = 'monthly' AND report_year = ? AND report_month = ?",
        [$year, $month]
    );
    return $result[0]["cnt"] > 0;
}

/**
 * Get calendar summary for a full year
 */
function get_calendar_year_summary($year)
{
    $months = [];

    for ($m = 1; $m <= 12; $m++) {
        $events = get_month_events($year, $m);

        $event_count = count($events["escalators"]) + count($events["resets"]);
        $warning_count =
            count($events["warnings"]) + count($events["paused_customers"]);
        $has_escalators = count($events["escalators"]) > 0;

        $months[$m] = [
            "year" => $year,
            "month" => $m,
            "month_name" => date("M", mktime(0, 0, 0, $m, 1)),
            "event_count" => $event_count,
            "warning_count" => $warning_count,
            "has_escalators" => $has_escalators,
            "is_complete" => is_month_complete($year, $m),
            "is_current" => $year == date("Y") && $m == date("n"),
            "is_past" =>
                $year < date("Y") || ($year == date("Y") && $m < date("n")),
        ];
    }

    return $months;
}

/**
 * Get the next incomplete month for "What's Next?" button
 */
function get_next_incomplete_month()
{
    $year = date("Y");
    $month = date("n");

    // Check current month first
    if (!is_month_complete($year, $month)) {
        return ["year" => $year, "month" => $month];
    }

    // Check future months this year
    for ($m = $month + 1; $m <= 12; $m++) {
        if (!is_month_complete($year, $m)) {
            return ["year" => $year, "month" => $m];
        }
    }

    // Check next year
    for ($m = 1; $m <= 12; $m++) {
        if (!is_month_complete($year + 1, $m)) {
            return ["year" => $year + 1, "month" => $m];
        }
    }

    return ["year" => $year, "month" => $month];
}

/**
 * Get new customers since a reference date
 */
function get_new_customers_since($since_date)
{
    return sqlite_query(
        "SELECT c.*, dg.name as group_name
         FROM customers c
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         WHERE c.created_at >= ?
         ORDER BY c.created_at DESC",
        [$since_date]
    );
}

/**
 * Get configuration changes since a reference date
 */
function get_config_changes_since($since_date)
{
    $changes = [];

    // Pricing changes (customer-level only)
    $pricing = sqlite_query(
        "SELECT 'pricing' as type, c.name as customer_name, pt.level_id as customer_id,
                pt.effective_date, s.name as service_name
         FROM pricing_tiers pt
         JOIN customers c ON pt.level_id = c.id
         JOIN services s ON pt.service_id = s.id
         WHERE pt.effective_date >= ? AND pt.level = 'customer'
         ORDER BY pt.effective_date DESC",
        [$since_date]
    );
    foreach ($pricing as $p) {
        $changes[] = [
            "type" => "pricing",
            "description" =>
                $p["customer_name"] .
                ": pricing changed for " .
                $p["service_name"],
            "customer_id" => $p["customer_id"],
            "date" => $p["effective_date"],
        ];
    }

    // Settings changes
    $settings = sqlite_query(
        "SELECT cs.*, c.name as customer_name
         FROM customer_settings cs
         JOIN customers c ON cs.customer_id = c.id
         WHERE cs.effective_date >= ?
         ORDER BY cs.effective_date DESC",
        [$since_date]
    );
    foreach ($settings as $s) {
        $changes[] = [
            "type" => "settings",
            "description" => $s["customer_name"] . ": settings updated",
            "customer_id" => $s["customer_id"],
            "date" => $s["effective_date"],
        ];
    }

    // Sort by date descending
    usort($changes, function ($a, $b) {
        return strcmp($b["date"], $a["date"]);
    });

    return $changes;
}

/**
 * Get month-to-date billing summary from daily reports
 */
function get_mtd_summary($year, $month)
{
    $result = sqlite_query(
        "SELECT
            COUNT(DISTINCT brl.customer_id) as customer_count,
            SUM(brl.count) as total_transactions,
            SUM(brl.revenue) as total_revenue,
            COUNT(DISTINCT br.id) as report_count,
            MAX(br.report_date) as latest_date
         FROM billing_report_lines brl
         JOIN billing_reports br ON brl.report_id = br.id
         WHERE br.report_type = 'daily'
         AND br.report_year = ?
         AND br.report_month = ?",
        [$year, $month]
    );

    return $result[0];
}

/**
 * Get daily breakdown of MTD billing data
 */
function get_mtd_daily_breakdown($year, $month)
{
    return sqlite_query(
        "SELECT
            br.report_date,
            SUM(brl.count) as transactions,
            SUM(brl.revenue) as revenue
         FROM billing_report_lines brl
         JOIN billing_reports br ON brl.report_id = br.id
         WHERE br.report_type = 'daily'
         AND br.report_year = ?
         AND br.report_month = ?
         GROUP BY br.report_date
         ORDER BY br.report_date",
        [$year, $month]
    );
}

/**
 * Get service breakdown of MTD billing data
 */
function get_mtd_service_breakdown($year, $month)
{
    return sqlite_query(
        "SELECT
            brl.efx_code,
            s.name as service_name,
            SUM(brl.count) as transactions,
            SUM(brl.revenue) as revenue
         FROM billing_report_lines brl
         JOIN billing_reports br ON brl.report_id = br.id
         LEFT JOIN transaction_types tt ON brl.efx_code = tt.efx_code
         LEFT JOIN services s ON tt.service_id = s.id
         WHERE br.report_type = 'daily'
         AND br.report_year = ?
         AND br.report_month = ?
         GROUP BY brl.efx_code, s.name
         ORDER BY revenue DESC",
        [$year, $month]
    );
}

/**
 * Get customer breakdown of MTD billing data
 */
function get_mtd_customer_breakdown($year, $month)
{
    return sqlite_query(
        "SELECT
            brl.customer_id,
            brl.customer_name,
            SUM(brl.count) as transactions,
            SUM(brl.revenue) as revenue
         FROM billing_report_lines brl
         JOIN billing_reports br ON brl.report_id = br.id
         WHERE br.report_type = 'daily'
         AND br.report_year = ?
         AND br.report_month = ?
         GROUP BY brl.customer_id, brl.customer_name
         ORDER BY revenue DESC",
        [$year, $month]
    );
}

/**
 * Get previous month's MTD summary (for same day range comparison)
 */
function get_previous_month_mtd($year, $month, $day)
{
    // Calculate previous month
    $prev_month = $month - 1;
    $prev_year = $year;
    if ($prev_month < 1) {
        $prev_month = 12;
        $prev_year = $year - 1;
    }

    // Get sum up to the same day in previous month
    $result = sqlite_query(
        "SELECT
            SUM(brl.count) as total_transactions,
            SUM(brl.revenue) as total_revenue
         FROM billing_report_lines brl
         JOIN billing_reports br ON brl.report_id = br.id
         WHERE br.report_type = 'daily'
         AND br.report_year = ?
         AND br.report_month = ?
         AND CAST(substr(br.report_date, 9, 2) AS INTEGER) <= ?",
        [$prev_year, $prev_month, $day]
    );

    return $result[0];
}

/**
 * List reports action
 */
function action_list_reports()
{
    $data = [
        "reports" => list_reports(),
    ];
    render_list_reports($data);
}

/**
 * View a specific report
 */
function action_view_report()
{
    $file = get_param("file");

    if (empty($file)) {
        set_flash("error", "No file specified");
        redirect("list_reports");
        return;
    }

    $filepath = get_generated_path() . "/" . basename($file);

    if (!is_valid_filepath($filepath)) {
        set_flash("error", "Invalid file path");
        redirect("list_reports");
        return;
    }

    $rows = csv_read($filepath);
    $headers = csv_get_headers($filepath);

    if ($rows === false) {
        set_flash("error", "Could not read file");
        redirect("list_reports");
        return;
    }

    $data = [
        "filename" => basename($file),
        "filepath" => $filepath,
        "headers" => $headers,
        "rows" => $rows,
        "count" => count($rows),
    ];
    render_view_report($data);
}

/**
 * Download a report file
 */
function action_download_report()
{
    $file = get_param("file");

    if (empty($file)) {
        set_flash("error", "No file specified");
        redirect("list_reports");
        return;
    }

    $filepath = get_generated_path() . "/" . basename($file);

    if (!is_valid_filepath($filepath)) {
        set_flash("error", "Invalid file path");
        redirect("list_reports");
        return;
    }

    if (!download_file($filepath)) {
        set_flash("error", "Could not download file");
        redirect("list_reports");
    }
    exit();
}

/**
 * Upload config form/handler
 */
function action_upload_config()
{
    $data = [
        "error" => null,
        "success" => null,
    ];

    // Handle POST (file upload)
    if (
        $_SERVER["REQUEST_METHOD"] === "POST" &&
        isset($_FILES["config_file"])
    ) {
        $result = handle_config_upload($_FILES["config_file"]);

        if ($result["success"]) {
            set_flash(
                "success",
                $result["message"] . " (" . $result["filename"] . ")"
            );
            redirect("list_pending");
            return;
        } else {
            $data["error"] = $result["message"];
        }
    }

    render_upload_config($data);
}

/**
 * List pending configs (in dead-drop, awaiting processing)
 */
function action_list_pending()
{
    $data = [
        "configs" => list_pending_configs(),
    ];
    render_list_pending($data);
}

/**
 * List archived configs (historical)
 */
function action_list_archive()
{
    $data = [
        "configs" => list_archived_configs(),
    ];
    render_list_archive($data);
}

/**
 * View a specific config (pending or archived)
 */
function action_view_config()
{
    $file = get_param("file");
    $source = get_param("source", "archive"); // 'pending' or 'archive'

    if (empty($file)) {
        set_flash("error", "No file specified");
        redirect("list_archive");
        return;
    }

    $base_path =
        $source === "pending" ? get_pending_path() : get_archive_path();
    $filepath = $base_path . "/" . basename($file);

    if (!is_valid_filepath($filepath)) {
        set_flash("error", "Invalid file path");
        redirect("list_archive");
        return;
    }

    $rows = csv_read($filepath);
    $headers = csv_get_headers($filepath);

    if ($rows === false) {
        set_flash("error", "Could not read file");
        redirect("list_archive");
        return;
    }

    $data = [
        "filename" => basename($file),
        "filepath" => $filepath,
        "headers" => $headers,
        "rows" => $rows,
        "count" => count($rows),
    ];
    render_view_config($data);
}

/**
 * Download a config file
 */
function action_download_config()
{
    $file = get_param("file");
    $source = get_param("source", "archive");

    if (empty($file)) {
        set_flash("error", "No file specified");
        redirect("list_archive");
        return;
    }

    $base_path =
        $source === "pending" ? get_pending_path() : get_archive_path();
    $filepath = $base_path . "/" . basename($file);

    if (!is_valid_filepath($filepath)) {
        set_flash("error", "Invalid file path");
        redirect("list_archive");
        return;
    }

    if (!download_file($filepath)) {
        set_flash("error", "Could not download file");
        redirect("list_archive");
    }
    exit();
}

// ------------------------------------------------------------
// CSV EXPORT ACTIONS
// ------------------------------------------------------------

/**
 * Export all pricing data to CSV
 */
function action_export_pricing()
{
    $rows = [];

    // Get all services
    $services = get_all_services();

    // System defaults
    foreach ($services as $service) {
        $tiers = get_current_default_tiers($service["id"]);
        foreach ($tiers as $tier) {
            $rows[] = [
                "level" => "default",
                "entity_id" => "",
                "entity_name" => "System Default",
                "service_id" => $service["id"],
                "service_name" => $service["name"],
                "volume_start" => $tier["volume_start"],
                "volume_end" =>
                    $tier["volume_end"] !== null ? $tier["volume_end"] : "",
                "price_per_inquiry" => $tier["price_per_inquiry"],
                "effective_date" => $tier["effective_date"],
            ];
        }
    }

    // Group overrides
    $groups = sqlite_query("SELECT * FROM discount_groups ORDER BY name");
    foreach ($groups as $group) {
        foreach ($services as $service) {
            $tiers = get_current_group_tiers($group["id"], $service["id"]);
            foreach ($tiers as $tier) {
                $rows[] = [
                    "level" => "group",
                    "entity_id" => $group["id"],
                    "entity_name" => $group["name"],
                    "service_id" => $service["id"],
                    "service_name" => $service["name"],
                    "volume_start" => $tier["volume_start"],
                    "volume_end" =>
                        $tier["volume_end"] !== null ? $tier["volume_end"] : "",
                    "price_per_inquiry" => $tier["price_per_inquiry"],
                    "effective_date" => $tier["effective_date"],
                ];
            }
        }
    }

    // Customer overrides
    $customers = sqlite_query("SELECT * FROM customers ORDER BY name");
    foreach ($customers as $customer) {
        foreach ($services as $service) {
            $tiers = get_current_customer_tiers(
                $customer["id"],
                $service["id"]
            );
            foreach ($tiers as $tier) {
                $rows[] = [
                    "level" => "customer",
                    "entity_id" => $customer["id"],
                    "entity_name" => $customer["name"],
                    "service_id" => $service["id"],
                    "service_name" => $service["name"],
                    "volume_start" => $tier["volume_start"],
                    "volume_end" =>
                        $tier["volume_end"] !== null ? $tier["volume_end"] : "",
                    "price_per_inquiry" => $tier["price_per_inquiry"],
                    "effective_date" => $tier["effective_date"],
                ];
            }
        }
    }

    // Output CSV
    $filename = "pricing_export_" . date("Y-m-d_His") . ".csv";
    header("Content-Type: text/csv");
    header("Content-Disposition: attachment; filename=\"" . $filename . "\"");
    header("Content-Length: " . strlen($result["csv_content"]));
    header("Cache-Control: no-cache, must-revalidate");

    $output = fopen("php://output", "w");
    $headers = [
        "level",
        "entity_id",
        "entity_name",
        "service_id",
        "service_name",
        "volume_start",
        "volume_end",
        "price_per_inquiry",
        "effective_date",
    ];
    fputcsv($output, $headers);

    foreach ($rows as $row) {
        fputcsv($output, $row);
    }

    fclose($output);
    exit();
}

/**
 * Export customer settings to CSV
 */
function action_export_settings()
{
    $rows = [];

    $customers = sqlite_query("SELECT * FROM customers ORDER BY name");
    foreach ($customers as $customer) {
        $settings = get_current_customer_settings($customer["id"]);
        $rows[] = [
            "customer_id" => $customer["id"],
            "customer_name" => $customer["name"],
            "status" => $customer["status"],
            "discount_group_id" => $customer["discount_group_id"],
            "contract_start_date" => $customer["contract_start_date"],
            "monthly_minimum" => $settings["monthly_minimum"],
            "uses_annualized" => $settings["uses_annualized"],
            "annualized_start_date" => $settings["annualized_start_date"],
            "look_period_months" => $settings["look_period_months"],
        ];
    }

    $filename = "customer_settings_" . date("Y-m-d_His") . ".csv";
    header("Content-Type: text/csv");
    header("Content-Disposition: attachment; filename=\"" . $filename . "\"");
    header("Content-Length: " . strlen($result["csv_content"]));
    header("Cache-Control: no-cache, must-revalidate");

    $output = fopen("php://output", "w");
    $headers = [
        "customer_id",
        "customer_name",
        "status",
        "discount_group_id",
        "contract_start_date",
        "monthly_minimum",
        "uses_annualized",
        "annualized_start_date",
        "look_period_months",
    ];
    fputcsv($output, $headers);

    foreach ($rows as $row) {
        fputcsv($output, $row);
    }

    fclose($output);
    exit();
}

/**
 * Export escalators to CSV
 */
function action_export_escalators()
{
    $rows = [];

    $customers = sqlite_query("SELECT * FROM customers ORDER BY name");
    foreach ($customers as $customer) {
        $escalators = get_current_escalators($customer["id"]);
        foreach ($escalators as $esc) {
            $total_delay = get_total_delay_months(
                $customer["id"],
                $esc["year_number"]
            );
            $rows[] = [
                "customer_id" => $customer["id"],
                "customer_name" => $customer["name"],
                "escalator_start_date" => $esc["escalator_start_date"],
                "year_number" => $esc["year_number"],
                "escalator_percentage" => $esc["escalator_percentage"],
                "fixed_adjustment" => $esc["fixed_adjustment"],
                "total_delay_months" => $total_delay,
                "effective_date" => $esc["effective_date"],
            ];
        }
    }

    $filename = "escalators_" . date("Y-m-d_His") . ".csv";
    header("Content-Type: text/csv");
    header("Content-Disposition: attachment; filename=\"" . $filename . "\"");
    header("Content-Length: " . strlen($result["csv_content"]));
    header("Cache-Control: no-cache, must-revalidate");

    $output = fopen("php://output", "w");
    $headers = [
        "customer_id",
        "customer_name",
        "escalator_start_date",
        "year_number",
        "escalator_percentage",
        "fixed_adjustment",
        "total_delay_months",
        "effective_date",
    ];
    fputcsv($output, $headers);

    foreach ($rows as $row) {
        fputcsv($output, $row);
    }

    fclose($output);
    exit();
}

/**
 * Show export options page
 */
function action_export()
{
    render_export();
}

// ------------------------------------------------------------
// PRICING: HELPER FUNCTIONS
// ------------------------------------------------------------

/**
 * Get all services
 */
function get_all_services()
{
    return sqlite_query("SELECT * FROM services ORDER BY name");
}

/**
 * Get system default tiers for a service
 */
function get_default_tiers($service_id)
{
    return sqlite_query(
        "SELECT * FROM pricing_tiers
         WHERE level = 'default' AND level_id IS NULL AND service_id = ?
         AND effective_date <= date('now')
         ORDER BY effective_date DESC, volume_start ASC",
        [$service_id]
    );
}

/**
 * Get current default tiers (latest effective) for a service
 */
function get_current_default_tiers($service_id)
{
    // Get the latest effective_date for this service's defaults
    $latest = sqlite_query(
        "SELECT MAX(effective_date) as max_date FROM pricing_tiers
         WHERE level = 'default' AND level_id IS NULL AND service_id = ?
         AND effective_date <= date('now')",
        [$service_id]
    );

    if (empty($latest) || !$latest[0]["max_date"]) {
        return [];
    }

    return sqlite_query(
        "SELECT * FROM pricing_tiers
         WHERE level = 'default' AND level_id IS NULL AND service_id = ?
         AND effective_date = ?
         ORDER BY volume_start ASC",
        [$service_id, $latest[0]["max_date"]]
    );
}

/**
 * Save default tiers for a service (append new effective set)
 */
function save_default_tiers($service_id, $tiers, $effective_date = null)
{
    if ($effective_date === null) {
        $effective_date = date("Y-m-d");
    }

    foreach ($tiers as $tier) {
        sqlite_execute(
            "INSERT INTO pricing_tiers (level, level_id, service_id, volume_start, volume_end, price_per_inquiry, effective_date)
             VALUES ('default', NULL, ?, ?, ?, ?, ?)",
            [
                $service_id,
                $tier["volume_start"],
                $tier["volume_end"],
                $tier["price_per_inquiry"],
                $effective_date,
            ]
        );
    }

    return true;
}

/**
 * Get current group tiers for a service (group-level overrides only)
 */
function get_current_group_tiers($group_id, $service_id)
{
    $latest = sqlite_query(
        "SELECT MAX(effective_date) as max_date FROM pricing_tiers
         WHERE level = 'group' AND level_id = ? AND service_id = ?
         AND effective_date <= date('now')",
        [$group_id, $service_id]
    );

    if (empty($latest) || !$latest[0]["max_date"]) {
        return [];
    }

    return sqlite_query(
        "SELECT * FROM pricing_tiers
         WHERE level = 'group' AND level_id = ? AND service_id = ?
         AND effective_date = ?
         ORDER BY volume_start ASC",
        [$group_id, $service_id, $latest[0]["max_date"]]
    );
}

/**
 * Save group tiers for a service (append new effective set)
 */
function save_group_tiers(
    $group_id,
    $service_id,
    $tiers,
    $effective_date = null
) {
    if ($effective_date === null) {
        $effective_date = date("Y-m-d");
    }

    foreach ($tiers as $tier) {
        sqlite_execute(
            "INSERT INTO pricing_tiers (level, level_id, service_id, volume_start, volume_end, price_per_inquiry, effective_date)
             VALUES ('group', ?, ?, ?, ?, ?, ?)",
            [
                $group_id,
                $service_id,
                $tier["volume_start"],
                $tier["volume_end"],
                $tier["price_per_inquiry"],
                $effective_date,
            ]
        );
    }

    return true;
}

/**
 * Clear group overrides for a service (by inserting empty set - append only)
 * We mark it cleared by inserting a special record or just not having records for new date
 */
function clear_group_tiers($group_id, $service_id)
{
    // In append-only model, "clearing" means the group now inherits from default
    // We don't actually delete, we just don't have overrides for current date
    // The UI will check if group has overrides, if not, show inherited
    return true;
}

/**
 * Get effective tiers for a group+service (group override or default fallback)
 */
function get_effective_group_tiers($group_id, $service_id)
{
    $group_tiers = get_current_group_tiers($group_id, $service_id);

    if (!empty($group_tiers)) {
        // Mark as overridden
        foreach ($group_tiers as &$tier) {
            $tier["source"] = "group";
        }
        return $group_tiers;
    }

    // Fall back to defaults
    $default_tiers = get_current_default_tiers($service_id);
    foreach ($default_tiers as &$tier) {
        $tier["source"] = "default";
    }
    return $default_tiers;
}

/**
 * Get current customer tiers for a service (customer-level overrides only)
 */
function get_current_customer_tiers($customer_id, $service_id)
{
    $latest = sqlite_query(
        "SELECT MAX(effective_date) as max_date FROM pricing_tiers
         WHERE level = 'customer' AND level_id = ? AND service_id = ?
         AND effective_date <= date('now')",
        [$customer_id, $service_id]
    );

    if (empty($latest) || !$latest[0]["max_date"]) {
        return [];
    }

    return sqlite_query(
        "SELECT * FROM pricing_tiers
         WHERE level = 'customer' AND level_id = ? AND service_id = ?
         AND effective_date = ?
         ORDER BY volume_start ASC",
        [$customer_id, $service_id, $latest[0]["max_date"]]
    );
}

/**
 * Save customer tiers for a service (append new effective set)
 */
function save_customer_tiers(
    $customer_id,
    $service_id,
    $tiers,
    $effective_date = null
) {
    if ($effective_date === null) {
        $effective_date = date("Y-m-d");
    }

    foreach ($tiers as $tier) {
        sqlite_execute(
            "INSERT INTO pricing_tiers (level, level_id, service_id, volume_start, volume_end, price_per_inquiry, effective_date)
             VALUES ('customer', ?, ?, ?, ?, ?, ?)",
            [
                $customer_id,
                $service_id,
                $tier["volume_start"],
                $tier["volume_end"],
                $tier["price_per_inquiry"],
                $effective_date,
            ]
        );
    }

    return true;
}

/**
 * Get effective tiers for a customer+service (full inheritance: customer -> group -> default)
 */
function get_effective_customer_tiers($customer_id, $service_id)
{
    // First check customer override
    $customer_tiers = get_current_customer_tiers($customer_id, $service_id);

    if (!empty($customer_tiers)) {
        foreach ($customer_tiers as &$tier) {
            $tier["source"] = "customer";
        }
        return $customer_tiers;
    }

    // Check if customer belongs to a group
    $customer = sqlite_query(
        "SELECT discount_group_id FROM customers WHERE id = ?",
        [$customer_id]
    );

    if (!empty($customer) && $customer[0]["discount_group_id"]) {
        $group_id = $customer[0]["discount_group_id"];
        $group_tiers = get_current_group_tiers($group_id, $service_id);

        if (!empty($group_tiers)) {
            foreach ($group_tiers as &$tier) {
                $tier["source"] = "group";
            }
            return $group_tiers;
        }
    }

    // Fall back to defaults
    $default_tiers = get_current_default_tiers($service_id);
    foreach ($default_tiers as &$tier) {
        $tier["source"] = "default";
    }
    return $default_tiers;
}

/**
 * Get customer settings (monthly minimum, annualized, etc.)
 */
function get_current_customer_settings($customer_id)
{
    $settings = sqlite_query(
        "SELECT * FROM customer_settings
         WHERE customer_id = ? AND effective_date <= date('now')
         ORDER BY effective_date DESC, id DESC LIMIT 1",
        [$customer_id]
    );

    if (!empty($settings)) {
        return $settings[0];
    }

    // Return defaults
    return [
        "customer_id" => $customer_id,
        "monthly_minimum" => null,
        "uses_annualized" => 0,
        "annualized_start_date" => null,
        "look_period_months" => null,
    ];
}

/**
 * Save customer settings (append-only)
 */
function save_customer_settings($customer_id, $settings)
{
    $effective_date = date("Y-m-d");

    sqlite_execute(
        "INSERT INTO customer_settings (customer_id, effective_date, monthly_minimum, uses_annualized, annualized_start_date, look_period_months)
         VALUES (?, ?, ?, ?, ?, ?)",
        [
            $customer_id,
            $effective_date,
            isset($settings["monthly_minimum"]) &&
            $settings["monthly_minimum"] !== ""
                ? (float) $settings["monthly_minimum"]
                : null,
            isset($settings["uses_annualized"])
                ? (int) $settings["uses_annualized"]
                : 0,
            isset($settings["annualized_start_date"]) &&
            $settings["annualized_start_date"] !== ""
                ? $settings["annualized_start_date"]
                : null,
            isset($settings["look_period_months"]) &&
            $settings["look_period_months"] !== ""
                ? (int) $settings["look_period_months"]
                : null,
        ]
    );

    return true;
}

/**
 * Calculate monthly minimum gap for a customer
 * Given usage amount, returns the gap needed to reach minimum (or 0 if above minimum)
 *
 * @param int   $customer_id    Customer ID
 * @param float $usage_amount   Current month's calculated usage amount
 * @return array                ['minimum' => float, 'usage' => float, 'gap' => float, 'has_minimum' => bool]
 */
function calculate_monthly_minimum_gap($customer_id, $usage_amount)
{
    $settings = get_current_customer_settings($customer_id);

    $result = [
        "minimum" => 0,
        "usage" => $usage_amount,
        "gap" => 0,
        "has_minimum" => false,
    ];

    if ($settings["monthly_minimum"] && $settings["monthly_minimum"] > 0) {
        $result["has_minimum"] = true;
        $result["minimum"] = (float) $settings["monthly_minimum"];

        if ($usage_amount < $result["minimum"]) {
            $result["gap"] = $result["minimum"] - $usage_amount;
        }
    }

    return $result;
}

/**
 * Get all customers with monthly minimums for overview
 */
function get_customers_with_minimums()
{
    return sqlite_query(
        "SELECT c.id, c.name, c.status, cs.monthly_minimum
         FROM customers c
         INNER JOIN customer_settings cs ON c.id = cs.customer_id
         WHERE cs.monthly_minimum IS NOT NULL
         AND cs.monthly_minimum > 0
         AND cs.effective_date = (
             SELECT MAX(cs2.effective_date) FROM customer_settings cs2
             WHERE cs2.customer_id = cs.customer_id AND cs2.effective_date <= date('now')
         )
         ORDER BY c.name"
    );
}

// ------------------------------------------------------------
// PRICING: SYSTEM DEFAULTS ACTIONS
// ------------------------------------------------------------

/**
 * List all services with their default pricing
 */
function action_pricing_defaults()
{
    $services = get_all_services();

    // Get tier counts for each service
    foreach ($services as &$service) {
        $tiers = get_current_default_tiers($service["id"]);
        $service["tier_count"] = count($tiers);
        $service["tiers"] = $tiers;
    }

    $data = [
        "services" => $services,
    ];

    render_pricing_defaults($data);
}

/**
 * Edit default tiers for a service
 */
function action_pricing_defaults_edit()
{
    $service_id = get_param("service_id");

    if (empty($service_id)) {
        set_flash("error", "No service specified");
        redirect("pricing_defaults");
        return;
    }

    // Get service
    $services = sqlite_query("SELECT * FROM services WHERE id = ?", [
        $service_id,
    ]);
    if (empty($services)) {
        set_flash("error", "Service not found");
        redirect("pricing_defaults");
        return;
    }
    $service = $services[0];

    // Handle POST (save tiers)
    if ($_SERVER["REQUEST_METHOD"] === "POST") {
        $tiers = [];
        $volume_starts = isset($_POST["volume_start"])
            ? $_POST["volume_start"]
            : [];
        $volume_ends = isset($_POST["volume_end"]) ? $_POST["volume_end"] : [];
        $prices = isset($_POST["price_per_inquiry"])
            ? $_POST["price_per_inquiry"]
            : [];

        for ($i = 0; $i < count($volume_starts); $i++) {
            if ($volume_starts[$i] !== "" && $prices[$i] !== "") {
                $tiers[] = [
                    "volume_start" => (int) $volume_starts[$i],
                    "volume_end" =>
                        $volume_ends[$i] !== "" ? (int) $volume_ends[$i] : null,
                    "price_per_inquiry" => (float) $prices[$i],
                ];
            }
        }

        if (!empty($tiers)) {
            save_default_tiers($service_id, $tiers);
            set_flash(
                "success",
                "Default pricing saved for " . $service["name"]
            );
            redirect("pricing_defaults");
            return;
        } else {
            set_flash("error", "No valid tiers provided");
        }
    }

    // Get current tiers
    $tiers = get_current_default_tiers($service_id);

    $data = [
        "service" => $service,
        "tiers" => $tiers,
    ];

    render_pricing_defaults_edit($data);
}

// ------------------------------------------------------------
// PRICING: DISCOUNT GROUPS ACTIONS
// ------------------------------------------------------------

function action_pricing_groups()
{
    $groups = sqlite_query("SELECT * FROM discount_groups ORDER BY name");

    foreach ($groups as &$group) {
        // Count members
        $count = sqlite_query(
            "SELECT COUNT(*) as cnt FROM customers WHERE discount_group_id = ?",
            [$group["id"]]
        );
        $group["member_count"] = $count[0]["cnt"];

        // Count overrides
        $overrides = sqlite_query(
            "SELECT COUNT(DISTINCT service_id) as cnt FROM pricing_tiers
             WHERE level = 'group' AND level_id = ? AND effective_date <= date('now')",
            [$group["id"]]
        );
        $group["override_count"] = $overrides[0]["cnt"];
    }

    $data = ["groups" => $groups];
    render_pricing_groups($data);
}

function action_pricing_group_edit()
{
    $group_id = get_param("group_id");
    $service_id = get_param("service_id");

    if (empty($group_id)) {
        set_flash("error", "No group specified");
        redirect("pricing_groups");
        return;
    }

    // Get group
    $groups = sqlite_query("SELECT * FROM discount_groups WHERE id = ?", [
        $group_id,
    ]);
    if (empty($groups)) {
        set_flash("error", "Group not found");
        redirect("pricing_groups");
        return;
    }
    $group = $groups[0];

    // Get all services
    $services = get_all_services();

    // If no service selected, show service list for this group
    if (empty($service_id)) {
        foreach ($services as &$svc) {
            $svc["tiers"] = get_effective_group_tiers($group_id, $svc["id"]);
            $svc["has_override"] =
                !empty($svc["tiers"]) && $svc["tiers"][0]["source"] === "group";
        }

        $data = [
            "group" => $group,
            "services" => $services,
        ];
        render_pricing_group_services($data);
        return;
    }

    // Get specific service
    $svc_rows = sqlite_query("SELECT * FROM services WHERE id = ?", [
        $service_id,
    ]);
    if (empty($svc_rows)) {
        set_flash("error", "Service not found");
        redirect("pricing_group_edit", ["group_id" => $group_id]);
        return;
    }
    $service = $svc_rows[0];

    // Handle POST (save tiers)
    if ($_SERVER["REQUEST_METHOD"] === "POST") {
        $action = get_param("form_action", "save");

        if ($action === "clear") {
            // Clear override - insert empty marker or just rely on no records
            // For simplicity, we'll just not save anything and show inherited
            set_flash(
                "success",
                "Override cleared for " .
                    $service["name"] .
                    ". Group now inherits from defaults."
            );
            redirect("pricing_group_edit", ["group_id" => $group_id]);
            return;
        }

        $tiers = [];
        $volume_starts = isset($_POST["volume_start"])
            ? $_POST["volume_start"]
            : [];
        $volume_ends = isset($_POST["volume_end"]) ? $_POST["volume_end"] : [];
        $prices = isset($_POST["price_per_inquiry"])
            ? $_POST["price_per_inquiry"]
            : [];

        for ($i = 0; $i < count($volume_starts); $i++) {
            if ($volume_starts[$i] !== "" && $prices[$i] !== "") {
                $tiers[] = [
                    "volume_start" => (int) $volume_starts[$i],
                    "volume_end" =>
                        $volume_ends[$i] !== "" ? (int) $volume_ends[$i] : null,
                    "price_per_inquiry" => (float) $prices[$i],
                ];
            }
        }

        if (!empty($tiers)) {
            save_group_tiers($group_id, $service_id, $tiers);
            set_flash("success", "Group pricing saved for " . $service["name"]);
            redirect("pricing_group_edit", ["group_id" => $group_id]);
            return;
        } else {
            set_flash("error", "No valid tiers provided");
        }
    }

    // Get current tiers (group override or inherited default)
    $tiers = get_effective_group_tiers($group_id, $service_id);
    $has_override = !empty($tiers) && $tiers[0]["source"] === "group";

    $data = [
        "group" => $group,
        "service" => $service,
        "tiers" => $tiers,
        "has_override" => $has_override,
    ];

    render_pricing_group_edit($data);
}

// ------------------------------------------------------------
// PRICING: CUSTOMERS ACTIONS
// ------------------------------------------------------------

function action_pricing_customers()
{
    $page = (int) get_param("page", 1);
    $status = get_param("status", "active");
    $search = get_param("search", "");

    $where = [];
    $params = [];

    if ($status !== "all") {
        $where[] = "c.status = ?";
        $params[] = $status;
    }

    if (!empty($search)) {
        $where[] = "(c.name LIKE ? OR dg.name LIKE ?)";
        $params[] = "%$search%";
        $params[] = "%$search%";
    }

    $where_str = !empty($where) ? "WHERE " . implode(" AND ", $where) : "";

    // Get total for pagination
    $total_query = "SELECT COUNT(*) as cnt FROM customers c LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id $where_str";
    $total = sqlite_query($total_query, $params);
    $total_count = $total[0]["cnt"];

    $pagination = paginate($total_count, $page);

    // Get customers
    $offset = ($page - 1) * ITEMS_PER_PAGE;
    $query_params = $params;
    $query_params[] = ITEMS_PER_PAGE;
    $query_params[] = $offset;

    $customers = sqlite_query(
        "SELECT c.*, dg.name as group_name
         FROM customers c
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         $where_str
         ORDER BY c.name
         LIMIT ? OFFSET ?",
        $query_params
    );

    $data = [
        "customers" => $customers,
        "pagination" => $pagination,
        "status_filter" => $status,
        "search" => $search,
    ];

    render_pricing_customers($data);
}

function action_pricing_customer_edit()
{
    $customer_id = get_param("customer_id");
    $service_id = get_param("service_id");
    $tab = get_param("tab", "services"); // 'services' or 'settings'

    if (empty($customer_id)) {
        set_flash("error", "No customer specified");
        redirect("pricing_customers");
        return;
    }

    // Get customer with group info
    $customers = sqlite_query(
        "SELECT c.*, dg.name as group_name
         FROM customers c
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         WHERE c.id = ?",
        [$customer_id]
    );

    if (empty($customers)) {
        set_flash("error", "Customer not found");
        redirect("pricing_customers");
        return;
    }
    $customer = $customers[0];

    // Get all services
    $services = get_all_services();

    // Handle settings tab
    if ($tab === "settings") {
        // Handle POST (save settings)
        if ($_SERVER["REQUEST_METHOD"] === "POST") {
            $settings = [
                "monthly_minimum" => get_param("monthly_minimum", ""),
                "uses_annualized" => get_param("uses_annualized", 0),
                "annualized_start_date" => get_param(
                    "annualized_start_date",
                    ""
                ),
                "look_period_months" => get_param("look_period_months", ""),
            ];

            save_customer_settings($customer_id, $settings);

            // Save LMS assignment
            $lms_id = get_param("lms_id", "");
            if ($lms_id !== "") {
                assign_customer_lms($customer_id, $lms_id);
            }

            set_flash("success", "Settings saved for " . $customer["name"]);
            redirect("pricing_customer_edit", [
                "customer_id" => $customer_id,
                "tab" => "settings",
            ]);
            return;
        }

        $current_settings = get_current_customer_settings($customer_id);

        // Get all LMS entries for dropdown
        $all_lms = get_all_lms();

        $data = [
            "customer" => $customer,
            "settings" => $current_settings,
            "all_lms" => $all_lms,
            "tab" => "settings",
        ];
        render_pricing_customer_settings($data);
        return;
    }

    // If no service selected, show service list for this customer
    if (empty($service_id)) {
        foreach ($services as &$svc) {
            $svc["tiers"] = get_effective_customer_tiers(
                $customer_id,
                $svc["id"]
            );
            $svc["has_override"] =
                !empty($svc["tiers"]) &&
                $svc["tiers"][0]["source"] === "customer";
            $svc["source"] = !empty($svc["tiers"])
                ? $svc["tiers"][0]["source"]
                : "default";
        }

        $current_settings = get_current_customer_settings($customer_id);

        $data = [
            "customer" => $customer,
            "services" => $services,
            "settings" => $current_settings,
            "tab" => "services",
        ];
        render_pricing_customer_services($data);
        return;
    }

    // Get specific service
    $svc_rows = sqlite_query("SELECT * FROM services WHERE id = ?", [
        $service_id,
    ]);
    if (empty($svc_rows)) {
        set_flash("error", "Service not found");
        redirect("pricing_customer_edit", ["customer_id" => $customer_id]);
        return;
    }
    $service = $svc_rows[0];

    // Handle POST (save tiers)
    if ($_SERVER["REQUEST_METHOD"] === "POST") {
        $action = get_param("form_action", "save");

        if ($action === "clear") {
            // Clear override - customer now inherits from group/default
            set_flash(
                "success",
                "Override cleared for " .
                    $service["name"] .
                    ". Customer now inherits from " .
                    ($customer["discount_group_id"] ? "group" : "defaults") .
                    "."
            );
            redirect("pricing_customer_edit", ["customer_id" => $customer_id]);
            return;
        }

        $tiers = [];
        $volume_starts = isset($_POST["volume_start"])
            ? $_POST["volume_start"]
            : [];
        $volume_ends = isset($_POST["volume_end"]) ? $_POST["volume_end"] : [];
        $prices = isset($_POST["price_per_inquiry"])
            ? $_POST["price_per_inquiry"]
            : [];

        for ($i = 0; $i < count($volume_starts); $i++) {
            if ($volume_starts[$i] !== "" && $prices[$i] !== "") {
                $tiers[] = [
                    "volume_start" => (int) $volume_starts[$i],
                    "volume_end" =>
                        $volume_ends[$i] !== "" ? (int) $volume_ends[$i] : null,
                    "price_per_inquiry" => (float) $prices[$i],
                ];
            }
        }

        if (!empty($tiers)) {
            save_customer_tiers($customer_id, $service_id, $tiers);
            set_flash(
                "success",
                "Customer pricing saved for " . $service["name"]
            );
            redirect("pricing_customer_edit", ["customer_id" => $customer_id]);
            return;
        } else {
            set_flash("error", "No valid tiers provided");
        }
    }

    // Get current tiers (customer override or inherited from group/default)
    $tiers = get_effective_customer_tiers($customer_id, $service_id);
    $has_override = !empty($tiers) && $tiers[0]["source"] === "customer";
    $source = !empty($tiers) ? $tiers[0]["source"] : "default";

    $data = [
        "customer" => $customer,
        "service" => $service,
        "tiers" => $tiers,
        "has_override" => $has_override,
        "source" => $source,
    ];

    render_pricing_customer_edit($data);
}

// ------------------------------------------------------------
// ESCALATORS ACTIONS
// ------------------------------------------------------------

/**
 * Get current escalators for a customer
 */
function get_current_escalators($customer_id)
{
    // Get the latest escalator set by finding max effective_date
    $latest = sqlite_query(
        "SELECT MAX(effective_date) as max_date FROM customer_escalators
         WHERE customer_id = ? AND effective_date <= date('now')",
        [$customer_id]
    );

    if (empty($latest) || !$latest[0]["max_date"]) {
        return [];
    }

    return sqlite_query(
        "SELECT * FROM customer_escalators
         WHERE customer_id = ? AND effective_date = ?
         ORDER BY year_number ASC",
        [$customer_id, $latest[0]["max_date"]]
    );
}

/**
 * Save escalators for a customer (append-only)
 */
function save_escalators($customer_id, $escalators, $escalator_start_date)
{
    $effective_date = date("Y-m-d");

    foreach ($escalators as $esc) {
        sqlite_execute(
            "INSERT INTO customer_escalators (customer_id, escalator_start_date, year_number, escalator_percentage, fixed_adjustment, effective_date)
             VALUES (?, ?, ?, ?, ?, ?)",
            [
                $customer_id,
                $escalator_start_date,
                $esc["year_number"],
                isset($esc["escalator_percentage"])
                    ? (float) $esc["escalator_percentage"]
                    : 0,
                isset($esc["fixed_adjustment"])
                    ? (float) $esc["fixed_adjustment"]
                    : 0,
                $effective_date,
            ]
        );
    }

    return true;
}

/**
 * Get delays for a customer's escalators
 */
function get_escalator_delays($customer_id)
{
    return sqlite_query(
        "SELECT * FROM escalator_delays
         WHERE customer_id = ?
         ORDER BY year_number ASC, applied_date DESC",
        [$customer_id]
    );
}

/**
 * Apply a delay to a specific year's escalator
 */
function apply_escalator_delay($customer_id, $year_number, $delay_months = 1)
{
    sqlite_execute(
        "INSERT INTO escalator_delays (customer_id, year_number, delay_months, applied_date)
         VALUES (?, ?, ?, date('now'))",
        [$customer_id, $year_number, $delay_months]
    );
    return true;
}

/**
 * Save escalator delay (alias for apply_escalator_delay with optional reason)
 */
function save_escalator_delay($customer_id, $year_number, $delay_months = 1, $reason = null)
{
    return apply_escalator_delay($customer_id, $year_number, $delay_months);
}

/**
 * Calculate total delay for a specific year
 */
function get_total_delay_months($customer_id, $year_number)
{
    $delays = sqlite_query(
        "SELECT SUM(delay_months) as total FROM escalator_delays
         WHERE customer_id = ? AND year_number = ?",
        [$customer_id, $year_number]
    );

    return !empty($delays) && $delays[0]["total"]
        ? (int) $delays[0]["total"]
        : 0;
}

// ============================================================
// LMS (Loan Management System) FUNCTIONS
// ============================================================

/**
 * Get all LMS entries
 */
function get_all_lms()
{
    return sqlite_query("SELECT * FROM lms ORDER BY name");
}

/**
 * Get a single LMS by ID
 */
function get_lms($lms_id)
{
    $rows = sqlite_query("SELECT * FROM lms WHERE id = ?", [$lms_id]);
    return !empty($rows) ? $rows[0] : null;
}

/**
 * Get default commission rate from system settings
 */
function get_default_commission_rate()
{
    $rows = sqlite_query(
        "SELECT value FROM system_settings WHERE key = 'default_commission_rate'"
    );
    return !empty($rows) ? (float) $rows[0]["value"] : 10.0; // Default 10%
}

/**
 * Save default commission rate to system settings
 */
function save_default_commission_rate($rate)
{
    // Try update first
    $result = sqlite_execute(
        "UPDATE system_settings SET value = ?, updated_at = datetime('now')
         WHERE key = 'default_commission_rate'",
        [$rate]
    );

    // If no row updated, insert
    $changes = sqlite_db()->changes();
    if ($changes === 0) {
        sqlite_execute(
            "INSERT INTO system_settings (key, value, updated_at) VALUES ('default_commission_rate', ?, datetime('now'))",
            [$rate]
        );
    }
    return true;
}

/**
 * Get effective commission rate for an LMS (inherits from default if NULL)
 */
function get_effective_commission_rate($lms_id)
{
    $lms = get_lms($lms_id);
    if ($lms && $lms["commission_rate"] !== null) {
        return (float) $lms["commission_rate"];
    }
    return get_default_commission_rate();
}

/**
 * Save LMS (insert or update)
 */
function save_lms($id, $name, $commission_rate = null)
{
    // Check if exists
    $existing = get_lms($id);

    if ($existing) {
        sqlite_execute(
            "UPDATE lms SET name = ?, commission_rate = ?, updated_at = datetime('now') WHERE id = ?",
            [$name, $commission_rate, $id]
        );
    } else {
        sqlite_execute(
            "INSERT INTO lms (id, name, commission_rate, last_synced, created_at, updated_at)
             VALUES (?, ?, ?, datetime('now'), datetime('now'), datetime('now'))",
            [$id, $name, $commission_rate]
        );
    }
    return true;
}

/**
 * Sync LMS from remote database
 *
 * SOURCE TABLES (Production):
 *   - connectors table: id, name, status (active/paused/decommissioned)
 *   - [second source TBD]
 *
 * LMS is a unified view of these two source tables.
 * We pull id, name, and status. Commission rates are stored locally only.
 */
function sync_lms_from_remote()
{
    if (MOCK_MODE) {
        // Insert mock LMS data (simulating connectors table)
        // In production, this comes from: SELECT id, name, status FROM connectors
        $mock_lms = [
            ["id" => 1, "name" => "First National LMS", "status" => "active"],
            ["id" => 2, "name" => "Pacific Lending", "status" => "active"],
            ["id" => 3, "name" => "Midwest Finance Corp", "status" => "active"],
            [
                "id" => 4,
                "name" => "Atlantic Mortgage Services",
                "status" => "paused",
            ],
            [
                "id" => 5,
                "name" => "Southwest Credit Union",
                "status" => "decommissioned",
            ],
        ];

        foreach ($mock_lms as $lms) {
            // Only insert if not exists (don't override local commission rates)
            $existing = get_lms($lms["id"]);
            if (!$existing) {
                sqlite_execute(
                    "INSERT INTO lms (id, name, status, last_synced, created_at, updated_at)
                     VALUES (?, ?, ?, datetime('now'), datetime('now'), datetime('now'))",
                    [$lms["id"], $lms["name"], $lms["status"]]
                );
            } else {
                // Update name and status, preserve local commission_rate
                sqlite_execute(
                    "UPDATE lms SET name = ?, status = ?, last_synced = datetime('now'), updated_at = datetime('now') WHERE id = ?",
                    [$lms["name"], $lms["status"], $lms["id"]]
                );
            }
        }

        // Log the sync
        sqlite_execute(
            "INSERT INTO sync_log (entity_type, record_count, status) VALUES ('lms', ?, 'success')",
            [count($mock_lms)]
        );

        return count($mock_lms);
    }

    // Production: query remote DB
    // SOURCE: connectors table (+ second source TBD)
    // TODO: Update query when second source is identified
    $remote_lms = remote_db_query(
        "SELECT id, name, status FROM connectors ORDER BY name"
    );

    foreach ($remote_lms as $lms) {
        $status = isset($lms["status"]) ? $lms["status"] : "active";
        $existing = get_lms($lms["id"]);
        if (!$existing) {
            sqlite_execute(
                "INSERT INTO lms (id, name, status, last_synced, created_at, updated_at)
                 VALUES (?, ?, ?, datetime('now'), datetime('now'), datetime('now'))",
                [$lms["id"], $lms["name"], $status]
            );
        } else {
            sqlite_execute(
                "UPDATE lms SET name = ?, status = ?, last_synced = datetime('now'), updated_at = datetime('now') WHERE id = ?",
                [$lms["name"], $status, $lms["id"]]
            );
        }
    }

    sqlite_execute(
        "INSERT INTO sync_log (entity_type, record_count, status) VALUES ('lms', ?, 'success')",
        [count($remote_lms)]
    );

    return count($remote_lms);
}

/**
 * Get customers by LMS
 */
function get_customers_by_lms($lms_id)
{
    return sqlite_query(
        "SELECT c.*, dg.name as group_name
         FROM customers c
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         WHERE c.lms_id = ?
         ORDER BY c.name",
        [$lms_id]
    );
}

/**
 * Get customers without LMS assignment
 */
function get_customers_without_lms()
{
    return sqlite_query(
        "SELECT c.*, dg.name as group_name
         FROM customers c
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         WHERE c.lms_id IS NULL OR c.lms_id = 0
         ORDER BY c.name"
    );
}

/**
 * Assign customer to LMS
 */
function assign_customer_lms($customer_id, $lms_id)
{
    sqlite_execute(
        "UPDATE customers SET lms_id = ?, updated_at = datetime('now') WHERE id = ?",
        [$lms_id, $customer_id]
    );
    return true;
}

/**
 * Get COGS rate for a service (current effective)
 */
function get_service_cogs($service_id)
{
    $rows = sqlite_query(
        "SELECT cogs_rate FROM service_cogs
         WHERE service_id = ? AND effective_date <= date('now')
         ORDER BY effective_date DESC, id DESC LIMIT 1",
        [$service_id]
    );
    return !empty($rows) ? (float) $rows[0]["cogs_rate"] : 0.0;
}

/**
 * Save COGS rate for a service (append-only)
 */
function save_service_cogs($service_id, $cogs_rate, $effective_date = null)
{
    if ($effective_date === null) {
        $effective_date = date("Y-m-d");
    }

    sqlite_execute(
        "INSERT INTO service_cogs (service_id, cogs_rate, effective_date) VALUES (?, ?, ?)",
        [$service_id, $cogs_rate, $effective_date]
    );
    return true;
}

/**
 * Sync COGS from remote database
 */
function sync_cogs_from_remote()
{
    if (MOCK_MODE) {
        // Get current services and assign mock COGS
        $services = get_all_services();
        $count = 0;

        foreach ($services as $service) {
            // Check if COGS already exists for this service
            $existing = get_service_cogs($service["id"]);
            if ($existing == 0) {
                // Assign a mock COGS (roughly 30-50% of typical price)
                $mock_cogs = round(mt_rand(10, 35) / 100, 2); // $0.10 - $0.35
                save_service_cogs($service["id"], $mock_cogs);
                $count++;
            }
        }

        sqlite_execute(
            "INSERT INTO sync_log (entity_type, record_count, status) VALUES ('cogs', ?, 'success')",
            [$count]
        );

        return $count;
    }

    // Production: query remote DB
    $remote_cogs = remote_db_query(
        "SELECT service_id, cogs_rate FROM service_cogs"
    );
    $count = 0;

    foreach ($remote_cogs as $cogs) {
        save_service_cogs($cogs["service_id"], $cogs["cogs_rate"]);
        $count++;
    }

    sqlite_execute(
        "INSERT INTO sync_log (entity_type, record_count, status) VALUES ('cogs', ?, 'success')",
        [count($remote_cogs)]
    );

    return count($remote_cogs);
}

// ============================================================
// BILLING REPORT INGESTION
// ============================================================

/**
 * Parse billing report filename to extract date info and type
 *
 * Patterns:
 *   Daily:   DataX_2025_01_1_humanreadable.csv   (YYYY_MM_D)
 *   Monthly: DataX_2025_01_2025_01_humanreadable.csv (YYYY_MM_YYYY_MM)
 *
 * @param string $filename
 * @return array|false Array with type, year, month, day (if daily) or false on failure
 */
function parse_billing_filename($filename)
{
    // Monthly pattern: DataX_YYYY_MM_YYYY_MM_*.csv
    if (
        preg_match(
            "/^DataX_(\d{4})_(\d{2})_(\d{4})_(\d{2})_/",
            $filename,
            $matches
        )
    ) {
        return [
            "type" => "monthly",
            "year" => (int) $matches[1],
            "month" => (int) $matches[2],
            "end_year" => (int) $matches[3],
            "end_month" => (int) $matches[4],
            "day" => null,
        ];
    }

    // Daily pattern: DataX_YYYY_MM_D_*.csv
    if (
        preg_match("/^DataX_(\d{4})_(\d{2})_(\d{1,2})_/", $filename, $matches)
    ) {
        return [
            "type" => "daily",
            "year" => (int) $matches[1],
            "month" => (int) $matches[2],
            "day" => (int) $matches[3],
            "end_year" => null,
            "end_month" => null,
        ];
    }

    return false;
}

/**
 * Parse billing report CSV content
 *
 * Expected header:
 *   y,m,cust_id,cust_name,hit_code,tran_displayname,actual_unit_cost,count,revenue,EFX_code,billing_id
 *
 * @param string $csv_content Raw CSV content
 * @return array Array with 'headers', 'rows', 'errors'
 */
function parse_billing_csv($csv_content)
{
    $result = [
        "headers" => [],
        "rows" => [],
        "errors" => [],
        "row_count" => 0,
    ];

    $lines = explode("\n", $csv_content);
    if (empty($lines)) {
        $result["errors"][] = "Empty file";
        return $result;
    }

    // Parse header
    $header_line = trim(array_shift($lines));
    $result["headers"] = str_getcsv($header_line);

    // Expected headers
    $expected = [
        "y",
        "m",
        "cust_id",
        "cust_name",
        "hit_code",
        "tran_displayname",
        "actual_unit_cost",
        "count",
        "revenue",
        "EFX_code",
        "billing_id",
    ];

    // Validate headers
    $header_map = [];
    foreach ($expected as $field) {
        $idx = array_search($field, $result["headers"]);
        if ($idx === false) {
            $result["errors"][] = "Missing required column: $field";
        } else {
            $header_map[$field] = $idx;
        }
    }

    if (!empty($result["errors"])) {
        return $result;
    }

    // Parse rows
    $line_num = 1;
    foreach ($lines as $line) {
        $line_num++;
        $line = trim($line);
        if (empty($line)) {
            continue;
        }

        $fields = str_getcsv($line);

        // Map to associative array
        $row = [];
        foreach ($header_map as $name => $idx) {
            $row[$name] = isset($fields[$idx]) ? $fields[$idx] : null;
        }

        // Basic validation
        if (empty($row["cust_id"])) {
            $result["errors"][] = "Line $line_num: Missing cust_id";
            continue;
        }

        // Type conversions
        $row["y"] = (int) $row["y"];
        $row["m"] = (int) $row["m"];
        $row["cust_id"] = (int) $row["cust_id"];
        $row["actual_unit_cost"] = (float) $row["actual_unit_cost"];
        $row["count"] = (int) $row["count"];
        $row["revenue"] = (float) $row["revenue"];

        $result["rows"][] = $row;
    }

    $result["row_count"] = count($result["rows"]);
    return $result;
}

/**
 * Import billing report into database
 *
 * @param string $filename Original filename
 * @param string $csv_content Raw CSV content
 * @param string $report_type 'daily' or 'monthly' (auto-detected if null)
 * @return array Result with 'success', 'report_id', 'rows_imported', 'errors'
 */
function import_billing_report($filename, $csv_content, $report_type = null)
{
    $result = [
        "success" => false,
        "report_id" => null,
        "rows_imported" => 0,
        "rows_skipped" => 0,
        "errors" => [],
    ];

    // Parse filename for date info
    $file_info = parse_billing_filename($filename);
    if ($file_info === false) {
        // Try to detect from content or use provided type
        if ($report_type === null) {
            $result[
                "errors"
            ][] = "Cannot determine report type from filename: $filename";
            return $result;
        }
        $file_info = [
            "type" => $report_type,
            "year" => (int) date("Y"),
            "month" => (int) date("n"),
            "day" => $report_type === "daily" ? (int) date("j") : null,
        ];
    } else {
        $report_type = $file_info["type"];
    }

    // Parse CSV
    $parsed = parse_billing_csv($csv_content);
    if (!empty($parsed["errors"])) {
        $result["errors"] = array_merge($result["errors"], $parsed["errors"]);
        return $result;
    }

    if (empty($parsed["rows"])) {
        $result["errors"][] = "No valid rows found in CSV";
        return $result;
    }

    // Build report date
    $report_date = sprintf(
        "%04d-%02d-%02d",
        $file_info["year"],
        $file_info["month"],
        $file_info["day"] ? $file_info["day"] : 1
    );

    // Check for duplicate import
    $existing = sqlite_query(
        "SELECT id FROM billing_reports
         WHERE report_type = ? AND report_year = ? AND report_month = ?
         AND (report_date = ? OR ? = 'monthly')",
        [
            $report_type,
            $file_info["year"],
            $file_info["month"],
            $report_date,
            $report_type,
        ]
    );

    if (!empty($existing) && $report_type === "monthly") {
        // For monthly, we might want to replace - for now, skip
        $result[
            "errors"
        ][] = "Monthly report for {$file_info["year"]}-{$file_info["month"]} already imported (ID: {$existing[0]["id"]})";
        return $result;
    }

    // Create report record
    sqlite_execute(
        "INSERT INTO billing_reports (report_type, report_year, report_month, report_date, file_path, record_count)
         VALUES (?, ?, ?, ?, ?, ?)",
        [
            $report_type,
            $file_info["year"],
            $file_info["month"],
            $report_date,
            $filename,
            count($parsed["rows"]),
        ]
    );
    $report_id = sqlite_last_id();
    $result["report_id"] = $report_id;

    // Import rows
    foreach ($parsed["rows"] as $row) {
        sqlite_execute(
            "INSERT INTO billing_report_lines
             (report_id, year, month, customer_id, customer_name, hit_code, tran_displayname,
              actual_unit_cost, count, revenue, efx_code, billing_id)
             VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",
            [
                $report_id,
                $row["y"],
                $row["m"],
                $row["cust_id"],
                $row["cust_name"],
                $row["hit_code"],
                $row["tran_displayname"],
                $row["actual_unit_cost"],
                $row["count"],
                $row["revenue"],
                $row["EFX_code"],
                $row["billing_id"],
            ]
        );
        $result["rows_imported"]++;
    }

    $result["success"] = true;
    return $result;
}

/**
 * Get all imported billing reports
 */
function get_billing_reports($type = null, $limit = 50)
{
    $sql = "SELECT * FROM billing_reports";
    $params = [];

    if ($type !== null) {
        $sql .= " WHERE report_type = ?";
        $params[] = $type;
    }

    $sql .=
        " ORDER BY report_year DESC, report_month DESC, report_date DESC LIMIT ?";
    $params[] = $limit;

    return sqlite_query($sql, $params);
}

/**
 * Get billing report lines for a specific report
 */
function get_billing_report_lines($report_id)
{
    return sqlite_query(
        "SELECT * FROM billing_report_lines WHERE report_id = ? ORDER BY customer_name, tran_displayname",
        [$report_id]
    );
}

/**
 * Delete a billing report and its lines
 */
function delete_billing_report($report_id)
{
    sqlite_execute("DELETE FROM billing_report_lines WHERE report_id = ?", [
        $report_id,
    ]);
    sqlite_execute("DELETE FROM billing_reports WHERE id = ?", [$report_id]);
    return true;
}

/**
 * Get billing summary by customer for a period
 */
function get_billing_summary_by_customer(
    $year,
    $month,
    $report_type = "monthly"
) {
    return sqlite_query(
        "SELECT
            brl.customer_id,
            brl.customer_name,
            SUM(brl.count) as total_count,
            SUM(brl.revenue) as total_revenue,
            COUNT(DISTINCT brl.tran_displayname) as transaction_types
         FROM billing_report_lines brl
         JOIN billing_reports br ON brl.report_id = br.id
         WHERE br.report_year = ? AND br.report_month = ? AND br.report_type = ?
         GROUP BY brl.customer_id, brl.customer_name
         ORDER BY total_revenue DESC",
        [$year, $month, $report_type]
    );
}

// ============================================================
// GENERATION HELPERS (tier_pricing.csv)
// ============================================================

/**
 * Get all transaction types (from displayname_to_type.csv data)
 */
function get_all_transaction_types()
{
    return sqlite_query(
        "SELECT * FROM transaction_types ORDER BY type, display_name"
    );
}

/**
 * Get transaction type by EFX code
 */
function get_transaction_type_by_efx($efx_code)
{
    $result = sqlite_query(
        "SELECT * FROM transaction_types WHERE efx_code = ? LIMIT 1",
        [$efx_code]
    );
    return !empty($result) ? $result[0] : null;
}

/**
 * Save/update a transaction type
 */
function save_transaction_type(
    $type,
    $display_name,
    $efx_code,
    $efx_displayname = null,
    $service_id = null
) {
    // Check if exists
    $existing = sqlite_query(
        "SELECT id FROM transaction_types WHERE efx_code = ? AND display_name = ?",
        [$efx_code, $display_name]
    );

    if (!empty($existing)) {
        sqlite_execute(
            "UPDATE transaction_types SET type = ?, efx_displayname = ?, service_id = ? WHERE id = ?",
            [$type, $efx_displayname, $service_id, $existing[0]["id"]]
        );
        return $existing[0]["id"];
    }

    sqlite_execute(
        "INSERT INTO transaction_types (type, display_name, efx_code, efx_displayname, service_id)
         VALUES (?, ?, ?, ?, ?)",
        [$type, $display_name, $efx_code, $efx_displayname, $service_id]
    );

    return sqlite_db()->lastInsertRowID();
}

/**
 * Import transaction types from CSV content
 * Expected format: type,display_name,EFX_code,EFX_displayname
 */
function import_transaction_types_csv($csv_content)
{
    $lines = explode("\n", $csv_content);
    $header = str_getcsv(trim(array_shift($lines)));

    $imported = 0;
    $errors = [];

    foreach ($lines as $line_num => $line) {
        $line = trim($line);
        if (empty($line)) {
            continue;
        }

        $fields = str_getcsv($line);
        if (count($fields) < 3) {
            $errors[] = "Line " . ($line_num + 2) . ": insufficient fields";
            continue;
        }

        $type = $fields[0];
        $display_name = $fields[1];
        $efx_code = $fields[2];
        $efx_displayname = isset($fields[3]) ? $fields[3] : null;

        save_transaction_type(
            $type,
            $display_name,
            $efx_code,
            $efx_displayname
        );
        $imported++;
    }

    return ["imported" => $imported, "errors" => $errors];
}

/**
 * Get billing flags for a service/EFX code with inheritance
 * Resolution: customer -> group -> default
 */
function get_effective_billing_flags(
    $service_id,
    $efx_code,
    $customer_id = null,
    $group_id = null
) {
    // Default flags
    $flags = [
        "by_hit" => 1,
        "zero_null" => 0,
        "bav_by_trans" => 0,
        "source" => "system_default",
    ];

    // Check system default level
    $default_flags = sqlite_query(
        "SELECT by_hit, zero_null, bav_by_trans FROM service_billing_flags
         WHERE level = 'default' AND level_id IS NULL
         AND service_id = ? AND efx_code = ?
         AND effective_date <= date('now')
         ORDER BY effective_date DESC, id DESC LIMIT 1",
        [$service_id, $efx_code]
    );

    if (!empty($default_flags)) {
        $flags = array_merge($flags, $default_flags[0]);
        $flags["source"] = "default";
    }

    // Check group level if applicable
    if ($group_id !== null) {
        $group_flags = sqlite_query(
            "SELECT by_hit, zero_null, bav_by_trans FROM service_billing_flags
             WHERE level = 'group' AND level_id = ?
             AND service_id = ? AND efx_code = ?
             AND effective_date <= date('now')
             ORDER BY effective_date DESC, id DESC LIMIT 1",
            [$group_id, $service_id, $efx_code]
        );

        if (!empty($group_flags)) {
            $flags = array_merge($flags, $group_flags[0]);
            $flags["source"] = "group";
        }
    }

    // Check customer level if applicable
    if ($customer_id !== null) {
        $customer_flags = sqlite_query(
            "SELECT by_hit, zero_null, bav_by_trans FROM service_billing_flags
             WHERE level = 'customer' AND level_id = ?
             AND service_id = ? AND efx_code = ?
             AND effective_date <= date('now')
             ORDER BY effective_date DESC, id DESC LIMIT 1",
            [$customer_id, $service_id, $efx_code]
        );

        if (!empty($customer_flags)) {
            $flags = array_merge($flags, $customer_flags[0]);
            $flags["source"] = "customer";
        }
    }

    return $flags;
}

/**
 * Save billing flags at a specific level
 */
function save_billing_flags(
    $level,
    $level_id,
    $service_id,
    $efx_code,
    $by_hit,
    $zero_null,
    $bav_by_trans,
    $effective_date = null
) {
    if ($effective_date === null) {
        $effective_date = date("Y-m-d");
    }

    sqlite_execute(
        "INSERT INTO service_billing_flags (level, level_id, service_id, efx_code, by_hit, zero_null, bav_by_trans, effective_date)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?)",
        [
            $level,
            $level_id,
            $service_id,
            $efx_code,
            $by_hit ? 1 : 0,
            $zero_null ? 1 : 0,
            $bav_by_trans ? 1 : 0,
            $effective_date,
        ]
    );

    return true;
}

/**
 * Calculate the adjusted price after applying escalators
 *
 * @param float  $base_price  Original tier price
 * @param int    $customer_id Customer ID
 * @param string $as_of_date  Date to calculate for (YYYY-MM-DD)
 * @return float Adjusted price
 */
function calculate_escalated_price(
    $base_price,
    $customer_id,
    $as_of_date = null
) {
    if ($as_of_date === null) {
        $as_of_date = date("Y-m-d");
    }

    $escalators = get_current_escalators($customer_id);
    if (empty($escalators)) {
        return $base_price;
    }

    // Get escalator start date from first entry
    $escalator_start = $escalators[0]["escalator_start_date"];
    if (empty($escalator_start)) {
        return $base_price;
    }

    // Calculate which year we're in
    $start_ts = strtotime($escalator_start);
    $as_of_ts = strtotime($as_of_date);

    if ($as_of_ts < $start_ts) {
        return $base_price; // Before escalators start
    }

    $years_elapsed = floor(($as_of_ts - $start_ts) / (365.25 * 24 * 60 * 60));
    $current_year = $years_elapsed + 1;

    // Find applicable escalator year (with delays)
    $adjusted_price = $base_price;

    foreach ($escalators as $esc) {
        $year_num = (int) $esc["year_number"];

        // Check for delays on this year
        $delay_months = get_total_delay_months($customer_id, $year_num);
        $delay_days = $delay_months * 30;

        // Calculate effective date for this year's escalator
        $year_start_ts = strtotime("+" . ($year_num - 1) . " years", $start_ts);
        $effective_ts = strtotime("+$delay_days days", $year_start_ts);

        // Normalize to 1st of month
        $effective_month_start = strtotime(date("Y-m-01", $effective_ts));
        if ($effective_ts > $effective_month_start) {
            $effective_ts = strtotime("+1 month", $effective_month_start);
        }

        // Apply if we're past the effective date
        if ($as_of_ts >= $effective_ts) {
            $percentage = (float) $esc["escalator_percentage"];
            $fixed = (float) $esc["fixed_adjustment"];

            // Apply percentage escalation (compounding from base)
            if ($percentage > 0) {
                $adjusted_price = $base_price * (1 + $percentage / 100);
            }

            // Apply fixed adjustment
            $adjusted_price += $fixed;
        }
    }

    return round($adjusted_price, 6);
}

/**
 * Generate tier_pricing.csv content
 *
 * Output format:
 * cust_id,discount_group,start_date,end_date,EFX_code,type,start_trans,end_trans,adj_price,base_price,by_hit,zero_null,bav_by_trans
 *
 * @param array $options Generation options
 *   - customer_ids: array of customer IDs (null = all active)
 *   - as_of_date: date for calculations
 *   - include_inactive: bool, include paused/decommissioned
 * @return array Array with 'csv_content', 'row_count', 'errors'
 */
function generate_tier_pricing_csv($options = [])
{
    $result = [
        "csv_content" => "",
        "rows" => [],
        "row_count" => 0,
        "errors" => [],
    ];

    $as_of_date = isset($options["as_of_date"])
        ? $options["as_of_date"]
        : date("Y-m-d");
    $include_inactive = isset($options["include_inactive"])
        ? $options["include_inactive"]
        : false;

    // Get customers
    $status_filter = $include_inactive ? "" : "WHERE c.status = 'active'";
    if (!empty($options["customer_ids"])) {
        $ids = implode(",", array_map("intval", $options["customer_ids"]));
        $status_filter = $include_inactive
            ? "WHERE c.id IN ($ids)"
            : "WHERE c.status = 'active' AND c.id IN ($ids)";
    }

    $customers = sqlite_query(
        "SELECT c.id, c.name, c.discount_group_id, c.contract_start_date,
                dg.name as group_name
         FROM customers c
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         $status_filter
         ORDER BY c.name"
    );

    if (empty($customers)) {
        $result["errors"][] = "No customers found";
        return $result;
    }

    // Get all services
    $services = get_all_services();
    if (empty($services)) {
        $result["errors"][] = "No services defined";
        return $result;
    }

    // Get all transaction types (needed for EFX_code -> type mapping)
    $transaction_types = get_all_transaction_types();
    $efx_to_type = [];
    foreach ($transaction_types as $tt) {
        $efx_to_type[$tt["efx_code"]] = $tt["type"];
    }

    // Build CSV header
    $header = [
        "cust_id",
        "discount_group",
        "start_date",
        "end_date",
        "EFX_code",
        "type",
        "start_trans",
        "end_trans",
        "adj_price",
        "base_price",
        "by_hit",
        "zero_null",
        "bav_by_trans",
    ];
    $csv_lines = [implode(",", $header)];

    // Calculate far future end date (100 years = indefinite)
    $far_future = date("Y-m-d", strtotime("+100 years"));

    foreach ($customers as $customer) {
        $cust_id = $customer["id"];
        $group_name = $customer["group_name"] ? $customer["group_name"] : "";
        $group_id = $customer["discount_group_id"];
        $contract_start = $customer["contract_start_date"]
            ? $customer["contract_start_date"]
            : $as_of_date;

        foreach ($services as $service) {
            $service_id = $service["id"];

            // Get effective tiers for this customer+service (with inheritance)
            $tiers = get_effective_customer_tiers($cust_id, $service_id);

            if (empty($tiers)) {
                continue; // No pricing defined for this service
            }

            // Get EFX codes for this service from transaction_types
            $service_efx_codes = sqlite_query(
                "SELECT DISTINCT efx_code FROM transaction_types WHERE service_id = ?",
                [$service_id]
            );

            // If no mapped EFX codes, use service name as EFX code placeholder
            if (empty($service_efx_codes)) {
                $service_efx_codes = [
                    ["efx_code" => strtoupper($service["name"])],
                ];
            }

            foreach ($service_efx_codes as $efx_row) {
                $efx_code = $efx_row["efx_code"];
                $type = isset($efx_to_type[$efx_code])
                    ? $efx_to_type[$efx_code]
                    : "";

                // Get billing flags with inheritance
                $flags = get_effective_billing_flags(
                    $service_id,
                    $efx_code,
                    $cust_id,
                    $group_id
                );

                foreach ($tiers as $tier) {
                    $base_price = (float) $tier["price_per_inquiry"];

                    // Calculate adjusted price with escalators
                    $adj_price = calculate_escalated_price(
                        $base_price,
                        $cust_id,
                        $as_of_date
                    );

                    $row = [
                        $cust_id,
                        csv_escape($group_name),
                        $contract_start,
                        $far_future,
                        csv_escape($efx_code),
                        csv_escape($type),
                        $tier["volume_start"],
                        $tier["volume_end"] !== null ? $tier["volume_end"] : "",
                        number_format($adj_price, 6, ".", ""),
                        number_format($base_price, 6, ".", ""),
                        $flags["by_hit"] ? 1 : 0,
                        $flags["zero_null"] ? 1 : 0,
                        $flags["bav_by_trans"] ? 1 : 0,
                    ];

                    $result["rows"][] = $row;
                    $csv_lines[] = implode(",", $row);
                }
            }
        }
    }

    $result["csv_content"] = implode("\n", $csv_lines) . "\n";
    $result["row_count"] = count($result["rows"]);

    return $result;
}

/**
 * Escape a value for CSV output
 */
function csv_escape($value)
{
    if ($value === null) {
        return "";
    }
    // Quote if contains comma, quote, or newline
    if (
        strpos($value, ",") !== false ||
        strpos($value, "\"") !== false ||
        strpos($value, "\n") !== false
    ) {
        return "\"" . str_replace("\"", "\"\"", $value) . "\"";
    }
    return $value;
}

// ============================================================
// INGESTION ACTIONS
// ============================================================

/**
 * Billing reports list and upload page
 */
function action_ingestion()
{
    $tab = get_param("tab", "reports");

    // Handle file upload
    if (
        $_SERVER["REQUEST_METHOD"] === "POST" &&
        isset($_FILES["billing_csv"])
    ) {
        $file = $_FILES["billing_csv"];

        if ($file["error"] !== UPLOAD_ERR_OK) {
            set_flash(
                "error",
                "File upload failed: error code " . $file["error"]
            );
            redirect("ingestion");
            return;
        }

        $filename = $file["name"];
        $content = file_get_contents($file["tmp_name"]);

        $import_result = import_billing_report($filename, $content);

        if ($import_result["success"]) {
            set_flash(
                "success",
                "Imported {$import_result["rows_imported"]} rows from $filename"
            );
        } else {
            set_flash(
                "error",
                "Import failed: " . implode(", ", $import_result["errors"])
            );
        }

        redirect("ingestion");
        return;
    }

    // Handle import from drive (single file)
    if (get_param("import_file")) {
        $filename = basename(get_param("import_file"));
        $filepath = get_archive_path() . "/" . $filename;

        if (file_exists($filepath)) {
            $content = file_get_contents($filepath);
            $import_result = import_billing_report($filename, $content);

            if ($import_result["success"]) {
                set_flash(
                    "success",
                    "Imported {$import_result["rows_imported"]} rows from $filename"
                );
            } else {
                set_flash(
                    "error",
                    "Import failed: " . implode(", ", $import_result["errors"])
                );
            }
        } else {
            set_flash("error", "File not found: $filename");
        }

        redirect("ingestion", ["tab" => "drive"]);
        return;
    }

    // Handle bulk import from drive (selected files)
    if ($_SERVER["REQUEST_METHOD"] === "POST" && get_param("bulk_import")) {
        $selected = isset($_POST["selected_files"]) ? $_POST["selected_files"] : [];
        $success_count = 0;
        $error_count = 0;

        foreach ($selected as $filename) {
            $filename = basename($filename);
            $filepath = get_archive_path() . "/" . $filename;

            if (file_exists($filepath)) {
                $content = file_get_contents($filepath);
                $import_result = import_billing_report($filename, $content);

                if ($import_result["success"]) {
                    $success_count++;
                } else {
                    $error_count++;
                }
            }
        }

        if ($success_count > 0 && $error_count === 0) {
            set_flash("success", "Successfully imported $success_count files");
        } elseif ($success_count > 0) {
            set_flash("warning", "Imported $success_count files, $error_count failed");
        } else {
            set_flash("error", "All imports failed");
        }

        redirect("ingestion", ["tab" => "drive"]);
        return;
    }

    // Handle delete
    if (get_param("delete")) {
        $report_id = (int) get_param("delete");
        delete_billing_report($report_id);
        set_flash("success", "Report deleted");
        redirect("ingestion");
        return;
    }

    // Get reports already imported
    $reports = get_billing_reports();

    // Get already imported filenames to mark them
    $imported_files = [];
    foreach ($reports as $r) {
        if (!empty($r["file_path"])) {
            $imported_files[] = $r["file_path"];
        }
    }

    // Get files available on drive (archive directory)
    $drive_files = [];
    $archive_path = get_archive_path();
    if (is_dir($archive_path)) {
        $files = glob($archive_path . "/DataX_*.csv");
        foreach ($files as $file) {
            $filename = basename($file);
            $drive_files[] = [
                "filename" => $filename,
                "path" => $file,
                "size" => filesize($file),
                "modified" => filemtime($file),
                "imported" => in_array($filename, $imported_files),
            ];
        }
        // Sort by filename descending (newest first)
        usort($drive_files, function($a, $b) {
            return strcmp($b["filename"], $a["filename"]);
        });
    }

    // Get summary stats
    $stats = sqlite_query(
        "SELECT
            COUNT(*) as total_reports,
            SUM(record_count) as total_rows,
            MIN(report_date) as earliest,
            MAX(report_date) as latest
         FROM billing_reports"
    );

    $data = [
        "reports" => $reports,
        "drive_files" => $drive_files,
        "stats" => !empty($stats) ? $stats[0] : [],
        "tab" => $tab,
    ];

    render_ingestion($data);
}

/**
 * View a specific billing report
 */
function action_ingestion_view()
{
    $report_id = (int) get_param("id");

    if (!$report_id) {
        set_flash("error", "No report specified");
        redirect("ingestion");
        return;
    }

    $reports = sqlite_query("SELECT * FROM billing_reports WHERE id = ?", [
        $report_id,
    ]);
    if (empty($reports)) {
        set_flash("error", "Report not found");
        redirect("ingestion");
        return;
    }

    $report = $reports[0];
    $lines = get_billing_report_lines($report_id);

    // Get summary by customer
    $customer_summary = sqlite_query(
        "SELECT
            customer_id,
            customer_name,
            SUM(count) as total_count,
            SUM(revenue) as total_revenue,
            COUNT(*) as line_count
         FROM billing_report_lines
         WHERE report_id = ?
         GROUP BY customer_id, customer_name
         ORDER BY total_revenue DESC",
        [$report_id]
    );

    $data = [
        "report" => $report,
        "lines" => $lines,
        "customer_summary" => $customer_summary,
    ];

    render_ingestion_view($data);
}

/**
 * Bulk import page for historical seeding
 */
function action_ingestion_bulk()
{
    $results = [];

    // Handle bulk file upload
    if (
        $_SERVER["REQUEST_METHOD"] === "POST" &&
        isset($_FILES["billing_csvs"])
    ) {
        $files = $_FILES["billing_csvs"];
        $success_count = 0;
        $error_count = 0;

        // Normalize files array (PHP uploads multiple files in a weird structure)
        $file_count = count($files["name"]);

        for ($i = 0; $i < $file_count; $i++) {
            if ($files["error"][$i] !== UPLOAD_ERR_OK) {
                $results[] = [
                    "filename" => $files["name"][$i],
                    "success" => false,
                    "message" => "Upload error: " . $files["error"][$i],
                ];
                $error_count++;
                continue;
            }

            $filename = $files["name"][$i];
            $content = file_get_contents($files["tmp_name"][$i]);

            $import_result = import_billing_report($filename, $content);

            if ($import_result["success"]) {
                $results[] = [
                    "filename" => $filename,
                    "success" => true,
                    "message" => "Imported {$import_result["rows_imported"]} rows",
                    "report_id" => $import_result["report_id"],
                ];
                $success_count++;
            } else {
                $results[] = [
                    "filename" => $filename,
                    "success" => false,
                    "message" => implode(", ", $import_result["errors"]),
                ];
                $error_count++;
            }
        }

        if ($success_count > 0 && $error_count === 0) {
            set_flash(
                "success",
                "Successfully imported all $success_count files"
            );
        } elseif ($success_count > 0) {
            set_flash(
                "warning",
                "Imported $success_count files, $error_count failed"
            );
        } else {
            set_flash("error", "All $error_count files failed to import");
        }
    }

    // Handle directory scan (for files already on server)
    if (get_param("scan_dir")) {
        $scan_path = get_shared_path() . "/archive";
        if (is_dir($scan_path)) {
            $csv_files = glob($scan_path . "/*.csv");
            $results = [];

            foreach ($csv_files as $file_path) {
                $filename = basename($file_path);

                // Check if already imported
                $existing = sqlite_query(
                    "SELECT id FROM billing_reports WHERE file_path = ?",
                    [$filename]
                );

                if (!empty($existing)) {
                    $results[] = [
                        "filename" => $filename,
                        "success" => false,
                        "message" => "Already imported",
                        "skipped" => true,
                    ];
                    continue;
                }

                $content = file_get_contents($file_path);
                $import_result = import_billing_report($filename, $content);

                if ($import_result["success"]) {
                    $results[] = [
                        "filename" => $filename,
                        "success" => true,
                        "message" => "Imported {$import_result["rows_imported"]} rows",
                        "report_id" => $import_result["report_id"],
                    ];
                } else {
                    $results[] = [
                        "filename" => $filename,
                        "success" => false,
                        "message" => implode(", ", $import_result["errors"]),
                    ];
                }
            }

            $success = count(
                array_filter($results, function ($r) {
                    return $r["success"];
                })
            );
            $skipped = count(
                array_filter($results, function ($r) {
                    return isset($r["skipped"]) && $r["skipped"];
                })
            );
            $failed = count($results) - $success - $skipped;

            set_flash(
                "info",
                "Scanned directory: $success imported, $skipped already existed, $failed failed"
            );
        } else {
            set_flash("error", "Archive directory not found: $scan_path");
        }
    }

    // Get stats
    $stats = sqlite_query(
        "SELECT
            COUNT(*) as total_reports,
            SUM(record_count) as total_rows,
            MIN(report_date) as earliest,
            MAX(report_date) as latest,
            SUM(CASE WHEN report_type = 'monthly' THEN 1 ELSE 0 END) as monthly_count,
            SUM(CASE WHEN report_type = 'daily' THEN 1 ELSE 0 END) as daily_count
         FROM billing_reports"
    );

    $data = [
        "results" => $results,
        "stats" => !empty($stats) ? $stats[0] : [],
        "archive_path" => get_shared_path() . "/archive",
    ];

    render_ingestion_bulk($data);
}

// ============================================================
// GENERATION ACTIONS (tier_pricing.csv)
// ============================================================

/**
 * Generation page - preview and download tier_pricing.csv
 */
function action_generation()
{
    $tab = get_param("tab", "generate");

    // Handle CSV download
    if (get_param("download") === "1") {
        $options = [
            "as_of_date" => get_param("as_of_date", date("Y-m-d")),
            "include_inactive" => get_param("include_inactive") === "1",
        ];

        $customer_ids = get_param("customer_ids");
        if (!empty($customer_ids)) {
            $options["customer_ids"] = explode(",", $customer_ids);
        }

        $result = generate_tier_pricing_csv($options);

        if (!empty($result["errors"])) {
            set_flash("error", implode(", ", $result["errors"]));
            redirect("generation");
            return;
        }

        // Send as download
        $filename = "tier_pricing_" . date("Ymd_His") . ".csv";
        header("Content-Type: text/csv");
        header(
            "Content-Disposition: attachment; filename=\"" . $filename . "\""
        );
        header("Content-Length: " . strlen($result["csv_content"]));
        echo $result["csv_content"];
        exit();
    }

    // Handle save to pending
    if (
        $_SERVER["REQUEST_METHOD"] === "POST" &&
        get_param("action") === "save_pending"
    ) {
        $options = [
            "as_of_date" => get_param("as_of_date", date("Y-m-d")),
            "include_inactive" => get_param("include_inactive") === "1",
        ];

        $result = generate_tier_pricing_csv($options);

        if (!empty($result["errors"])) {
            set_flash("error", implode(", ", $result["errors"]));
            redirect("generation");
            return;
        }

        // Save to pending directory
        $filename = "tier_pricing_" . date("Ymd_His") . ".csv";
        $pending_path = get_shared_path() . "/pending";

        if (!is_dir($pending_path)) {
            mkdir($pending_path, 0755, true);
        }

        $file_path = $pending_path . "/" . $filename;
        if (file_put_contents($file_path, $result["csv_content"])) {
            set_flash(
                "success",
                "Generated $filename with {$result["row_count"]} rows and saved to pending directory"
            );
        } else {
            set_flash("error", "Failed to write file to pending directory");
        }

        redirect("generation");
        return;
    }

    // Get preview data
    $preview = null;
    if (get_param("preview") === "1" || $_SERVER["REQUEST_METHOD"] === "POST") {
        $options = [
            "as_of_date" => get_param("as_of_date", date("Y-m-d")),
            "include_inactive" => get_param("include_inactive") === "1",
        ];

        $customer_ids = get_param("customer_ids");
        if (!empty($customer_ids)) {
            $options["customer_ids"] = is_array($customer_ids)
                ? $customer_ids
                : explode(",", $customer_ids);
        }

        $preview = generate_tier_pricing_csv($options);
    }

    // Get counts for info display
    $active_customers = sqlite_query(
        "SELECT COUNT(*) as cnt FROM customers WHERE status = 'active'"
    );
    $services_count = sqlite_query("SELECT COUNT(*) as cnt FROM services");
    $transaction_types_count = sqlite_query(
        "SELECT COUNT(*) as cnt FROM transaction_types"
    );

    // Get recent generations (from pending directory)
    $pending_files = [];
    $pending_path = get_shared_path() . "/pending";
    if (is_dir($pending_path)) {
        $files = glob($pending_path . "/tier_pricing_*.csv");
        foreach ($files as $file) {
            $pending_files[] = [
                "filename" => basename($file),
                "size" => filesize($file),
                "modified" => filemtime($file),
            ];
        }
        // Sort by modified time descending
        usort($pending_files, function ($a, $b) {
            return $b["modified"] - $a["modified"];
        });
        $pending_files = array_slice($pending_files, 0, 10);
    }

    $data = [
        "tab" => $tab,
        "preview" => $preview,
        "active_customers" => !empty($active_customers)
            ? $active_customers[0]["cnt"]
            : 0,
        "services_count" => !empty($services_count)
            ? $services_count[0]["cnt"]
            : 0,
        "transaction_types_count" => !empty($transaction_types_count)
            ? $transaction_types_count[0]["cnt"]
            : 0,
        "pending_files" => $pending_files,
        "as_of_date" => get_param("as_of_date", date("Y-m-d")),
        "include_inactive" => get_param("include_inactive") === "1",
    ];

    render_generation($data);
}

/**
 * Transaction types management
 */
function action_generation_types()
{
    // Handle CSV import
    if ($_SERVER["REQUEST_METHOD"] === "POST" && isset($_FILES["types_csv"])) {
        $file = $_FILES["types_csv"];

        if ($file["error"] !== UPLOAD_ERR_OK) {
            set_flash("error", "File upload failed");
            redirect("generation_types");
            return;
        }

        $content = file_get_contents($file["tmp_name"]);
        $result = import_transaction_types_csv($content);

        if (!empty($result["errors"])) {
            set_flash(
                "warning",
                "Imported {$result["imported"]} types with errors: " .
                    implode(", ", $result["errors"])
            );
        } else {
            set_flash(
                "success",
                "Imported {$result["imported"]} transaction types"
            );
        }

        redirect("generation_types");
        return;
    }

    // Handle single type save
    if (
        $_SERVER["REQUEST_METHOD"] === "POST" &&
        get_param("action") === "save_type"
    ) {
        $type = get_param("type");
        $display_name = get_param("display_name");
        $efx_code = get_param("efx_code");
        $efx_displayname = get_param("efx_displayname");
        $service_id = get_param("service_id")
            ? (int) get_param("service_id")
            : null;

        if (empty($type) || empty($display_name) || empty($efx_code)) {
            set_flash("error", "Type, display name, and EFX code are required");
            redirect("generation_types");
            return;
        }

        save_transaction_type(
            $type,
            $display_name,
            $efx_code,
            $efx_displayname,
            $service_id
        );
        set_flash("success", "Transaction type saved");
        redirect("generation_types");
        return;
    }

    // Handle delete
    if (get_param("delete")) {
        $id = (int) get_param("delete");
        sqlite_execute("DELETE FROM transaction_types WHERE id = ?", [$id]);
        set_flash("success", "Transaction type deleted");
        redirect("generation_types");
        return;
    }

    $types = get_all_transaction_types();
    $services = get_all_services();

    // Group by type for display
    $types_by_category = [];
    foreach ($types as $t) {
        $cat = $t["type"] ? $t["type"] : "Uncategorized";
        if (!isset($types_by_category[$cat])) {
            $types_by_category[$cat] = [];
        }
        $types_by_category[$cat][] = $t;
    }

    $data = [
        "types" => $types,
        "types_by_category" => $types_by_category,
        "services" => $services,
        "type_count" => count($types),
    ];

    render_generation_types($data);
}

/**
 * Billing flags management (by_hit, zero_null, bav_by_trans)
 */
function action_billing_flags()
{
    $level = get_param("level", "default");
    $level_id = get_param("level_id");

    // Handle POST - save flags
    if (
        $_SERVER["REQUEST_METHOD"] === "POST" &&
        get_param("action") === "save_flags"
    ) {
        $service_id = (int) get_param("service_id");
        $efx_code = get_param("efx_code");
        $by_hit = get_param("by_hit") ? 1 : 0;
        $zero_null = get_param("zero_null") ? 1 : 0;
        $bav_by_trans = get_param("bav_by_trans") ? 1 : 0;

        if (empty($service_id) || empty($efx_code)) {
            set_flash("error", "Service and EFX code are required");
            redirect(
                "billing_flags&level=$level" .
                    ($level_id ? "&level_id=$level_id" : "")
            );
            return;
        }

        save_billing_flags(
            $level,
            $level === "default" ? null : (int) $level_id,
            $service_id,
            $efx_code,
            $by_hit,
            $zero_null,
            $bav_by_trans
        );

        set_flash("success", "Billing flags saved");
        redirect(
            "billing_flags&level=$level" .
                ($level_id ? "&level_id=$level_id" : "")
        );
        return;
    }

    // Handle clear override
    if (get_param("clear")) {
        $flag_id = (int) get_param("clear");
        sqlite_execute("DELETE FROM service_billing_flags WHERE id = ?", [
            $flag_id,
        ]);
        set_flash("success", "Override cleared");
        redirect(
            "billing_flags&level=$level" .
                ($level_id ? "&level_id=$level_id" : "")
        );
        return;
    }

    // Get all services and transaction types
    $services = get_all_services();
    $transaction_types = get_all_transaction_types();

    // Get current flags for this level
    $level_id_cond =
        $level === "default"
            ? "level_id IS NULL"
            : "level_id = " . (int) $level_id;
    $current_flags = sqlite_query(
        "SELECT sbf.*, s.name as service_name
         FROM service_billing_flags sbf
         LEFT JOIN services s ON sbf.service_id = s.id
         WHERE sbf.level = ? AND $level_id_cond
         ORDER BY sbf.service_id, sbf.efx_code, sbf.effective_date DESC",
        [$level]
    );

    // Group by service+efx_code and get only current (latest)
    $flags_by_key = [];
    foreach ($current_flags as $flag) {
        $key = $flag["service_id"] . "_" . $flag["efx_code"];
        if (!isset($flags_by_key[$key])) {
            $flags_by_key[$key] = $flag;
        }
    }

    // Get groups and customers for level selector
    $groups = sqlite_query(
        "SELECT id, name FROM discount_groups ORDER BY name"
    );
    $customers = sqlite_query(
        "SELECT id, name FROM customers WHERE status = 'active' ORDER BY name"
    );

    // Get level entity info
    $level_entity = null;
    if ($level === "group" && $level_id) {
        $result = sqlite_query("SELECT * FROM discount_groups WHERE id = ?", [
            $level_id,
        ]);
        $level_entity = !empty($result) ? $result[0] : null;
    } elseif ($level === "customer" && $level_id) {
        $result = sqlite_query("SELECT * FROM customers WHERE id = ?", [
            $level_id,
        ]);
        $level_entity = !empty($result) ? $result[0] : null;
    }

    $data = [
        "level" => $level,
        "level_id" => $level_id,
        "level_entity" => $level_entity,
        "services" => $services,
        "transaction_types" => $transaction_types,
        "current_flags" => array_values($flags_by_key),
        "groups" => $groups,
        "customers" => $customers,
    ];

    render_billing_flags($data);
}

// ============================================================
// LMS ACTIONS
// ============================================================

/**
 * List all LMS entries
 */
function action_lms()
{
    $page = (int) get_param("page", 1);
    $search = get_param("search", "");

    // Handle sync request
    if (get_param("sync") === "1") {
        $count = sync_lms_from_remote();
        set_flash("success", "Synced $count LMS entries from remote database");
        redirect("lms");
        return;
    }

    $all_lms = get_all_lms();
    $default_rate = get_default_commission_rate();

    // Filter by search
    if (!empty($search)) {
        $all_lms = array_filter($all_lms, function($lms) use ($search) {
            return stripos($lms["name"], $search) !== false;
        });
        $all_lms = array_values($all_lms);
    }

    // Add customer counts and effective rates
    foreach ($all_lms as &$lms) {
        $customers = get_customers_by_lms($lms["id"]);
        $lms["customer_count"] = count($customers);
        $lms["effective_rate"] =
            $lms["commission_rate"] !== null
                ? (float) $lms["commission_rate"]
                : $default_rate;
        $lms["is_inherited"] = $lms["commission_rate"] === null;
    }

    // Paginate
    $total_count = count($all_lms);
    $pagination = paginate($total_count, $page);
    $offset = ($page - 1) * ITEMS_PER_PAGE;
    $all_lms = array_slice($all_lms, $offset, ITEMS_PER_PAGE);

    // Get customers without LMS
    $unassigned = get_customers_without_lms();

    $data = [
        "lms_list" => $all_lms,
        "unassigned_customers" => $unassigned,
        "default_rate" => $default_rate,
        "pagination" => $pagination,
        "search" => $search,
    ];

    render_lms($data);
}

/**
 * Edit LMS commission rate
 */
function action_lms_edit()
{
    $lms_id = get_param("lms_id");

    if (empty($lms_id)) {
        set_flash("error", "No LMS specified");
        redirect("lms");
        return;
    }

    $lms = get_lms($lms_id);
    if (!$lms) {
        set_flash("error", "LMS not found");
        redirect("lms");
        return;
    }

    // Handle POST
    if ($_SERVER["REQUEST_METHOD"] === "POST") {
        $use_default = get_param("use_default") === "1";
        $commission_rate = $use_default
            ? null
            : (float) get_param("commission_rate");

        save_lms($lms["id"], $lms["name"], $commission_rate);
        set_flash("success", "Commission rate saved for " . $lms["name"]);
        redirect("lms_edit", ["lms_id" => $lms_id]);
        return;
    }

    $default_rate = get_default_commission_rate();
    $customers = get_customers_by_lms($lms_id);

    $data = [
        "lms" => $lms,
        "customers" => $customers,
        "default_rate" => $default_rate,
        "effective_rate" =>
            $lms["commission_rate"] !== null
                ? (float) $lms["commission_rate"]
                : $default_rate,
    ];

    render_lms_edit($data);
}

/**
 * System settings (default commission rate)
 */
function action_lms_settings()
{
    // Handle POST
    if ($_SERVER["REQUEST_METHOD"] === "POST") {
        $default_rate = (float) get_param("default_commission_rate");
        save_default_commission_rate($default_rate);
        set_flash("success", "Default commission rate saved");
        redirect("lms_settings");
        return;
    }

    // Handle COGS sync
    if (get_param("sync_cogs") === "1") {
        $count = sync_cogs_from_remote();
        set_flash("success", "Synced COGS for $count services");
        redirect("lms_settings");
        return;
    }

    $default_rate = get_default_commission_rate();
    $services = get_all_services();

    // Add COGS to each service
    foreach ($services as &$service) {
        $service["cogs_rate"] = get_service_cogs($service["id"]);
    }

    $data = [
        "default_rate" => $default_rate,
        "services" => $services,
    ];

    render_lms_settings($data);
}

/**
 * LMS Revenue Report - shows revenue, cost, profit per LMS
 */
function action_lms_report()
{
    $year = (int) get_param("year", date("Y"));
    $month = (int) get_param("month", date("n"));

    // Get all LMS with their customers
    $all_lms = get_all_lms();
    $default_rate = get_default_commission_rate();

    $lms_data = [];
    $grand_totals = [
        "revenue" => 0,
        "cogs" => 0,
        "profit" => 0,
        "commission" => 0,
        "customer_count" => 0,
    ];

    foreach ($all_lms as $lms) {
        $customers = get_customers_by_lms($lms["id"]);
        $effective_rate =
            $lms["commission_rate"] !== null
                ? (float) $lms["commission_rate"]
                : $default_rate;

        $lms_totals = [
            "id" => $lms["id"],
            "name" => $lms["name"],
            "commission_rate" => $effective_rate,
            "is_inherited" => $lms["commission_rate"] === null,
            "customers" => [],
            "revenue" => 0,
            "cogs" => 0,
            "profit" => 0,
            "commission" => 0,
        ];

        foreach ($customers as $customer) {
            // Get billing data for this customer for the period
            $billing = sqlite_query(
                "SELECT SUM(revenue) as total_revenue, SUM(count) as total_count
                 FROM billing_report_lines
                 WHERE customer_id = ? AND year = ? AND month = ?",
                [$customer["id"], $year, $month]
            );

            $customer_revenue =
                !empty($billing) && $billing[0]["total_revenue"]
                    ? (float) $billing[0]["total_revenue"]
                    : 0;
            $customer_count =
                !empty($billing) && $billing[0]["total_count"]
                    ? (int) $billing[0]["total_count"]
                    : 0;

            // Calculate COGS (simplified - using average COGS across services)
            // In production, this would be calculated per-service from billing_report_lines
            $services = get_all_services();
            $avg_cogs = 0;
            $cogs_count = 0;
            foreach ($services as $service) {
                $cogs = get_service_cogs($service["id"]);
                if ($cogs > 0) {
                    $avg_cogs += $cogs;
                    $cogs_count++;
                }
            }
            $avg_cogs = $cogs_count > 0 ? $avg_cogs / $cogs_count : 0;
            $customer_cogs = $avg_cogs * $customer_count;

            $customer_profit = $customer_revenue - $customer_cogs;
            $customer_commission = $customer_profit * ($effective_rate / 100);

            $lms_totals["customers"][] = [
                "id" => $customer["id"],
                "name" => $customer["name"],
                "status" => $customer["status"],
                "revenue" => $customer_revenue,
                "cogs" => $customer_cogs,
                "profit" => $customer_profit,
                "commission" => $customer_commission,
                "count" => $customer_count,
            ];

            $lms_totals["revenue"] += $customer_revenue;
            $lms_totals["cogs"] += $customer_cogs;
            $lms_totals["profit"] += $customer_profit;
            $lms_totals["commission"] += $customer_commission;
        }

        $lms_data[] = $lms_totals;

        $grand_totals["revenue"] += $lms_totals["revenue"];
        $grand_totals["cogs"] += $lms_totals["cogs"];
        $grand_totals["profit"] += $lms_totals["profit"];
        $grand_totals["commission"] += $lms_totals["commission"];
        $grand_totals["customer_count"] += count($customers);
    }

    $data = [
        "lms_data" => $lms_data,
        "grand_totals" => $grand_totals,
        "year" => $year,
        "month" => $month,
        "default_rate" => $default_rate,
    ];

    render_lms_report($data);
}

/**
 * Monthly minimums overview - list all customers with minimums configured
 */
function action_minimums()
{
    $page = (int) get_param("page", 1);

    // Get all customers with monthly minimums
    $customers_with_minimums = sqlite_query(
        "SELECT c.id, c.name, c.status, dg.name as group_name,
                cs.monthly_minimum, cs.effective_date
         FROM customers c
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         LEFT JOIN customer_settings cs ON c.id = cs.customer_id
         WHERE cs.monthly_minimum IS NOT NULL AND cs.monthly_minimum > 0
         ORDER BY c.name"
    );

    // Get summary stats
    $stats = sqlite_query(
        "SELECT COUNT(*) as count, SUM(monthly_minimum) as total_minimums, AVG(monthly_minimum) as avg_minimum
         FROM customer_settings
         WHERE monthly_minimum IS NOT NULL AND monthly_minimum > 0"
    );

    $pagination = paginate(count($customers_with_minimums), $page);

    $data = [
        "customers" => $customers_with_minimums,
        "stats" => !empty($stats) ? $stats[0] : ["count" => 0, "total_minimums" => 0, "avg_minimum" => 0],
        "pagination" => $pagination,
    ];

    render_minimums($data);
}

/**
 * Annualized tiers overview - list all customers using annualized pricing
 */
function action_annualized()
{
    $page = (int) get_param("page", 1);

    // Get all customers with annualized tiers enabled
    $customers_annualized = sqlite_query(
        "SELECT c.id, c.name, c.status, dg.name as group_name,
                cs.uses_annualized, cs.annualized_start_date, cs.look_period_months, cs.effective_date
         FROM customers c
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         LEFT JOIN customer_settings cs ON c.id = cs.customer_id
         WHERE cs.uses_annualized = 1
         ORDER BY c.name"
    );

    // Calculate next reset date for each customer
    $today = date("Y-m-d");
    foreach ($customers_annualized as &$customer) {
        if (!empty($customer["annualized_start_date"])) {
            $start_md = substr($customer["annualized_start_date"], 5); // MM-DD
            $this_year_reset = date("Y") . "-" . $start_md;
            $next_year_reset = (date("Y") + 1) . "-" . $start_md;
            $customer["next_reset"] = $this_year_reset > $today ? $this_year_reset : $next_year_reset;
        } else {
            $customer["next_reset"] = null;
        }
    }

    // Get summary stats
    $stats = sqlite_query(
        "SELECT COUNT(*) as count
         FROM customer_settings
         WHERE uses_annualized = 1"
    );

    // Get upcoming resets (next 30 days)
    $upcoming_resets = get_upcoming_annualized_resets(30);

    $pagination = paginate(count($customers_annualized), $page);

    $data = [
        "customers" => $customers_annualized,
        "stats" => !empty($stats) ? $stats[0] : ["count" => 0],
        "upcoming_resets" => $upcoming_resets,
        "pagination" => $pagination,
    ];

    render_annualized($data);
}

/**
 * Customer pricing view - shows effective pricing with source color-coding
 */
function action_customer_pricing()
{
    $customer_id = get_param("id");

    if (empty($customer_id)) {
        set_flash("error", "No customer specified");
        redirect("pricing_customers");
        return;
    }

    // Get customer info
    $customer = sqlite_query(
        "SELECT c.*, dg.name as group_name
         FROM customers c
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         WHERE c.id = ?",
        [$customer_id]
    );

    if (empty($customer)) {
        set_flash("error", "Customer not found");
        redirect("pricing_customers");
        return;
    }
    $customer = $customer[0];

    // Get all services
    $services = get_all_services();

    // Build pricing data for each service
    $pricing_data = [];
    foreach ($services as $service) {
        $service_id = $service["id"];

        // Get tiers from each level
        $default_tiers = get_current_default_tiers($service_id);
        $group_tiers = [];
        $customer_tiers = get_current_customer_tiers($customer_id, $service_id);

        if ($customer["discount_group_id"]) {
            $group_tiers = get_current_group_tiers($customer["discount_group_id"], $service_id);
        }

        // Build effective tiers with source tracking
        $effective_tiers = [];

        // Start with defaults as base
        foreach ($default_tiers as $tier) {
            $key = $tier["volume_start"] . "-" . ($tier["volume_end"] ?: "unlimited");
            $effective_tiers[$key] = [
                "volume_start" => $tier["volume_start"],
                "volume_end" => $tier["volume_end"],
                "price" => $tier["price_per_inquiry"],
                "source" => "default",
                "default_price" => $tier["price_per_inquiry"],
                "group_price" => null,
                "customer_price" => null,
            ];
        }

        // Overlay group tiers
        foreach ($group_tiers as $tier) {
            $key = $tier["volume_start"] . "-" . ($tier["volume_end"] ?: "unlimited");
            if (isset($effective_tiers[$key])) {
                $effective_tiers[$key]["price"] = $tier["price_per_inquiry"];
                $effective_tiers[$key]["source"] = "group";
                $effective_tiers[$key]["group_price"] = $tier["price_per_inquiry"];
            } else {
                // Group added a tier not in defaults
                $effective_tiers[$key] = [
                    "volume_start" => $tier["volume_start"],
                    "volume_end" => $tier["volume_end"],
                    "price" => $tier["price_per_inquiry"],
                    "source" => "group",
                    "default_price" => null,
                    "group_price" => $tier["price_per_inquiry"],
                    "customer_price" => null,
                ];
            }
        }

        // Overlay customer tiers
        foreach ($customer_tiers as $tier) {
            $key = $tier["volume_start"] . "-" . ($tier["volume_end"] ?: "unlimited");
            if (isset($effective_tiers[$key])) {
                $effective_tiers[$key]["price"] = $tier["price_per_inquiry"];
                $effective_tiers[$key]["source"] = "customer";
                $effective_tiers[$key]["customer_price"] = $tier["price_per_inquiry"];
            } else {
                // Customer added a tier
                $effective_tiers[$key] = [
                    "volume_start" => $tier["volume_start"],
                    "volume_end" => $tier["volume_end"],
                    "price" => $tier["price_per_inquiry"],
                    "source" => "customer",
                    "default_price" => null,
                    "group_price" => null,
                    "customer_price" => $tier["price_per_inquiry"],
                ];
            }
        }

        // Sort by volume_start
        usort($effective_tiers, function($a, $b) {
            return $a["volume_start"] - $b["volume_start"];
        });

        // Determine overall service source (for summary)
        $has_customer_override = !empty($customer_tiers);
        $has_group_override = !empty($group_tiers);

        $pricing_data[] = [
            "service" => $service,
            "tiers" => $effective_tiers,
            "has_customer_override" => $has_customer_override,
            "has_group_override" => $has_group_override,
            "tier_count" => count($effective_tiers),
        ];
    }

    // Get customer settings
    $settings = get_current_customer_settings($customer_id);

    // Get escalators
    $escalators = get_current_escalators($customer_id);
    $total_delay = get_total_delay_months($customer_id);

    // Summary counts
    $summary = [
        "total_services" => count($services),
        "customer_overrides" => 0,
        "group_overrides" => 0,
        "using_defaults" => 0,
    ];

    foreach ($pricing_data as $pd) {
        if ($pd["has_customer_override"]) {
            $summary["customer_overrides"]++;
        } elseif ($pd["has_group_override"]) {
            $summary["group_overrides"]++;
        } else {
            $summary["using_defaults"]++;
        }
    }

    $data = [
        "customer" => $customer,
        "pricing_data" => $pricing_data,
        "settings" => $settings,
        "escalators" => $escalators,
        "total_delay" => $total_delay,
        "summary" => $summary,
    ];

    render_customer_pricing($data);
}

/**
 * List customers with escalators
 */
function action_escalators()
{
    $page = (int) get_param("page", 1);
    $search = get_param("search", "");

    $where = [];
    $params = [];

    if (!empty($search)) {
        $where[] = "(c.name LIKE ? OR dg.name LIKE ?)";
        $params[] = "%$search%";
        $params[] = "%$search%";
    }

    $where_str = !empty($where) ? "AND " . implode(" AND ", $where) : "";

    // Get customers that have escalators
    $total_query = "SELECT COUNT(DISTINCT c.id) as cnt FROM customers c
         INNER JOIN customer_escalators ce ON c.id = ce.customer_id
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         WHERE 1=1 $where_str";
    $total = sqlite_query($total_query, $params);
    $total_count = $total[0]["cnt"];

    $pagination = paginate($total_count, $page);
    $offset = ($page - 1) * ITEMS_PER_PAGE;

    // Get customers with escalators
    $query_params = $params;
    $query_params[] = ITEMS_PER_PAGE;
    $query_params[] = $offset;

    $customers = sqlite_query(
        "SELECT DISTINCT c.*, dg.name as group_name
         FROM customers c
         INNER JOIN customer_escalators ce ON c.id = ce.customer_id
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         WHERE 1=1 $where_str
         ORDER BY c.name
         LIMIT ? OFFSET ?",
        $query_params
    );

    // Get escalator counts for each customer
    foreach ($customers as &$customer) {
        $escalators = get_current_escalators($customer["id"]);
        $customer["escalator_count"] = count($escalators);

        // Get next escalator info
        if (!empty($escalators)) {
            $customer["start_date"] = $escalators[0]["escalator_start_date"];
        }
    }

    $data = [
        "customers" => $customers,
        "pagination" => $pagination,
        "search" => $search,
    ];

    render_escalators($data);
}

/**
 * Edit escalators for a customer
 */
function action_escalator_edit()
{
    $customer_id = get_param("customer_id");

    if (empty($customer_id)) {
        set_flash("error", "No customer specified");
        redirect("escalators");
        return;
    }

    // Get customer
    $customers = sqlite_query(
        "SELECT c.*, dg.name as group_name
         FROM customers c
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         WHERE c.id = ?",
        [$customer_id]
    );

    if (empty($customers)) {
        set_flash("error", "Customer not found");
        redirect("escalators");
        return;
    }
    $customer = $customers[0];

    // Handle POST (save escalators)
    if ($_SERVER["REQUEST_METHOD"] === "POST") {
        $escalator_start_date = get_param(
            "escalator_start_date",
            $customer["contract_start_date"]
        );
        $year_numbers = isset($_POST["year_number"])
            ? $_POST["year_number"]
            : [];
        $percentages = isset($_POST["escalator_percentage"])
            ? $_POST["escalator_percentage"]
            : [];
        $fixed_adjustments = isset($_POST["fixed_adjustment"])
            ? $_POST["fixed_adjustment"]
            : [];

        $escalators = [];
        for ($i = 0; $i < count($year_numbers); $i++) {
            if ($year_numbers[$i] !== "") {
                $escalators[] = [
                    "year_number" => (int) $year_numbers[$i],
                    "escalator_percentage" => isset($percentages[$i])
                        ? $percentages[$i]
                        : 0,
                    "fixed_adjustment" => isset($fixed_adjustments[$i])
                        ? $fixed_adjustments[$i]
                        : 0,
                ];
            }
        }

        if (!empty($escalators)) {
            save_escalators($customer_id, $escalators, $escalator_start_date);
            set_flash("success", "Escalators saved for " . $customer["name"]);
            redirect("escalator_edit", ["customer_id" => $customer_id]);
            return;
        } else {
            set_flash("error", "No valid escalators provided");
        }
    }

    // Get current escalators
    $escalators = get_current_escalators($customer_id);

    // Get delays for each year
    $delays = [];
    foreach ($escalators as &$esc) {
        $esc["total_delay"] = get_total_delay_months(
            $customer_id,
            $esc["year_number"]
        );
    }

    $data = [
        "customer" => $customer,
        "escalators" => $escalators,
    ];

    render_escalator_edit($data);
}

/**
 * Apply a delay to an escalator
 */
function action_escalator_delay()
{
    $customer_id = get_param("customer_id");
    $year_number = get_param("year_number");

    if (empty($customer_id) || empty($year_number)) {
        set_flash("error", "Missing customer or year");
        redirect("escalators");
        return;
    }

    apply_escalator_delay($customer_id, $year_number, 1);
    set_flash(
        "success",
        "Escalator for Year " . $year_number . " delayed by 1 month"
    );
    redirect("escalator_edit", ["customer_id" => $customer_id]);
}

// ------------------------------------------------------------
// BUSINESS RULES ACTIONS
// ------------------------------------------------------------

/**
 * Get all business rules for a customer
 */
function get_customer_rules($customer_id)
{
    return sqlite_query(
        "SELECT * FROM business_rules WHERE customer_id = ? ORDER BY rule_name",
        [$customer_id]
    );
}

/**
 * Get current mask status for a rule
 */
function get_rule_mask_status($customer_id, $rule_name)
{
    $mask = sqlite_query(
        "SELECT is_masked FROM business_rule_masks
         WHERE customer_id = ? AND rule_name = ? AND effective_date <= date('now')
         ORDER BY effective_date DESC, id DESC LIMIT 1",
        [$customer_id, $rule_name]
    );

    return !empty($mask) ? (bool) $mask[0]["is_masked"] : false;
}

/**
 * Toggle rule mask status (append new record)
 */
function toggle_rule_mask($customer_id, $rule_name, $is_masked)
{
    sqlite_execute(
        "INSERT INTO business_rule_masks (customer_id, rule_name, is_masked, effective_date)
         VALUES (?, ?, ?, date('now'))",
        [$customer_id, $rule_name, $is_masked ? 1 : 0]
    );
    return true;
}

/**
 * List customers with business rules
 */
function action_business_rules()
{
    $page = (int) get_param("page", 1);
    $search = get_param("search", "");

    $where = [];
    $params = [];

    if (!empty($search)) {
        $where[] = "(c.name LIKE ? OR dg.name LIKE ?)";
        $params[] = "%$search%";
        $params[] = "%$search%";
    }

    $where_str = !empty($where) ? "AND " . implode(" AND ", $where) : "";

    // Get customers that have rules
    $total_query = "SELECT COUNT(DISTINCT c.id) as cnt FROM customers c
         INNER JOIN business_rules br ON c.id = br.customer_id
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         WHERE 1=1 $where_str";
    $total = sqlite_query($total_query, $params);
    $total_count = $total[0]["cnt"];

    $pagination = paginate($total_count, $page);
    $offset = ($page - 1) * ITEMS_PER_PAGE;

    // Get customers with rules
    $query_params = $params;
    $query_params[] = ITEMS_PER_PAGE;
    $query_params[] = $offset;

    $customers = sqlite_query(
        "SELECT DISTINCT c.*, dg.name as group_name
         FROM customers c
         INNER JOIN business_rules br ON c.id = br.customer_id
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         WHERE 1=1 $where_str
         ORDER BY c.name
         LIMIT ? OFFSET ?",
        $query_params
    );

    // Get rule counts for each customer
    foreach ($customers as &$customer) {
        $rules = get_customer_rules($customer["id"]);
        $customer["rule_count"] = count($rules);

        // Count masked rules
        $masked_count = 0;
        foreach ($rules as $rule) {
            if (get_rule_mask_status($customer["id"], $rule["rule_name"])) {
                $masked_count++;
            }
        }
        $customer["masked_count"] = $masked_count;
    }

    $data = [
        "customers" => $customers,
        "pagination" => $pagination,
        "search" => $search,
    ];

    render_business_rules($data);
}

/**
 * View all business rules across all customers
 */
function action_business_rules_all()
{
    $page = (int) get_param("page", 1);
    $filter_masked = get_param("masked");
    $search = get_param("search", "");

    // Build query
    $where = [];
    $params = [];

    if ($filter_masked === "1") {
        $where[] = "EXISTS (SELECT 1 FROM business_rule_masks brm WHERE brm.customer_id = br.customer_id AND brm.rule_name = br.rule_name AND brm.is_masked = 1)";
    } elseif ($filter_masked === "0") {
        $where[] = "NOT EXISTS (SELECT 1 FROM business_rule_masks brm WHERE brm.customer_id = br.customer_id AND brm.rule_name = br.rule_name AND brm.is_masked = 1)";
    }

    if (!empty($search)) {
        $where[] = "(br.rule_name LIKE ? OR c.name LIKE ?)";
        $params[] = "%$search%";
        $params[] = "%$search%";
    }

    $where_clause = !empty($where) ? "WHERE " . implode(" AND ", $where) : "";

    // Get total count
    $count_sql = "SELECT COUNT(*) as cnt FROM business_rules br
                  JOIN customers c ON br.customer_id = c.id
                  $where_clause";
    $total = sqlite_query($count_sql, $params);
    $total_count = $total[0]["cnt"];

    $pagination = paginate($total_count, $page);
    $offset = ($page - 1) * ITEMS_PER_PAGE;

    // Get rules
    $sql = "SELECT br.*, c.name as customer_name, c.status as customer_status
            FROM business_rules br
            JOIN customers c ON br.customer_id = c.id
            $where_clause
            ORDER BY c.name, br.rule_name
            LIMIT ? OFFSET ?";
    $params[] = ITEMS_PER_PAGE;
    $params[] = $offset;

    $rules = sqlite_query($sql, $params);

    // Add mask status
    foreach ($rules as &$rule) {
        $rule["is_masked"] = get_rule_mask_status($rule["customer_id"], $rule["rule_name"]);
    }

    // Get summary stats
    $stats = [
        "total_rules" => sqlite_query("SELECT COUNT(*) as cnt FROM business_rules")[0]["cnt"],
        "masked_rules" => sqlite_query("SELECT COUNT(*) as cnt FROM business_rule_masks WHERE is_masked = 1")[0]["cnt"],
        "customers_with_rules" => sqlite_query("SELECT COUNT(DISTINCT customer_id) as cnt FROM business_rules")[0]["cnt"],
    ];

    $data = [
        "rules" => $rules,
        "pagination" => $pagination,
        "filter_masked" => $filter_masked,
        "search" => $search,
        "stats" => $stats,
    ];

    render_business_rules_all($data);
}

/**
 * View/edit rules for a specific customer
 */
function action_business_rule_edit()
{
    $customer_id = get_param("customer_id");

    if (empty($customer_id)) {
        set_flash("error", "No customer specified");
        redirect("business_rules");
        return;
    }

    // Get customer
    $customers = sqlite_query(
        "SELECT c.*, dg.name as group_name
         FROM customers c
         LEFT JOIN discount_groups dg ON c.discount_group_id = dg.id
         WHERE c.id = ?",
        [$customer_id]
    );

    if (empty($customers)) {
        set_flash("error", "Customer not found");
        redirect("business_rules");
        return;
    }
    $customer = $customers[0];

    // Get rules with mask status
    $rules = get_customer_rules($customer_id);
    foreach ($rules as &$rule) {
        $rule["is_masked"] = get_rule_mask_status(
            $customer_id,
            $rule["rule_name"]
        );
    }

    $data = [
        "customer" => $customer,
        "rules" => $rules,
    ];

    render_business_rule_edit($data);
}

/**
 * Toggle a rule's mask status
 */
function action_business_rule_toggle()
{
    $customer_id = get_param("customer_id");
    $rule_name = get_param("rule");
    if (empty($rule_name)) {
        $rule_name = get_param("rule_name"); // fallback
    }
    $action = get_param("mask_action", "toggle"); // 'mask' or 'unmask'
    $return_to = get_param("return", "edit"); // 'edit' or 'all'

    if (empty($customer_id) || empty($rule_name)) {
        set_flash("error", "Missing customer or rule");
        redirect("business_rules");
        return;
    }

    $current_status = get_rule_mask_status($customer_id, $rule_name);
    $new_status =
        $action === "mask"
            ? true
            : ($action === "unmask"
                ? false
                : !$current_status);

    toggle_rule_mask($customer_id, $rule_name, $new_status);

    $status_label = $new_status ? "masked" : "unmasked";
    set_flash("success", "Rule \"" . $rule_name . "\" is now " . $status_label);

    if ($return_to === "all") {
        redirect("business_rules_all");
    } else {
        redirect("business_rule_edit", ["customer_id" => $customer_id]);
    }
}

// ------------------------------------------------------------
// HISTORY ACTIONS
// ------------------------------------------------------------

/**
 * View audit history
 */
function action_history()
{
    $filter = get_param("filter", "all"); // 'all', 'pricing', 'settings', 'escalators', 'rules'
    $customer_id = get_param("customer_id", "");
    $page = (int) get_param("page", 1);

    $history = [];

    // Pricing tier changes
    if ($filter === "all" || $filter === "pricing") {
        $pricing_history = get_pricing_history($customer_id);
        foreach ($pricing_history as $item) {
            $item["category"] = "pricing";
            $history[] = $item;
        }
    }

    // Customer settings changes
    if ($filter === "all" || $filter === "settings") {
        $settings_history = get_settings_history($customer_id);
        foreach ($settings_history as $item) {
            $item["category"] = "settings";
            $history[] = $item;
        }
    }

    // Escalator changes
    if ($filter === "all" || $filter === "escalators") {
        $escalator_history = get_escalator_history($customer_id);
        foreach ($escalator_history as $item) {
            $item["category"] = "escalators";
            $history[] = $item;
        }
    }

    // Business rule mask changes
    if ($filter === "all" || $filter === "rules") {
        $rule_history = get_rule_mask_history($customer_id);
        foreach ($rule_history as $item) {
            $item["category"] = "rules";
            $history[] = $item;
        }
    }

    // Sort by date descending
    usort($history, function ($a, $b) {
        return strcmp($b["date"], $a["date"]);
    });

    // Paginate
    $total = count($history);
    $pagination = paginate($total, $page);
    $offset = ($page - 1) * ITEMS_PER_PAGE;
    $history = array_slice($history, $offset, ITEMS_PER_PAGE);

    // Get customers for filter dropdown
    $customers = sqlite_query("SELECT id, name FROM customers ORDER BY name");

    $data = [
        "history" => $history,
        "pagination" => $pagination,
        "filter" => $filter,
        "customer_id" => $customer_id,
        "customers" => $customers,
    ];

    render_history($data);
}

/**
 * Get pricing tier change history
 */
function get_pricing_history($customer_id = "")
{
    $results = [];

    $where = "";
    $params = [];

    if ($customer_id) {
        $where = "WHERE (pt.level = 'customer' AND pt.level_id = ?) OR
                  (pt.level = 'group' AND pt.level_id IN (SELECT discount_group_id FROM customers WHERE id = ?))";
        $params = [$customer_id, $customer_id];
    }

    $rows = sqlite_query(
        "SELECT pt.*, s.name as service_name,
                CASE pt.level
                    WHEN 'default' THEN 'System Default'
                    WHEN 'group' THEN (SELECT name FROM discount_groups WHERE id = pt.level_id)
                    WHEN 'customer' THEN (SELECT name FROM customers WHERE id = pt.level_id)
                END as entity_name
         FROM pricing_tiers pt
         LEFT JOIN services s ON pt.service_id = s.id
         $where
         ORDER BY pt.created_at DESC
         LIMIT 100",
        $params
    );

    foreach ($rows as $row) {
        $results[] = [
            "date" => $row["created_at"],
            "effective_date" => $row["effective_date"],
            "description" =>
                $row["level"] .
                " pricing for " .
                $row["service_name"] .
                ($row["entity_name"] ? " (" . $row["entity_name"] . ")" : "") .
                ": $" .
                number_format($row["price_per_inquiry"], 2) .
                " for volume " .
                $row["volume_start"] .
                "-" .
                ($row["volume_end"] ?: "unlimited"),
            "level" => $row["level"],
            "entity_name" => $row["entity_name"],
        ];
    }

    return $results;
}

/**
 * Get customer settings change history
 */
function get_settings_history($customer_id = "")
{
    $results = [];

    $where = $customer_id ? "WHERE cs.customer_id = ?" : "";
    $params = $customer_id ? [$customer_id] : [];

    $rows = sqlite_query(
        "SELECT cs.*, c.name as customer_name
         FROM customer_settings cs
         INNER JOIN customers c ON cs.customer_id = c.id
         $where
         ORDER BY cs.created_at DESC
         LIMIT 100",
        $params
    );

    foreach ($rows as $row) {
        $details = [];
        if ($row["monthly_minimum"]) {
            $details[] = "min $" . number_format($row["monthly_minimum"], 2);
        }
        if ($row["uses_annualized"]) {
            $details[] = "annualized";
        }
        if ($row["look_period_months"]) {
            $details[] = $row["look_period_months"] . " month look";
        }

        $results[] = [
            "date" => $row["created_at"],
            "effective_date" => $row["effective_date"],
            "description" =>
                "Settings for " .
                $row["customer_name"] .
                ": " .
                (!empty($details) ? implode(", ", $details) : "defaults"),
            "customer_name" => $row["customer_name"],
        ];
    }

    return $results;
}

/**
 * Get escalator change history
 */
function get_escalator_history($customer_id = "")
{
    $results = [];

    $where = $customer_id ? "WHERE ce.customer_id = ?" : "";
    $params = $customer_id ? [$customer_id] : [];

    $rows = sqlite_query(
        "SELECT ce.*, c.name as customer_name
         FROM customer_escalators ce
         INNER JOIN customers c ON ce.customer_id = c.id
         $where
         ORDER BY ce.created_at DESC
         LIMIT 100",
        $params
    );

    foreach ($rows as $row) {
        $results[] = [
            "date" => $row["created_at"],
            "effective_date" => $row["effective_date"],
            "description" =>
                "Escalator Year " .
                $row["year_number"] .
                " for " .
                $row["customer_name"] .
                ": " .
                $row["escalator_percentage"] .
                "%" .
                ($row["fixed_adjustment"]
                    ? " + $" . number_format($row["fixed_adjustment"], 2)
                    : ""),
            "customer_name" => $row["customer_name"],
        ];
    }

    // Also get delay history
    $delay_where = $customer_id ? "WHERE ed.customer_id = ?" : "";
    $delay_params = $customer_id ? [$customer_id] : [];

    $delays = sqlite_query(
        "SELECT ed.*, c.name as customer_name
         FROM escalator_delays ed
         INNER JOIN customers c ON ed.customer_id = c.id
         $delay_where
         ORDER BY ed.created_at DESC
         LIMIT 50",
        $delay_params
    );

    foreach ($delays as $row) {
        $results[] = [
            "date" => $row["created_at"],
            "effective_date" => $row["applied_date"],
            "description" =>
                "Delay applied to Year " .
                $row["year_number"] .
                " for " .
                $row["customer_name"] .
                ": +" .
                $row["delay_months"] .
                " month(s)",
            "customer_name" => $row["customer_name"],
        ];
    }

    return $results;
}

/**
 * Get business rule mask change history
 */
function get_rule_mask_history($customer_id = "")
{
    $results = [];

    $where = $customer_id ? "WHERE brm.customer_id = ?" : "";
    $params = $customer_id ? [$customer_id] : [];

    $rows = sqlite_query(
        "SELECT brm.*, c.name as customer_name
         FROM business_rule_masks brm
         INNER JOIN customers c ON brm.customer_id = c.id
         $where
         ORDER BY brm.created_at DESC
         LIMIT 100",
        $params
    );

    foreach ($rows as $row) {
        $action = $row["is_masked"] ? "Masked" : "Unmasked";
        $results[] = [
            "date" => $row["created_at"],
            "effective_date" => $row["effective_date"],
            "description" =>
                $action .
                ' rule "' .
                $row["rule_name"] .
                '" for ' .
                $row["customer_name"],
            "customer_name" => $row["customer_name"],
        ];
    }

    return $results;
}

// ------------------------------------------------------------
// BILLING CALENDAR ACTIONS
// ------------------------------------------------------------

/**
 * Billing Calendar - Year View
 * Shows 12-month calendar with event indicators and completion status
 */
function action_calendar()
{
    $year = (int) get_param("year", date("Y"));

    // Get calendar summary for the year
    $months = get_calendar_year_summary($year);

    // Get next incomplete month for "What's Next?" button
    $next_incomplete = get_next_incomplete_month();

    // Get overall stats for the year
    $total_escalators = 0;
    $total_resets = 0;
    $completed_months = 0;

    foreach ($months as $m) {
        if ($m["is_complete"]) {
            $completed_months++;
        }
        $events = get_month_events($year, $m["month"]);
        $total_escalators += count($events["escalators"]);
        $total_resets += count($events["resets"]);
    }

    $data = [
        "year" => $year,
        "months" => $months,
        "next_incomplete" => $next_incomplete,
        "total_escalators" => $total_escalators,
        "total_resets" => $total_resets,
        "completed_months" => $completed_months,
    ];

    render_calendar($data);
}

/**
 * Billing Calendar - Month Checklist View
 * Shows detailed checklist for a specific month
 */
function action_calendar_month()
{
    $year = (int) get_param("year", date("Y"));
    $month = (int) get_param("month", date("n"));

    // Validate month
    if ($month < 1 || $month > 12) {
        set_flash("error", "Invalid month");
        redirect("calendar");
        return;
    }

    // Get events for this month
    $events = get_month_events($year, $month);

    // Get month completion status
    $is_complete = is_month_complete($year, $month);

    // Get new customers since last month
    $last_month_start = date("Y-m-01", strtotime("$year-$month-01 -1 month"));
    $new_customers = get_new_customers_since($last_month_start);

    // Get config changes since last month
    $config_changes = get_config_changes_since($last_month_start);

    // Get MTD summary if we have daily reports
    $mtd = get_mtd_summary($year, $month);

    // Build checklist sections
    $checklist = [];

    // Section 1: What's New
    $whats_new = [];
    foreach ($new_customers as $c) {
        $whats_new[] = [
            "type" => "new_customer",
            "message" => "NEW CUSTOMER: " . $c["name"],
            "customer_id" => $c["id"],
            "severity" => "info",
        ];
    }
    $checklist["whats_new"] = $whats_new;

    // Section 2: What's Changing
    $whats_changing = [];
    foreach ($events["escalators"] as $e) {
        $desc =
            "ESCALATOR: " . $e["customer_name"] . " Year " . $e["year_number"];
        $desc .= " (" . format_percentage($e["percentage"]) . ")";
        if ($e["has_delay"]) {
            $desc .= " [delayed " . $e["delay_months"] . " mo]";
        }
        $whats_changing[] = [
            "type" => "escalator",
            "message" => $desc,
            "customer_id" => $e["customer_id"],
            "effective_date" => $e["effective_date"],
            "severity" => "warning",
        ];
    }
    foreach ($events["resets"] as $r) {
        $whats_changing[] = [
            "type" => "reset",
            "message" =>
                "TIER RESET: " . $r["customer_name"] . " annualized reset",
            "customer_id" => $r["customer_id"],
            "effective_date" => $r["reset_date"],
            "severity" => "info",
        ];
    }
    $checklist["whats_changing"] = $whats_changing;

    // Section 3: What's Excluded
    $whats_excluded = [];
    foreach ($events["paused_customers"] as $p) {
        $whats_excluded[] = [
            "type" => "paused",
            "message" => "PAUSED: " . $p["name"] . " - will NOT be billed",
            "customer_id" => $p["id"],
            "severity" => "danger",
        ];
    }
    $checklist["whats_excluded"] = $whats_excluded;

    // Section 4: What's Different (config changes)
    $whats_different = [];
    foreach ($config_changes as $c) {
        $whats_different[] = [
            "type" => $c["type"],
            "message" => "CONFIG: " . $c["description"],
            "customer_id" => $c["customer_id"],
            "date" => $c["date"],
            "severity" => "info",
        ];
    }
    $checklist["whats_different"] = $whats_different;

    // Section 5: Warnings
    $warnings = [];
    foreach ($events["warnings"] as $w) {
        $warnings[] = [
            "type" => $w["type"],
            "message" => "WARNING: " . $w["message"],
            "customer_id" => $w["customer_id"],
            "severity" => "danger",
        ];
    }
    $checklist["warnings"] = $warnings;

    // Navigation helpers
    $prev_month = $month - 1;
    $prev_year = $year;
    if ($prev_month < 1) {
        $prev_month = 12;
        $prev_year--;
    }

    $next_month = $month + 1;
    $next_year = $year;
    if ($next_month > 12) {
        $next_month = 1;
        $next_year++;
    }

    $data = [
        "year" => $year,
        "month" => $month,
        "month_name" => date("F", mktime(0, 0, 0, $month, 1)),
        "is_complete" => $is_complete,
        "is_current" => $year == date("Y") && $month == date("n"),
        "events" => $events,
        "checklist" => $checklist,
        "mtd" => $mtd,
        "prev" => ["year" => $prev_year, "month" => $prev_month],
        "next" => ["year" => $next_year, "month" => $next_month],
        "total_items" =>
            count($whats_new) +
            count($whats_changing) +
            count($whats_excluded) +
            count($whats_different) +
            count($warnings),
    ];

    render_calendar_month($data);
}

// ------------------------------------------------------------
// MAIN ROUTER
// ------------------------------------------------------------

/**
 * Route request to appropriate action handler
 */
function route()
{
    $action = get_action();

    // Map actions to handlers
    $routes = [
        // Dashboard
        "dashboard" => "action_dashboard",

        // CSV/File management (existing)
        "list_reports" => "action_list_reports",
        "view_report" => "action_view_report",
        "download_report" => "action_download_report",
        "upload_config" => "action_upload_config",
        "list_pending" => "action_list_pending",
        "list_archive" => "action_list_archive",
        "view_config" => "action_view_config",
        "download_config" => "action_download_config",

        // Pricing: System Defaults
        "pricing_defaults" => "action_pricing_defaults",
        "pricing_defaults_edit" => "action_pricing_defaults_edit",

        // Pricing: Discount Groups
        "pricing_groups" => "action_pricing_groups",
        "pricing_group_edit" => "action_pricing_group_edit",

        // Pricing: Customers
        "pricing_customers" => "action_pricing_customers",
        "pricing_customer_edit" => "action_pricing_customer_edit",

        // Escalators
        "escalators" => "action_escalators",
        "escalator_edit" => "action_escalator_edit",
        "escalator_delay" => "action_escalator_delay",

        // Business Rules
        "business_rules" => "action_business_rules",
        "business_rules_all" => "action_business_rules_all",
        "business_rule_edit" => "action_business_rule_edit",
        "business_rule_toggle" => "action_business_rule_toggle",

        // History
        "history" => "action_history",

        // Billing Calendar
        "calendar" => "action_calendar",
        "calendar_month" => "action_calendar_month",
        "mtd_dashboard" => "action_mtd_dashboard",

        // CSV Export
        "export" => "action_export",
        "export_pricing" => "action_export_pricing",
        "export_settings" => "action_export_settings",
        "export_escalators" => "action_export_escalators",

        // LMS
        "lms" => "action_lms",
        "lms_edit" => "action_lms_edit",
        "lms_settings" => "action_lms_settings",
        "lms_report" => "action_lms_report",

        // Ingestion
        "ingestion" => "action_ingestion",
        "ingestion_view" => "action_ingestion_view",
        "ingestion_bulk" => "action_ingestion_bulk",

        // Generation
        "generation" => "action_generation",
        "generation_types" => "action_generation_types",
        "billing_flags" => "action_billing_flags",

        // Monthly Minimums & Annualized
        "minimums" => "action_minimums",
        "annualized" => "action_annualized",

        // Customer Pricing View
        "customer_pricing" => "action_customer_pricing",
    ];

    if (isset($routes[$action]) && function_exists($routes[$action])) {
        call_user_func($routes[$action]);
    } else {
        // Default to dashboard
        action_dashboard();
    }
}

// ============================================================
// END PHASE 3
// ============================================================

// ============================================================
// PHASE 4: HTML/UI TEMPLATES
// Inline templates for all views
// ============================================================

// ------------------------------------------------------------
// LAYOUT FUNCTIONS
// ------------------------------------------------------------

/**
 * Render the page header/layout start
 *
 * @param string $title Page title
 */
function render_header($title = "Control Panel")
{
    $flash = get_flash(); ?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?php echo h($title); ?></title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            background: #f5f5f5;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Header */
        .header {
            background: #2c3e50;
            color: #fff;
            padding: 15px 20px;
            margin-bottom: 20px;
        }
        .header h1 { font-size: 20px; font-weight: 500; }

        /* Navigation */
        .nav {
            background: #34495e;
            padding: 0;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        .nav > a {
            display: inline-block;
            color: #ecf0f1;
            text-decoration: none;
            padding: 12px 20px;
            transition: background 0.2s;
        }
        .nav > a:hover, .nav > a.active {
            background: #2c3e50;
        }
        .nav-group {
            position: relative;
        }
        .nav-group-label {
            display: inline-block;
            color: #ecf0f1;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }
        .nav-group-label:after {
            content: " ";
            font-size: 10px;
            opacity: 0.7;
        }
        .nav-group:hover .nav-group-label,
        .nav-group.has-active .nav-group-label {
            background: #2c3e50;
        }
        .nav-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #2c3e50;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        .nav-group:hover .nav-dropdown {
            display: block;
        }
        .nav-dropdown a {
            display: block;
            color: #ecf0f1;
            text-decoration: none;
            padding: 10px 20px;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }
        .nav-dropdown a:hover {
            background: #34495e;
            border-left-color: #3498db;
        }
        .nav-dropdown a.active {
            background: #34495e;
            border-left-color: #3498db;
        }
        .nav-spacer {
            flex-grow: 1;
        }
        .nav-external {
            opacity: 0.7;
            font-size: 13px;
        }
        .nav-external:hover {
            opacity: 1;
        }

        /* Breadcrumb */
        .breadcrumb {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
        }
        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        .breadcrumb span {
            margin: 0 8px;
            color: #999;
        }

        /* Cards */
        .card {
            background: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .card h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
        }
        tr:hover { background: #f8f9fa; }

        /* Buttons & Links */
        .btn {
            display: inline-block;
            padding: 8px 16px;
            background: #3498db;
            color: #fff;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover { background: #2980b9; }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #219a52; }
        .btn-info { background: #3498db; }
        .btn-info:hover { background: #2980b9; }
        .btn-sm { padding: 4px 10px; font-size: 12px; }

        /* Badges */
        .badge { display: inline-block; padding: 3px 8px; font-size: 11px; font-weight: 600; border-radius: 3px; }
        .badge-success { background: #d4edda; color: #155724; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-error, .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-default { background: #e9ecef; color: #495057; }

        /* Flash Messages */
        .flash {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .flash-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .flash-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .flash-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-control:focus { border-color: #3498db; outline: none; }

        /* Stats */
        .stats { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-card {
            flex: 1;
            background: #fff;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-card .number { font-size: 32px; font-weight: 700; color: #2c3e50; }
        .stat-card .label { color: #666; font-size: 13px; }

        /* Data Preview */
        .data-preview { overflow-x: auto; }
        .data-preview table { font-size: 13px; }
        .data-preview td { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Utility */
        .text-muted { color: #999; }
        .text-right { text-align: right; }
        .mb-20 { margin-bottom: 20px; }

        /* Search & Filter Bar */
        .search-bar {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .search-bar input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            min-width: 250px;
        }
        .search-bar input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }
        .search-bar select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .pagination a, .pagination span {
            display: inline-block;
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-decoration: none;
            color: #333;
            font-size: 13px;
        }
        .pagination a:hover {
            background: #f0f0f0;
            border-color: #ccc;
        }
        .pagination .active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        .pagination .disabled {
            color: #ccc;
            pointer-events: none;
        }
        .pagination .ellipsis {
            border: none;
            padding: 6px 8px;
        }
        .pagination-info {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Control Panel</h1>
    </div>

    <?php
    $action = get_action();
    $config_active = strpos($action, "pricing_") === 0 || strpos($action, "escalator") === 0
        || strpos($action, "business_rule") === 0 || strpos($action, "lms") === 0
        || strpos($action, "minimums") === 0 || strpos($action, "annualized") === 0;
    $data_active = strpos($action, "ingestion") === 0 || strpos($action, "generation") === 0
        || $action === "list_reports" || $action === "view_report"
        || strpos($action, "export") === 0 || $action === "history";
    ?>
    <div class="nav">
        <a href="?action=dashboard" <?php echo $action === "dashboard" ? 'class="active"' : ""; ?>>Dashboard</a>
        <a href="?action=calendar" <?php echo strpos($action, "calendar") === 0 ? 'class="active"' : ""; ?>>Calendar</a>

        <div class="nav-group<?php echo $config_active ? ' has-active' : ''; ?>">
            <span class="nav-group-label">Configuration</span>
            <div class="nav-dropdown">
                <a href="?action=pricing_customers" <?php echo strpos($action, "pricing_customer") === 0 ? 'class="active"' : ""; ?>>Customers</a>
                <a href="?action=pricing_groups" <?php echo strpos($action, "pricing_group") === 0 ? 'class="active"' : ""; ?>>Groups</a>
                <a href="?action=lms" <?php echo strpos($action, "lms") === 0 ? 'class="active"' : ""; ?>>LMS</a>
                <a href="?action=escalators" <?php echo strpos($action, "escalator") === 0 ? 'class="active"' : ""; ?>>Escalators</a>
                <a href="?action=business_rules" <?php echo strpos($action, "business_rule") === 0 ? 'class="active"' : ""; ?>>Rules</a>
                <a href="?action=minimums" <?php echo strpos($action, "minimums") === 0 ? 'class="active"' : ""; ?>>Monthly Minimums</a>
                <a href="?action=annualized" <?php echo strpos($action, "annualized") === 0 ? 'class="active"' : ""; ?>>Annualized Tiers</a>
                <a href="?action=pricing_defaults" <?php echo strpos($action, "pricing_defaults") === 0 ? 'class="active"' : ""; ?>>Default Pricing</a>
            </div>
        </div>

        <div class="nav-group<?php echo $data_active ? ' has-active' : ''; ?>">
            <span class="nav-group-label">Data</span>
            <div class="nav-dropdown">
                <a href="?action=ingestion" <?php echo strpos($action, "ingestion") === 0 ? 'class="active"' : ""; ?>>Ingestion</a>
                <a href="?action=generation" <?php echo strpos($action, "generation") === 0 ? 'class="active"' : ""; ?>>Generation</a>
                <a href="?action=list_reports" <?php echo $action === "list_reports" || $action === "view_report" ? 'class="active"' : ""; ?>>Reports</a>
                <a href="?action=export" <?php echo strpos($action, "export") === 0 ? 'class="active"' : ""; ?>>Export</a>
                <a href="?action=history" <?php echo $action === "history" ? 'class="active"' : ""; ?>>History</a>
            </div>
        </div>

        <div class="nav-spacer"></div>
        <a href="phpliteadmin.php" target="_blank" class="nav-external">DB Explorer</a>
    </div>

    <div class="container">
        <?php if ($flash): ?>
            <div class="flash flash-<?php echo h($flash["type"]); ?>">
                <?php echo h($flash["message"]); ?>
            </div>
        <?php endif; ?>
<?php
}
/**
 * Render page footer/layout end
 */ function render_footer()
{
    ?>
    </div>
</body>
</html>
<?php
} // ------------------------------------------------------------
// VIEW RENDERERS
// ------------------------------------------------------------
/**
 * Render dashboard view
 */
function render_dashboard($data)
{
    render_header("Dashboard - Control Panel"); ?>
    <div class="stats">
        <div class="stat-card">
            <div class="number"><?php echo $data["service_count"]; ?></div>
            <div class="label">Services</div>
        </div>
        <div class="stat-card">
            <div class="number"><?php echo $data["group_count"]; ?></div>
            <div class="label">Discount Groups</div>
        </div>
        <div class="stat-card">
            <div class="number"><?php echo $data["customer_active"]; ?></div>
            <div class="label">Active Customers</div>
        </div>
        <div class="stat-card">
            <div class="number"><?php echo $data["customer_total"]; ?></div>
            <div class="label">Total Customers</div>
        </div>
    </div>

    <div class="card">
        <h2>Quick Actions</h2>
        <a href="?action=pricing_defaults" class="btn">Manage Defaults</a>
        <a href="?action=pricing_groups" class="btn">Manage Groups</a>
        <a href="?action=pricing_customers" class="btn">Manage Customers</a>
        <a href="?action=upload_config" class="btn btn-success">Upload Config CSV</a>
    </div>

    <?php if (!empty($data["alerts"])): ?>
    <div class="card">
        <h2>Alerts &amp; Notifications</h2>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <?php foreach ($data["alerts"] as $alert): ?>
            <div style="padding: 12px 15px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;
                        <?php echo $alert["type"] === "warning"
                            ? "background: #fff3cd; border: 1px solid #ffc107;"
                            : "background: #d1ecf1; border: 1px solid #bee5eb;"; ?>">
                <span><?php echo $alert["message"]; ?></span>
                <a href="<?php echo $alert[
                    "link"
                ]; ?>" class="btn btn-sm">View</a>
            </div>
            <?php endforeach; ?>
        </div>
    </div>
    <?php endif; ?>

    <?php if (!empty($data["pending_configs"])): ?>
    <div class="card">
        <h2>Pending Configs</h2>
        <p class="text-muted mb-20"><?php echo count(
            $data["pending_configs"]
        ); ?> files awaiting processing.</p>
        <table>
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Size</th>
                    <th>Uploaded</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach (
                    array_slice($data["pending_configs"], 0, 5)
                    as $file
                ): ?>
                <tr>
                    <td><?php echo h($file["name"]); ?></td>
                    <td><?php echo format_filesize($file["size"]); ?></td>
                    <td><?php echo date(
                        "Y-m-d H:i:s",
                        $file["modified"]
                    ); ?></td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
    <?php endif; ?>

    <?php if (!empty($data["reports"])): ?>
    <div class="card">
        <h2>Recent Reports</h2>
        <table>
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Size</th>
                    <th>Generated</th>
                    <th class="text-right">Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach (array_slice($data["reports"], 0, 5) as $file): ?>
                <tr>
                    <td><?php echo h($file["name"]); ?></td>
                    <td><?php echo format_filesize($file["size"]); ?></td>
                    <td><?php echo date(
                        "Y-m-d H:i:s",
                        $file["modified"]
                    ); ?></td>
                    <td class="text-right">
                        <a href="?action=view_report&file=<?php echo urlencode(
                            $file["name"]
                        ); ?>" class="btn btn-sm">View</a>
                        <a href="?action=download_report&file=<?php echo urlencode(
                            $file["name"]
                        ); ?>" class="btn btn-sm btn-success">Download</a>
                    </td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
        <?php if (count($data["reports"]) > 5): ?>
            <p style="margin-top: 15px;"><a href="?action=list_reports">View all reports &rarr;</a></p>
        <?php endif; ?>
    </div>
    <?php endif; ?>
<?php
} /**
 * Render list reports view
 */
function render_list_reports($data)
{
    render_header("Reports - Control Panel"); ?>
    <div class="card">
        <h2>All Reports</h2>
        <?php if (empty($data["reports"])): ?>
            <p class="text-muted">No reports available.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Size</th>
                        <th>Generated</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["reports"] as $file): ?>
                    <tr>
                        <td><?php echo h($file["name"]); ?></td>
                        <td><?php echo format_filesize($file["size"]); ?></td>
                        <td><?php echo date(
                            "Y-m-d H:i:s",
                            $file["modified"]
                        ); ?></td>
                        <td class="text-right">
                            <a href="?action=view_report&file=<?php echo urlencode(
                                $file["name"]
                            ); ?>" class="btn btn-sm">View</a>
                            <a href="?action=download_report&file=<?php echo urlencode(
                                $file["name"]
                            ); ?>" class="btn btn-sm btn-success">Download</a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
    </div>
<?php
} /**
 * Render view report (CSV preview)
 */
function render_view_report($data)
{
    render_header("View Report - Control Panel"); ?>
    <div class="card">
        <h2>
            <?php echo h($data["filename"]); ?>
            <a href="?action=download_report&file=<?php echo urlencode(
                $data["filename"]
            ); ?>" class="btn btn-sm btn-success" style="float: right;">Download</a>
        </h2>
        <p class="text-muted mb-20"><?php echo $data["count"]; ?> rows</p>

        <div class="data-preview">
            <?php if (empty($data["rows"])): ?>
                <p class="text-muted">No data in this file.</p>
            <?php else: ?>
                <table>
                    <thead>
                        <tr>
                            <?php foreach ($data["headers"] as $header): ?>
                                <th><?php echo h($header); ?></th>
                            <?php endforeach; ?>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($data["rows"] as $row): ?>
                        <tr>
                            <?php foreach ($data["headers"] as $header): ?>
                                <td title="<?php echo h(
                                    isset($row[$header]) ? $row[$header] : ""
                                ); ?>">
                                    <?php echo h(
                                        isset($row[$header])
                                            ? $row[$header]
                                            : ""
                                    ); ?>
                                </td>
                            <?php endforeach; ?>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            <?php endif; ?>
        </div>
    </div>

    <div class="breadcrumb"><a href="?action=list_reports">Reports</a><span>/</span><?php echo h($data["report"]["report_type"]); ?> - <?php echo $data["report"]["report_year"]; ?>-<?php echo str_pad($data["report"]["report_month"], 2, "0", STR_PAD_LEFT); ?></div>
<?php
} /**
 * Render upload config form
 */
function render_upload_config($data)
{
    render_header("Upload Config - Control Panel"); ?>
    <div class="card">
        <h2>Upload Configuration CSV</h2>

        <?php if ($data["error"]): ?>
            <div class="flash flash-error"><?php echo h(
                $data["error"]
            ); ?></div>
        <?php endif; ?>

        <form method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label for="config_file">Select CSV File</label>
                <input type="file" name="config_file" id="config_file" class="form-control" accept=".csv" required>
            </div>

            <button type="submit" class="btn btn-success">Upload Config</button>
        </form>
    </div>

    <div class="card">
        <h2>Instructions</h2>
        <p>Upload a configuration CSV file to submit for processing.</p>
        <ul style="margin: 10px 0 0 20px;">
            <li>File must be in CSV format</li>
            <li>First row must contain column headers</li>
            <li>File will be placed in pending queue for processing</li>
            <li>A copy will be archived for historical reference</li>
        </ul>
    </div>
<?php
}
/**
 * Render ingestion page - upload and manage billing reports
 */
function render_ingestion($data)
{
    render_header("Ingestion - Control Panel");
    $tab = isset($data["tab"]) ? $data["tab"] : "reports";
    $drive_files = isset($data["drive_files"]) ? $data["drive_files"] : [];
    $not_imported = array_filter($drive_files, function($f) { return !$f["imported"]; });
    ?>
    <div class="card">
        <h2>Billing Report Ingestion</h2>

        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 4px;">
                <div style="font-size: 24px; font-weight: bold;"><?php echo isset($data["stats"]["total_reports"]) ? $data["stats"]["total_reports"] : 0; ?></div>
                <div style="color: #666; font-size: 13px;">Imported Reports</div>
            </div>
            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 4px;">
                <div style="font-size: 24px; font-weight: bold;"><?php echo isset($data["stats"]["total_rows"]) ? number_format($data["stats"]["total_rows"]) : 0; ?></div>
                <div style="color: #666; font-size: 13px;">Total Rows</div>
            </div>
            <div style="flex: 1; background: <?php echo count($not_imported) > 0 ? '#fff3cd' : '#d4edda'; ?>; padding: 15px; border-radius: 4px;">
                <div style="font-size: 24px; font-weight: bold;"><?php echo count($not_imported); ?></div>
                <div style="color: #666; font-size: 13px;">Pending on Drive</div>
            </div>
            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 4px;">
                <div style="font-size: 13px; color: #666;">Date Range</div>
                <div><?php echo isset($data["stats"]["earliest"]) && $data["stats"]["earliest"] ? $data["stats"]["earliest"] . " to " . $data["stats"]["latest"] : "No data"; ?></div>
            </div>
        </div>

        <!-- Tabs -->
        <div style="margin-bottom: 20px; border-bottom: 2px solid #eee;">
            <a href="?action=ingestion&tab=reports" style="display: inline-block; padding: 10px 20px; text-decoration: none; color: <?php echo $tab === 'reports' ? '#3498db' : '#666'; ?>; border-bottom: 2px solid <?php echo $tab === 'reports' ? '#3498db' : 'transparent'; ?>; margin-bottom: -2px; font-weight: <?php echo $tab === 'reports' ? '600' : 'normal'; ?>;">
                Imported Reports
            </a>
            <a href="?action=ingestion&tab=upload" style="display: inline-block; padding: 10px 20px; text-decoration: none; color: <?php echo $tab === 'upload' ? '#3498db' : '#666'; ?>; border-bottom: 2px solid <?php echo $tab === 'upload' ? '#3498db' : 'transparent'; ?>; margin-bottom: -2px; font-weight: <?php echo $tab === 'upload' ? '600' : 'normal'; ?>;">
                Upload File
            </a>
            <a href="?action=ingestion&tab=drive" style="display: inline-block; padding: 10px 20px; text-decoration: none; color: <?php echo $tab === 'drive' ? '#3498db' : '#666'; ?>; border-bottom: 2px solid <?php echo $tab === 'drive' ? '#3498db' : 'transparent'; ?>; margin-bottom: -2px; font-weight: <?php echo $tab === 'drive' ? '600' : 'normal'; ?>;">
                Import from Drive <?php if (count($not_imported) > 0): ?><span class="badge badge-warning"><?php echo count($not_imported); ?></span><?php endif; ?>
            </a>
        </div>

        <?php if ($tab === 'upload'): ?>
        <!-- Upload Tab -->
        <h3>Upload Billing CSV</h3>
        <form method="POST" enctype="multipart/form-data" style="margin-bottom: 30px;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="file" name="billing_csv" accept=".csv" required style="flex: 1;">
                <button type="submit" class="btn btn-success">Upload & Import</button>
            </div>
            <p class="text-muted" style="margin-top: 8px; font-size: 12px;">
                Expected format: <code>DataX_YYYY_MM_DD_humanreadable.csv</code><br>
                Columns: <code>y,m,cust_id,cust_name,hit_code,tran_displayname,actual_unit_cost,count,revenue,EFX_code,billing_id</code>
            </p>
        </form>

        <?php elseif ($tab === 'drive'): ?>
        <!-- Drive Tab -->
        <h3>Import from Drive</h3>
        <p class="text-muted" style="margin-bottom: 15px;">Files available in the archive directory for import.</p>

        <?php if (empty($drive_files)): ?>
            <p class="text-muted">No billing files found in archive directory.</p>
        <?php else: ?>
            <form method="POST">
                <input type="hidden" name="bulk_import" value="1">
                <div style="margin-bottom: 15px;">
                    <button type="button" class="btn btn-sm" onclick="selectAllPending()">Select All Pending</button>
                    <button type="button" class="btn btn-sm" onclick="deselectAll()">Deselect All</button>
                    <button type="submit" class="btn btn-success" style="margin-left: 20px;">Import Selected</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="select-all" onclick="toggleAll(this)"></th>
                            <th>Filename</th>
                            <th>Size</th>
                            <th>Modified</th>
                            <th>Status</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($drive_files as $file): ?>
                        <tr style="<?php echo $file['imported'] ? 'opacity: 0.6;' : ''; ?>">
                            <td>
                                <input type="checkbox" name="selected_files[]" value="<?php echo h($file['filename']); ?>"
                                    class="file-checkbox" <?php echo $file['imported'] ? 'disabled' : ''; ?>
                                    data-pending="<?php echo $file['imported'] ? '0' : '1'; ?>">
                            </td>
                            <td><code><?php echo h($file['filename']); ?></code></td>
                            <td><?php echo number_format($file['size'] / 1024, 1); ?> KB</td>
                            <td><?php echo date("Y-m-d H:i", $file['modified']); ?></td>
                            <td>
                                <?php if ($file['imported']): ?>
                                    <span class="badge badge-success">Imported</span>
                                <?php else: ?>
                                    <span class="badge badge-warning">Pending</span>
                                <?php endif; ?>
                            </td>
                            <td class="text-right">
                                <?php if (!$file['imported']): ?>
                                    <a href="?action=ingestion&import_file=<?php echo urlencode($file['filename']); ?>" class="btn btn-sm btn-success">Import</a>
                                <?php else: ?>
                                    <span class="text-muted">-</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </form>
            <script>
            function toggleAll(el) {
                var checkboxes = document.querySelectorAll('.file-checkbox:not([disabled])');
                checkboxes.forEach(function(cb) { cb.checked = el.checked; });
            }
            function selectAllPending() {
                var checkboxes = document.querySelectorAll('.file-checkbox[data-pending="1"]');
                checkboxes.forEach(function(cb) { cb.checked = true; });
            }
            function deselectAll() {
                var checkboxes = document.querySelectorAll('.file-checkbox');
                checkboxes.forEach(function(cb) { cb.checked = false; });
                document.getElementById('select-all').checked = false;
            }
            </script>
        <?php endif; ?>

        <?php else: ?>
        <!-- Reports Tab (default) -->
        <h3>Imported Reports</h3>
        <?php if (empty($data["reports"])): ?>
            <p class="text-muted">No reports imported yet. <a href="?action=ingestion&tab=drive">Import from drive</a> or <a href="?action=ingestion&tab=upload">upload a file</a>.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Date</th>
                        <th>File</th>
                        <th>Rows</th>
                        <th>Imported At</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["reports"] as $report): ?>
                    <tr>
                        <td>
                            <span class="badge badge-<?php echo $report["report_type"] === "monthly" ? "success" : "info"; ?>">
                                <?php echo h($report["report_type"]); ?>
                            </span>
                        </td>
                        <td><?php echo h($report["report_date"]); ?></td>
                        <td><code style="font-size: 11px;"><?php echo h($report["file_path"]); ?></code></td>
                        <td><?php echo number_format($report["record_count"]); ?></td>
                        <td><?php echo date("Y-m-d H:i", strtotime($report["imported_at"])); ?></td>
                        <td class="text-right">
                            <a href="?action=ingestion_view&id=<?php echo $report["id"]; ?>" class="btn btn-sm">View</a>
                            <a href="?action=ingestion&delete=<?php echo $report["id"]; ?>" class="btn btn-sm" style="background: #e74c3c;" onclick="return confirm('Delete this report?');">Delete</a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
        <?php endif; ?>
    </div>
<?php
}
/**
 * Render single billing report view
 */
function render_ingestion_view($data)
{
    render_header("View Report - Control Panel"); ?>
    <div class="breadcrumb"><a href="?action=ingestion">Ingestion</a><span>/</span><?php echo h($data["report"]["report_type"]); ?> - <?php echo h($data["report"]["report_date"]); ?></div>

    <div class="card">
        <h2><?php echo ucfirst($data["report"]["report_type"]); ?> Report: <?php echo h($data["report"]["report_date"]); ?></h2>
        <p class="text-muted"><?php echo number_format($data["report"]["record_count"]); ?> rows imported on <?php echo date("Y-m-d H:i", strtotime($data["report"]["created_at"])); ?></p>

        <?php if (empty($data["lines"])): ?>
            <p class="text-muted">No line items.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>EFX Code</th>
                        <th>Service</th>
                        <th class="text-right">Count</th>
                        <th class="text-right">Revenue</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["lines"] as $line): ?>
                    <tr>
                        <td><?php echo h($line["cust_id"]); ?></td>
                        <td><?php echo h($line["efx_code"]); ?></td>
                        <td><?php echo h($line["service_name"]); ?></td>
                        <td class="text-right"><?php echo number_format($line["count"]); ?></td>
                        <td class="text-right">$<?php echo number_format($line["revenue"], 2); ?></td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
    </div>
<?php
}
/**
 * Render bulk ingestion page
 */
function render_ingestion_bulk($data)
{
    render_header("Bulk Ingestion - Control Panel"); ?>
    <div class="breadcrumb"><a href="?action=ingestion">Ingestion</a><span>/</span>Bulk Import</div>

    <div class="card">
        <h2>Bulk Import Results</h2>
        <?php if (!empty($data["results"])): ?>
            <table>
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Status</th>
                        <th>Rows</th>
                        <th>Message</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["results"] as $result): ?>
                    <tr>
                        <td><?php echo h($result["filename"]); ?></td>
                        <td>
                            <span class="badge badge-<?php echo $result["success"] ? "success" : "error"; ?>">
                                <?php echo $result["success"] ? "OK" : "Failed"; ?>
                            </span>
                        </td>
                        <td><?php echo isset($result["rows_imported"]) ? $result["rows_imported"] : "-"; ?></td>
                        <td><?php echo h(isset($result["errors"]) ? implode(", ", $result["errors"]) : ""); ?></td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php else: ?>
            <p class="text-muted">No results.</p>
        <?php endif; ?>
    </div>
<?php
}
/**
 * Render generation page - generate tier_pricing.csv
 */
function render_generation($data)
{
    render_header("Generation - Control Panel"); ?>
    <div class="card">
        <h2>Generate Tier Pricing CSV</h2>

        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 4px;">
                <div style="font-size: 24px; font-weight: bold;"><?php echo $data["active_customers"]; ?></div>
                <div style="color: #666; font-size: 13px;">Active Customers</div>
            </div>
            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 4px;">
                <div style="font-size: 24px; font-weight: bold;"><?php echo $data["services_count"]; ?></div>
                <div style="color: #666; font-size: 13px;">Services</div>
            </div>
            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 4px;">
                <div style="font-size: 24px; font-weight: bold;"><?php echo $data["transaction_types_count"]; ?></div>
                <div style="color: #666; font-size: 13px;">Transaction Types</div>
            </div>
        </div>

        <form method="POST" style="margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 4px;">
            <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">As of Date</label>
                    <input type="date" name="as_of_date" value="<?php echo h($data["as_of_date"]); ?>" class="form-control">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px;">
                        <input type="checkbox" name="include_inactive" value="1" <?php echo $data["include_inactive"] ? "checked" : ""; ?>>
                        Include inactive customers
                    </label>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" name="preview" value="1" class="btn">Preview</button>
                    <button type="submit" name="action" value="save_pending" class="btn btn-success">Generate & Save</button>
                    <a href="?action=generation&download=1&as_of_date=<?php echo h($data["as_of_date"]); ?><?php echo $data["include_inactive"] ? "&include_inactive=1" : ""; ?>" class="btn btn-info">Download CSV</a>
                </div>
            </div>
        </form>

        <?php if (!empty($data["preview"])): ?>
        <h3>Preview (<?php echo $data["preview"]["row_count"]; ?> rows)</h3>
        <?php if (!empty($data["preview"]["errors"])): ?>
            <div class="flash flash-error"><?php echo h(implode(", ", $data["preview"]["errors"])); ?></div>
        <?php endif; ?>

        <?php if (!empty($data["preview"]["rows"])): ?>
            <div style="max-height: 400px; overflow: auto;">
                <table>
                    <thead>
                        <tr>
                            <?php foreach (array_keys($data["preview"]["rows"][0]) as $col): ?>
                                <th><?php echo h($col); ?></th>
                            <?php endforeach; ?>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach (array_slice($data["preview"]["rows"], 0, 50) as $row): ?>
                        <tr>
                            <?php foreach ($row as $val): ?>
                                <td><?php echo h($val); ?></td>
                            <?php endforeach; ?>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
            <?php if ($data["preview"]["row_count"] > 50): ?>
                <p class="text-muted">Showing first 50 of <?php echo $data["preview"]["row_count"]; ?> rows.</p>
            <?php endif; ?>
        <?php endif; ?>
        <?php endif; ?>

        <?php if (!empty($data["pending_files"])): ?>
        <h3 style="margin-top: 30px;">Recent Generated Files</h3>
        <table>
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Size</th>
                    <th>Generated</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($data["pending_files"] as $file): ?>
                <tr>
                    <td><?php echo h($file["filename"]); ?></td>
                    <td><?php echo format_filesize($file["size"]); ?></td>
                    <td><?php echo date("Y-m-d H:i:s", $file["modified"]); ?></td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
        <?php endif; ?>
    </div>

    <div class="card">
        <h2>Transaction Types</h2>
        <p class="text-muted">Manage EFX code to service mappings.</p>
        <a href="?action=generation_types" class="btn">Manage Transaction Types</a>
    </div>
<?php
}
/**
 * Render transaction types management
 */
function render_generation_types($data)
{
    render_header("Transaction Types - Control Panel"); ?>
    <div class="breadcrumb"><a href="?action=generation">Generation</a><span>/</span>Transaction Types</div>

    <div class="card">
        <h2>Transaction Types</h2>
        <p class="text-muted">Map EFX codes to services for billing generation.</p>

        <h3>Import from CSV</h3>
        <form method="POST" enctype="multipart/form-data" style="margin-bottom: 30px;">
            <div style="display: flex; gap: 10px; align-items: center;">
                <input type="file" name="types_csv" accept=".csv" required style="flex: 1;">
                <button type="submit" class="btn btn-success">Upload & Import</button>
            </div>
            <p class="text-muted" style="margin-top: 8px; font-size: 12px;">
                CSV format: <code>efx_code,description,service_id</code>
            </p>
        </form>

        <h3>Current Transaction Types</h3>
        <?php if (empty($data["types"])): ?>
            <p class="text-muted">No transaction types defined.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>EFX Code</th>
                        <th>Description</th>
                        <th>Service</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["types"] as $type): ?>
                    <tr>
                        <td><code><?php echo h($type["efx_code"]); ?></code></td>
                        <td><?php echo h($type["description"]); ?></td>
                        <td><?php echo h(isset($type["service_name"]) ? $type["service_name"] : "-"); ?></td>
                        <td class="text-right">
                            <a href="?action=generation_types&delete=<?php echo $type["id"]; ?>" class="btn btn-sm" style="background: #e74c3c;" onclick="return confirm('Delete this type?');">Delete</a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>

        <h3 style="margin-top: 30px;">Add Transaction Type</h3>
        <form method="POST">
            <input type="hidden" name="add_type" value="1">
            <div style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap;">
                <div>
                    <label style="display: block; margin-bottom: 5px;">EFX Code</label>
                    <input type="text" name="efx_code" required class="form-control" style="width: 150px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px;">Description</label>
                    <input type="text" name="description" required class="form-control" style="width: 250px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px;">Service</label>
                    <select name="service_id" class="form-control">
                        <option value="">-- None --</option>
                        <?php foreach ($data["services"] as $svc): ?>
                            <option value="<?php echo $svc["id"]; ?>"><?php echo h($svc["name"]); ?></option>
                        <?php endforeach; ?>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Add</button>
            </div>
        </form>
    </div>
<?php
}
/**
 * Render LMS list
 */
function render_lms($data)
{
    render_header("LMS Management - Control Panel"); ?>
    <div class="card">
        <h2>LMS Management</h2>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <p class="text-muted" style="margin: 0;">Manage Loan Management System entries and commission rates.</p>
            <div>
                <a href="?action=lms_settings" class="btn">Settings</a>
                <a href="?action=lms&sync=1" class="btn btn-info">Sync from Remote</a>
            </div>
        </div>

        <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
            <strong>Default Commission Rate:</strong> <?php echo $data["default_rate"] !== null ? number_format($data["default_rate"], 2) . "%" : "Not set"; ?>
        </div>

        <?php if (!empty($data["unassigned_customers"])): ?>
        <div style="background: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
            <strong>Warning:</strong> <?php echo count($data["unassigned_customers"]); ?> customer(s) have no LMS assigned.
        </div>
        <?php endif; ?>

        <?php
        $search_val = isset($data["search"]) ? $data["search"] : "";
        render_search_bar("lms", [
            "search" => $search_val,
            "placeholder" => "Search LMS..."
        ]);
        ?>

        <?php if (empty($data["lms_list"])): ?>
            <p class="text-muted">No LMS entries found. <?php echo empty($search_val) ? 'Click "Sync from Remote" to import.' : 'Try a different search.'; ?></p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>LMS ID</th>
                        <th>Name</th>
                        <th>Commission Rate</th>
                        <th>Customers</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["lms_list"] as $lms): ?>
                    <tr>
                        <td><code><?php echo h($lms["id"]); ?></code></td>
                        <td><?php echo h($lms["name"]); ?></td>
                        <td>
                            <?php echo number_format($lms["effective_rate"], 2); ?>%
                            <?php if ($lms["is_inherited"]): ?>
                                <span class="text-muted" style="font-size: 11px;">(default)</span>
                            <?php endif; ?>
                        </td>
                        <td><?php echo $lms["customer_count"]; ?></td>
                        <td class="text-right">
                            <a href="?action=lms_edit&lms_id=<?php echo urlencode($lms["id"]); ?>" class="btn btn-sm">Edit</a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

            <?php
            $pag_params = [];
            if (!empty($data["search"])) {
                $pag_params["search"] = $data["search"];
            }
            render_pagination($data["pagination"], "?action=lms", $pag_params);
            ?>
        <?php endif; ?>
    </div>
<?php
}

/**
 * Render LMS edit form
 */
function render_lms_edit($data)
{
    render_header("Edit LMS - Control Panel"); ?>
    <div class="breadcrumb"><a href="?action=lms">LMS</a><span>/</span><?php echo h($data["lms"]["name"]); ?></div>

    <div class="card">
        <h2>Edit LMS: <?php echo h($data["lms"]["name"]); ?></h2>

        <form method="POST">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px;">
                    <input type="checkbox" name="use_default" value="1" <?php echo $data["lms"]["commission_rate"] === null ? "checked" : ""; ?> onchange="document.getElementById('rate_input').disabled = this.checked;">
                    Use default commission rate (<?php echo number_format($data["default_rate"], 2); ?>%)
                </label>
                <div>
                    <label style="display: block; margin-bottom: 5px;">Commission Rate (%)</label>
                    <input type="number" step="0.01" name="commission_rate" id="rate_input"
                           value="<?php echo $data["lms"]["commission_rate"] !== null ? $data["lms"]["commission_rate"] : $data["default_rate"]; ?>"
                           class="form-control" style="width: 150px;"
                           <?php echo $data["lms"]["commission_rate"] === null ? "disabled" : ""; ?>>
                </div>
            </div>
            <button type="submit" class="btn btn-success">Save</button>
        </form>
    </div>

    <?php if (!empty($data["customers"])): ?>
    <div class="card">
        <h2>Customers Using This LMS (<?php echo count($data["customers"]); ?>)</h2>
        <table>
            <thead>
                <tr>
                    <th>Customer ID</th>
                    <th>Name</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($data["customers"] as $cust): ?>
                <tr>
                    <td><code><?php echo h($cust["id"]); ?></code></td>
                    <td><?php echo h($cust["name"]); ?></td>
                    <td><span class="badge badge-<?php echo $cust["status"] === "active" ? "success" : "info"; ?>"><?php echo h($cust["status"]); ?></span></td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>
    </div>
    <?php endif; ?>
<?php
}
/**
 * Render LMS settings
 */
function render_lms_settings($data)
{
    render_header("LMS Settings - Control Panel"); ?>
    <div class="breadcrumb"><a href="?action=lms">LMS</a><span>/</span>Settings</div>

    <div class="card">
        <h2>LMS Settings</h2>

        <form method="POST">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 500;">Default Commission Rate (%)</label>
                <input type="number" step="0.01" name="default_commission_rate"
                       value="<?php echo $data["default_rate"] !== null ? $data["default_rate"] : ""; ?>"
                       class="form-control" style="width: 150px;">
                <p class="text-muted" style="margin-top: 5px; font-size: 12px;">
                    This rate is used for LMS entries that don't have a custom rate set.
                </p>
            </div>
            <button type="submit" class="btn btn-success">Save</button>
        </form>
    </div>
<?php
}
/**
 * Render LMS commission report
 */
function render_lms_report($data)
{
    render_header("LMS Commission Report - Control Panel"); ?>
    <div class="breadcrumb"><a href="?action=lms">LMS</a><span>/</span>Commission Report</div>

    <div class="card">
        <h2>Commission Report</h2>
        <?php if (empty($data["report"])): ?>
            <p class="text-muted">No data available for this period.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>LMS</th>
                        <th class="text-right">Revenue</th>
                        <th class="text-right">Rate</th>
                        <th class="text-right">Commission</th>
                    </tr>
                </thead>
                <tbody>
                    <?php $total_commission = 0; ?>
                    <?php foreach ($data["report"] as $row): ?>
                    <tr>
                        <td><?php echo h($row["lms_name"]); ?></td>
                        <td class="text-right">$<?php echo number_format($row["revenue"], 2); ?></td>
                        <td class="text-right"><?php echo number_format($row["rate"], 2); ?>%</td>
                        <td class="text-right">$<?php echo number_format($row["commission"], 2); ?></td>
                    </tr>
                    <?php $total_commission += $row["commission"]; ?>
                    <?php endforeach; ?>
                </tbody>
                <tfoot>
                    <tr style="font-weight: bold;">
                        <td colspan="3">Total</td>
                        <td class="text-right">$<?php echo number_format($total_commission, 2); ?></td>
                    </tr>
                </tfoot>
            </table>
        <?php endif; ?>
    </div>
<?php
}
/**
 * Render customer pricing view - color-coded effective pricing
 */
function render_customer_pricing($data)
{
    render_header("Pricing View: " . $data["customer"]["name"] . " - Control Panel"); ?>

    <style>
        .pricing-source-default { background: #e3f2fd; border-left: 4px solid #2196f3; }
        .pricing-source-group { background: #fff3e0; border-left: 4px solid #ff9800; }
        .pricing-source-customer { background: #e8f5e9; border-left: 4px solid #4caf50; }
        .pricing-legend { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .pricing-legend-item { display: flex; align-items: center; gap: 8px; }
        .pricing-legend-color { width: 20px; height: 20px; border-radius: 3px; }
        .pricing-legend-color.default { background: #2196f3; }
        .pricing-legend-color.group { background: #ff9800; }
        .pricing-legend-color.customer { background: #4caf50; }
        .pricing-card { margin-bottom: 15px; border-radius: 4px; overflow: hidden; }
        .pricing-card-header { padding: 12px 15px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .pricing-card-body { padding: 0; }
        .pricing-card table { margin: 0; }
        .pricing-card th, .pricing-card td { padding: 8px 15px; }
        .tier-row { transition: background 0.2s; }
        .tier-row.source-default { background: #e3f2fd; }
        .tier-row.source-group { background: #fff3e0; }
        .tier-row.source-customer { background: #e8f5e9; }
        .price-cell { font-family: monospace; font-size: 14px; }
        .price-comparison { font-size: 11px; color: #666; }
        .price-comparison del { color: #999; }
        .summary-box { padding: 15px; border-radius: 4px; text-align: center; }
        .summary-box .number { font-size: 28px; font-weight: bold; }
        .summary-box .label { font-size: 12px; color: #666; margin-top: 4px; }
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .settings-item { background: #f8f9fa; padding: 12px; border-radius: 4px; }
        .settings-item .label { font-size: 11px; color: #666; text-transform: uppercase; }
        .settings-item .value { font-size: 16px; font-weight: 500; margin-top: 4px; }
        .escalator-timeline { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .escalator-year { padding: 8px 12px; background: #f0f0f0; border-radius: 4px; text-align: center; min-width: 80px; }
        .escalator-year.active { background: #fff3e0; border: 2px solid #ff9800; }
        .escalator-year .year-num { font-weight: bold; }
        .escalator-year .year-pct { font-size: 13px; color: #666; }
    </style>

    <div class="breadcrumb">
        <a href="?action=pricing_customers">Customers</a><span>/</span><?php echo h($data["customer"]["name"]); ?><span>/</span>Pricing View
    </div>

    <div class="card">
        <h2>
            <?php echo h($data["customer"]["name"]); ?>
            <span class="badge badge-<?php echo $data["customer"]["status"] === "active" ? "success" : "info"; ?>" style="margin-left: 10px;">
                <?php echo h($data["customer"]["status"]); ?>
            </span>
        </h2>

        <?php if ($data["customer"]["group_name"]): ?>
            <p style="margin-bottom: 15px;">
                <strong>Discount Group:</strong>
                <a href="?action=pricing_group_edit&id=<?php echo $data["customer"]["discount_group_id"]; ?>"><?php echo h($data["customer"]["group_name"]); ?></a>
            </p>
        <?php else: ?>
            <p style="margin-bottom: 15px; color: #666;">No discount group (inherits directly from system defaults)</p>
        <?php endif; ?>

        <!-- Legend -->
        <div class="pricing-legend" style="background: #f8f9fa; padding: 15px; border-radius: 4px;">
            <strong style="margin-right: 10px;">Price Source:</strong>
            <div class="pricing-legend-item">
                <div class="pricing-legend-color default"></div>
                <span>System Default</span>
            </div>
            <div class="pricing-legend-item">
                <div class="pricing-legend-color group"></div>
                <span>Discount Group Override</span>
            </div>
            <div class="pricing-legend-item">
                <div class="pricing-legend-color customer"></div>
                <span>Customer Override</span>
            </div>
        </div>
    </div>

    <!-- Summary Stats -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
        <div class="summary-box" style="background: #f8f9fa;">
            <div class="number"><?php echo $data["summary"]["total_services"]; ?></div>
            <div class="label">Total Services</div>
        </div>
        <div class="summary-box" style="background: #e3f2fd;">
            <div class="number" style="color: #2196f3;"><?php echo $data["summary"]["using_defaults"]; ?></div>
            <div class="label">Using Defaults</div>
        </div>
        <div class="summary-box" style="background: #fff3e0;">
            <div class="number" style="color: #ff9800;"><?php echo $data["summary"]["group_overrides"]; ?></div>
            <div class="label">Group Overrides</div>
        </div>
        <div class="summary-box" style="background: #e8f5e9;">
            <div class="number" style="color: #4caf50;"><?php echo $data["summary"]["customer_overrides"]; ?></div>
            <div class="label">Customer Overrides</div>
        </div>
    </div>

    <!-- Customer Settings -->
    <div class="card">
        <h2>Customer Settings</h2>
        <div class="settings-grid">
            <div class="settings-item">
                <div class="label">Monthly Minimum</div>
                <div class="value">
                    <?php if ($data["settings"]["monthly_minimum"]): ?>
                        $<?php echo number_format($data["settings"]["monthly_minimum"], 2); ?>
                    <?php else: ?>
                        <span style="color: #999;">None</span>
                    <?php endif; ?>
                </div>
            </div>
            <div class="settings-item">
                <div class="label">Annualized Tiers</div>
                <div class="value">
                    <?php if ($data["settings"]["uses_annualized"]): ?>
                        <span style="color: #4caf50;">Enabled</span>
                        <?php if ($data["settings"]["annualized_start_date"]): ?>
                            <br><small>Start: <?php echo h($data["settings"]["annualized_start_date"]); ?></small>
                        <?php endif; ?>
                    <?php else: ?>
                        <span style="color: #999;">Disabled</span>
                    <?php endif; ?>
                </div>
            </div>
            <div class="settings-item">
                <div class="label">Look Period</div>
                <div class="value">
                    <?php if ($data["settings"]["look_period_months"]): ?>
                        <?php echo $data["settings"]["look_period_months"]; ?> months
                    <?php else: ?>
                        <span style="color: #999;">N/A</span>
                    <?php endif; ?>
                </div>
            </div>
            <div class="settings-item">
                <div class="label">LMS</div>
                <div class="value">
                    <?php if ($data["customer"]["lms_id"]): ?>
                        <?php echo h($data["customer"]["lms_id"]); ?>
                    <?php else: ?>
                        <span style="color: #e74c3c;">Not Assigned</span>
                    <?php endif; ?>
                </div>
            </div>
        </div>
    </div>

    <!-- Escalators -->
    <div class="card">
        <h2>Escalators</h2>
        <?php if (empty($data["escalators"])): ?>
            <p class="text-muted">No escalators configured for this customer.</p>
        <?php else: ?>
            <?php
            $start_date = $data["escalators"][0]["escalator_start_date"];
            $current_year = 1;
            if ($start_date) {
                $years_since = floor((time() - strtotime($start_date)) / (365.25 * 24 * 60 * 60));
                $current_year = max(1, $years_since + 1);
            }
            ?>
            <p><strong>Contract Start:</strong> <?php echo h($start_date); ?>
               <?php if ($data["total_delay"] > 0): ?>
                   <span class="badge badge-warning">+<?php echo $data["total_delay"]; ?> month delay applied</span>
               <?php endif; ?>
            </p>
            <div class="escalator-timeline">
                <?php foreach ($data["escalators"] as $esc): ?>
                    <div class="escalator-year <?php echo $esc["year_number"] == $current_year ? "active" : ""; ?>">
                        <div class="year-num">Year <?php echo $esc["year_number"]; ?></div>
                        <div class="year-pct">
                            <?php if ($esc["escalator_percentage"] > 0): ?>
                                +<?php echo $esc["escalator_percentage"]; ?>%
                            <?php else: ?>
                                Base
                            <?php endif; ?>
                            <?php if ($esc["fixed_adjustment"] != 0): ?>
                                <br><?php echo $esc["fixed_adjustment"] > 0 ? "+" : ""; ?>$<?php echo number_format($esc["fixed_adjustment"], 2); ?>
                            <?php endif; ?>
                        </div>
                    </div>
                <?php endforeach; ?>
            </div>
        <?php endif; ?>
    </div>

    <!-- Service Pricing -->
    <div class="card">
        <h2>Service Pricing (<?php echo count($data["pricing_data"]); ?> services)</h2>

        <?php if (empty($data["pricing_data"])): ?>
            <p class="text-muted">No services configured.</p>
        <?php else: ?>
            <?php foreach ($data["pricing_data"] as $pd): ?>
                <?php
                $service = $pd["service"];
                $header_class = "pricing-source-default";
                if ($pd["has_customer_override"]) {
                    $header_class = "pricing-source-customer";
                } elseif ($pd["has_group_override"]) {
                    $header_class = "pricing-source-group";
                }
                ?>
                <div class="pricing-card">
                    <div class="pricing-card-header <?php echo $header_class; ?>">
                        <span><?php echo h($service["name"]); ?></span>
                        <span style="font-weight: normal; font-size: 12px;">
                            <?php echo count($pd["tiers"]); ?> tier<?php echo count($pd["tiers"]) != 1 ? "s" : ""; ?>
                        </span>
                    </div>
                    <div class="pricing-card-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>Volume Range</th>
                                    <th>Effective Price</th>
                                    <th>Default</th>
                                    <?php if ($data["customer"]["discount_group_id"]): ?>
                                        <th>Group</th>
                                    <?php endif; ?>
                                    <th>Customer</th>
                                    <th>Source</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($pd["tiers"] as $tier): ?>
                                    <tr class="tier-row source-<?php echo $tier["source"]; ?>">
                                        <td>
                                            <?php echo number_format($tier["volume_start"]); ?>
                                            -
                                            <?php echo $tier["volume_end"] ? number_format($tier["volume_end"]) : "Unlimited"; ?>
                                        </td>
                                        <td class="price-cell">
                                            <strong>$<?php echo number_format($tier["price"], 4); ?></strong>
                                        </td>
                                        <td class="price-cell" style="color: #2196f3;">
                                            <?php echo $tier["default_price"] !== null ? "$" . number_format($tier["default_price"], 4) : "-"; ?>
                                        </td>
                                        <?php if ($data["customer"]["discount_group_id"]): ?>
                                            <td class="price-cell" style="color: #ff9800;">
                                                <?php echo $tier["group_price"] !== null ? "$" . number_format($tier["group_price"], 4) : "-"; ?>
                                            </td>
                                        <?php endif; ?>
                                        <td class="price-cell" style="color: #4caf50;">
                                            <?php echo $tier["customer_price"] !== null ? "$" . number_format($tier["customer_price"], 4) : "-"; ?>
                                        </td>
                                        <td>
                                            <?php if ($tier["source"] === "default"): ?>
                                                <span class="badge" style="background: #2196f3; color: white;">Default</span>
                                            <?php elseif ($tier["source"] === "group"): ?>
                                                <span class="badge" style="background: #ff9800; color: white;">Group</span>
                                            <?php else: ?>
                                                <span class="badge" style="background: #4caf50; color: white;">Customer</span>
                                            <?php endif; ?>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>

    <div style="margin-top: 20px;">
        <a href="?action=pricing_customer_edit&id=<?php echo $data["customer"]["id"]; ?>" class="btn">Edit Pricing</a>
        <a href="?action=pricing_customer_edit&id=<?php echo $data["customer"]["id"]; ?>&tab=settings" class="btn">Edit Settings</a>
        <a href="?action=escalator_edit&customer_id=<?php echo $data["customer"]["id"]; ?>" class="btn">Edit Escalators</a>
    </div>
<?php
}
/**
 * Render monthly minimums overview
 */
function render_minimums($data)
{
    render_header("Monthly Minimums - Control Panel"); ?>
    <div class="card">
        <h2>Monthly Minimums</h2>
        <p class="text-muted">Customers with monthly minimum billing amounts configured.</p>

        <div style="display: flex; gap: 20px; margin: 20px 0;">
            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 4px;">
                <div style="font-size: 24px; font-weight: bold;"><?php echo (int)$data["stats"]["count"]; ?></div>
                <div style="color: #666; font-size: 13px;">Customers with Minimums</div>
            </div>
            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 4px;">
                <div style="font-size: 24px; font-weight: bold;">$<?php echo number_format((float)$data["stats"]["total_minimums"], 2); ?></div>
                <div style="color: #666; font-size: 13px;">Total Monthly Minimums</div>
            </div>
            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 4px;">
                <div style="font-size: 24px; font-weight: bold;">$<?php echo number_format((float)$data["stats"]["avg_minimum"], 2); ?></div>
                <div style="color: #666; font-size: 13px;">Average Minimum</div>
            </div>
        </div>

        <?php if (empty($data["customers"])): ?>
            <p class="text-muted">No customers have monthly minimums configured.</p>
            <p><a href="?action=pricing_customers" class="btn">Go to Customers</a> to configure minimums.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Group</th>
                        <th>Status</th>
                        <th class="text-right">Monthly Minimum</th>
                        <th>Effective Date</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["customers"] as $customer): ?>
                    <tr>
                        <td><?php echo h($customer["name"]); ?></td>
                        <td><?php echo h($customer["group_name"] ?: "-"); ?></td>
                        <td>
                            <span class="badge badge-<?php echo $customer["status"] === "active" ? "success" : "info"; ?>">
                                <?php echo h($customer["status"]); ?>
                            </span>
                        </td>
                        <td class="text-right">$<?php echo number_format($customer["monthly_minimum"], 2); ?></td>
                        <td><?php echo h($customer["effective_date"]); ?></td>
                        <td class="text-right">
                            <a href="?action=pricing_customer_edit&id=<?php echo $customer["id"]; ?>&tab=settings" class="btn btn-sm">Edit</a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
    </div>
<?php
}
/**
 * Render annualized tiers overview
 */
function render_annualized($data)
{
    render_header("Annualized Tiers - Control Panel"); ?>
    <div class="card">
        <h2>Annualized Tiers</h2>
        <p class="text-muted">Customers using annualized tier calculations (volume resets annually on their start date).</p>

        <div style="display: flex; gap: 20px; margin: 20px 0;">
            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 4px;">
                <div style="font-size: 24px; font-weight: bold;"><?php echo (int)$data["stats"]["count"]; ?></div>
                <div style="color: #666; font-size: 13px;">Annualized Customers</div>
            </div>
            <div style="flex: 1; background: #d4edda; padding: 15px; border-radius: 4px;">
                <div style="font-size: 24px; font-weight: bold;"><?php echo count($data["upcoming_resets"]); ?></div>
                <div style="color: #155724; font-size: 13px;">Resets in Next 30 Days</div>
            </div>
        </div>

        <?php if (!empty($data["upcoming_resets"])): ?>
        <div style="background: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
            <strong>Upcoming Resets:</strong>
            <ul style="margin: 10px 0 0 20px; padding: 0;">
                <?php foreach ($data["upcoming_resets"] as $reset): ?>
                <li><?php echo h($reset["customer_name"]); ?> - <?php echo h($reset["reset_date"]); ?></li>
                <?php endforeach; ?>
            </ul>
        </div>
        <?php endif; ?>

        <?php if (empty($data["customers"])): ?>
            <p class="text-muted">No customers have annualized tiers enabled.</p>
            <p><a href="?action=pricing_customers" class="btn">Go to Customers</a> to enable annualized pricing.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Group</th>
                        <th>Status</th>
                        <th>Start Date</th>
                        <th>Look Period</th>
                        <th>Next Reset</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["customers"] as $customer): ?>
                    <tr>
                        <td><?php echo h($customer["name"]); ?></td>
                        <td><?php echo h($customer["group_name"] ?: "-"); ?></td>
                        <td>
                            <span class="badge badge-<?php echo $customer["status"] === "active" ? "success" : "info"; ?>">
                                <?php echo h($customer["status"]); ?>
                            </span>
                        </td>
                        <td><?php echo h($customer["annualized_start_date"] ?: "Not set"); ?></td>
                        <td><?php echo $customer["look_period_months"] ? $customer["look_period_months"] . " months" : "-"; ?></td>
                        <td>
                            <?php if ($customer["next_reset"]): ?>
                                <?php
                                $days_until = (strtotime($customer["next_reset"]) - time()) / 86400;
                                $badge_class = $days_until <= 30 ? "badge-warning" : "badge-info";
                                ?>
                                <span class="badge <?php echo $badge_class; ?>"><?php echo h($customer["next_reset"]); ?></span>
                            <?php else: ?>
                                -
                            <?php endif; ?>
                        </td>
                        <td class="text-right">
                            <a href="?action=pricing_customer_edit&id=<?php echo $customer["id"]; ?>&tab=settings" class="btn btn-sm">Edit</a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
    </div>
<?php
}
/**
 * Render list pending configs
 */
function render_list_pending($data)
{
    render_header("Pending Configs - Control Panel"); ?>
    <div class="card">
        <h2>Pending Configurations</h2>
        <p class="text-muted mb-20">Files awaiting processing by cron job.</p>

        <?php if (empty($data["configs"])): ?>
            <p class="text-muted">No pending configurations.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Size</th>
                        <th>Uploaded</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["configs"] as $file): ?>
                    <tr>
                        <td><?php echo h($file["name"]); ?></td>
                        <td><?php echo format_filesize($file["size"]); ?></td>
                        <td><?php echo date(
                            "Y-m-d H:i:s",
                            $file["modified"]
                        ); ?></td>
                        <td class="text-right">
                            <a href="?action=view_config&file=<?php echo urlencode(
                                $file["name"]
                            ); ?>&source=pending" class="btn btn-sm">View</a>
                            <a href="?action=download_config&file=<?php echo urlencode(
                                $file["name"]
                            ); ?>&source=pending" class="btn btn-sm btn-success">Download</a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
    </div>
<?php
} /**
 * Render list archived configs
 */
function render_list_archive($data)
{
    render_header("Archived Configs - Control Panel"); ?>
    <div class="card">
        <h2>Archived Configurations</h2>
        <p class="text-muted mb-20">Historical record of all submitted configurations.</p>

        <?php if (empty($data["configs"])): ?>
            <p class="text-muted">No archived configurations.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Filename</th>
                        <th>Size</th>
                        <th>Uploaded</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["configs"] as $file): ?>
                    <tr>
                        <td><?php echo h($file["name"]); ?></td>
                        <td><?php echo format_filesize($file["size"]); ?></td>
                        <td><?php echo date(
                            "Y-m-d H:i:s",
                            $file["modified"]
                        ); ?></td>
                        <td class="text-right">
                            <a href="?action=view_config&file=<?php echo urlencode(
                                $file["name"]
                            ); ?>&source=archive" class="btn btn-sm">View</a>
                            <a href="?action=download_config&file=<?php echo urlencode(
                                $file["name"]
                            ); ?>&source=archive" class="btn btn-sm btn-success">Download</a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
    </div>
<?php
} /**
 * Render view config (CSV preview)
 */
function render_view_config($data)
{
    $source_label = $data["source"] === "pending" ? "Pending" : "Archived";
    $back_action =
        $data["source"] === "pending" ? "list_pending" : "list_archive";
    render_header("View Config - Control Panel");
    ?>
    <div class="card">
        <h2>
            <?php echo h($data["filename"]); ?>
            <span class="text-muted" style="font-weight: normal; font-size: 12px;">(<?php echo $source_label; ?>)</span>
            <a href="?action=download_config&file=<?php echo urlencode(
                $data["filename"]
            ); ?>&source=<?php echo $data["source"]; ?>" class="btn btn-sm btn-success" style="float: right;">Download</a>
        </h2>
        <p class="text-muted mb-20"><?php echo $data["count"]; ?> rows</p>

        <div class="data-preview">
            <?php if (empty($data["rows"])): ?>
                <p class="text-muted">No data in this file.</p>
            <?php else: ?>
                <table>
                    <thead>
                        <tr>
                            <?php foreach ($data["headers"] as $header): ?>
                                <th><?php echo h($header); ?></th>
                            <?php endforeach; ?>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($data["rows"] as $row): ?>
                        <tr>
                            <?php foreach ($data["headers"] as $header): ?>
                                <td title="<?php echo h(
                                    isset($row[$header]) ? $row[$header] : ""
                                ); ?>">
                                    <?php echo h(
                                        isset($row[$header])
                                            ? $row[$header]
                                            : ""
                                    ); ?>
                                </td>
                            <?php endforeach; ?>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            <?php endif; ?>
        </div>
    </div>

    <p><a href="?action=<?php echo $back_action; ?>">&larr; Back to <?php echo $source_label; ?></a></p>
<?php
} /**
 * Render system defaults list
 */
function render_pricing_defaults($data)
{
    render_header("System Defaults - Pricing"); ?>
    <div class="card">
        <h2 style="display: flex; justify-content: space-between; align-items: center;">
            System Default Pricing
            <span style="font-size: 12px; font-weight: normal;">
                <a href="javascript:void(0)" onclick="expandAll()" class="btn btn-sm">Expand All</a>
                <a href="javascript:void(0)" onclick="collapseAll()" class="btn btn-sm">Collapse All</a>
            </span>
        </h2>
        <p class="text-muted mb-20">Base pricing for all services. Groups and customers inherit from these defaults.</p>

        <?php if (empty($data["services"])): ?>
            <p class="text-muted">No services defined.</p>
        <?php else: ?>
            <?php foreach ($data["services"] as $idx => $service): ?>
            <div class="tier-section" style="border: 1px solid #eee; border-radius: 4px; margin-bottom: 15px; overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #f8f9fa; cursor: pointer;" onclick="toggleTiers('default-<?php echo $service[
                    "id"
                ]; ?>')">
                    <div>
                        <strong><?php echo h($service["name"]); ?></strong>
                        <span class="text-muted" style="margin-left: 15px;"><?php echo $service[
                            "tier_count"
                        ]; ?> tiers</span>
                        <?php if (!empty($service["tiers"])): ?>
                            <span class="text-muted" style="margin-left: 15px;">
                                $<?php echo number_format(
                                    $service["tiers"][
                                        count($service["tiers"]) - 1
                                    ]["price_per_inquiry"],
                                    2
                                ); ?>
                                - $<?php echo number_format(
                                    $service["tiers"][0]["price_per_inquiry"],
                                    2
                                ); ?>
                            </span>
                        <?php endif; ?>
                    </div>
                    <div>
                        <span class="toggle-icon" id="icon-default-<?php echo $service[
                            "id"
                        ]; ?>" style="margin-right: 10px; color: #999;">&#9650;</span>
                        <a href="?action=pricing_defaults_edit&service_id=<?php echo $service[
                            "id"
                        ]; ?>" class="btn btn-sm" onclick="event.stopPropagation();">Edit Tiers</a>
                    </div>
                </div>
                <div class="tier-content" id="tiers-default-<?php echo $service[
                    "id"
                ]; ?>" style="padding: 0 15px 15px 15px;">
                    <?php if (!empty($service["tiers"])): ?>
                    <table style="margin-top: 10px; font-size: 13px;">
                        <thead>
                            <tr>
                                <th style="padding: 6px 10px;">Volume Start</th>
                                <th style="padding: 6px 10px;">Volume End</th>
                                <th style="padding: 6px 10px;">Price Per Inquiry</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($service["tiers"] as $tier): ?>
                            <tr>
                                <td style="padding: 6px 10px;"><?php echo number_format(
                                    $tier["volume_start"]
                                ); ?></td>
                                <td style="padding: 6px 10px;"><?php echo $tier[
                                    "volume_end"
                                ] !== null
                                    ? number_format($tier["volume_end"])
                                    : "<em>Unlimited</em>"; ?></td>
                                <td style="padding: 6px 10px;">$<?php echo number_format(
                                    $tier["price_per_inquiry"],
                                    4
                                ); ?></td>
                            </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                    <?php else: ?>
                        <p class="text-muted" style="margin-top: 10px;">No tiers defined.</p>
                    <?php endif; ?>
                </div>
            </div>
            <?php endforeach; ?>
        <?php endif; ?>
    </div>

    <script>
    function toggleTiers(id) {
        var el = document.getElementById('tiers-' + id);
        var icon = document.getElementById('icon-' + id);
        if (el.style.display === 'none') {
            el.style.display = 'block';
            icon.innerHTML = '&#9650;';
        } else {
            el.style.display = 'none';
            icon.innerHTML = '&#9660;';
        }
    }
    function expandAll() {
        var contents = document.querySelectorAll('.tier-content');
        var icons = document.querySelectorAll('.toggle-icon');
        for (var i = 0; i < contents.length; i++) {
            contents[i].style.display = 'block';
        }
        for (var i = 0; i < icons.length; i++) {
            icons[i].innerHTML = '&#9650;';
        }
    }
    function collapseAll() {
        var contents = document.querySelectorAll('.tier-content');
        var icons = document.querySelectorAll('.toggle-icon');
        for (var i = 0; i < contents.length; i++) {
            contents[i].style.display = 'none';
        }
        for (var i = 0; i < icons.length; i++) {
            icons[i].innerHTML = '&#9660;';
        }
    }
    </script>
<?php
} /**
 * Render system defaults edit form
 */
function render_pricing_defaults_edit($data)
{
    render_header("Edit Default Pricing - " . h($data["service"]["name"])); ?>
    <div class="card">
        <h2>Edit Default Pricing: <?php echo h(
            $data["service"]["name"]
        ); ?></h2>
        <p class="text-muted mb-20">Define volume-based pricing tiers. Leave "Volume End" empty for unlimited.</p>

        <form method="post" id="tier-form">
            <table id="tiers-table">
                <thead>
                    <tr>
                        <th>Volume Start</th>
                        <th>Volume End</th>
                        <th>Price Per Inquiry</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (empty($data["tiers"])): ?>
                    <tr class="tier-row">
                        <td><input type="number" name="volume_start[]" class="form-control" value="0" min="0" required></td>
                        <td><input type="number" name="volume_end[]" class="form-control" placeholder="Unlimited" min="0"></td>
                        <td><input type="number" name="price_per_inquiry[]" class="form-control" step="0.01" min="0" required></td>
                        <td><button type="button" class="btn btn-sm" onclick="removeRow(this)">Remove</button></td>
                    </tr>
                    <?php else: ?>
                        <?php foreach ($data["tiers"] as $tier): ?>
                        <tr class="tier-row">
                            <td><input type="number" name="volume_start[]" class="form-control" value="<?php echo h(
                                $tier["volume_start"]
                            ); ?>" min="0" required></td>
                            <td><input type="number" name="volume_end[]" class="form-control" value="<?php echo $tier[
                                "volume_end"
                            ] !== null
                                ? h($tier["volume_end"])
                                : ""; ?>" placeholder="Unlimited" min="0"></td>
                            <td><input type="number" name="price_per_inquiry[]" class="form-control" value="<?php echo h(
                                $tier["price_per_inquiry"]
                            ); ?>" step="0.01" min="0" required></td>
                            <td><button type="button" class="btn btn-sm" onclick="removeRow(this)">Remove</button></td>
                        </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>

            <div style="margin: 15px 0;">
                <button type="button" class="btn" onclick="addRow()">+ Add Tier</button>
            </div>

            <div style="margin-top: 20px;">
                <button type="submit" class="btn btn-success">Save Default Pricing</button>
                <a href="?action=pricing_defaults" class="btn">Cancel</a>
            </div>
        </form>
    </div>

    <script>
    function addRow() {
        var tbody = document.querySelector('#tiers-table tbody');
        var lastRow = tbody.querySelector('.tier-row:last-child');
        var nextStart = 0;

        if (lastRow) {
            var endInput = lastRow.querySelector('input[name="volume_end[]"]');
            if (endInput.value) {
                nextStart = parseInt(endInput.value) + 1;
            }
        }

        var row = document.createElement('tr');
        row.className = 'tier-row';
        row.innerHTML = '<td><input type="number" name="volume_start[]" class="form-control" value="' + nextStart + '" min="0" required></td>' +
            '<td><input type="number" name="volume_end[]" class="form-control" placeholder="Unlimited" min="0"></td>' +
            '<td><input type="number" name="price_per_inquiry[]" class="form-control" step="0.01" min="0" required></td>' +
            '<td><button type="button" class="btn btn-sm" onclick="removeRow(this)">Remove</button></td>';
        tbody.appendChild(row);
    }

    function removeRow(btn) {
        var rows = document.querySelectorAll('.tier-row');
        if (rows.length > 1) {
            btn.closest('tr').remove();
        }
    }
    </script>

    <div class="breadcrumb" style="margin-top: 20px;"><a href="?action=pricing_defaults">Default Pricing</a><span>/</span>Edit Tiers</div>
<?php
} /**
 * Render discount groups list
 */
function render_pricing_groups($data)
{
    render_header("Discount Groups - Pricing"); ?>
    <div class="card">
        <h2>Discount Groups</h2>
        <p class="text-muted mb-20">Group-level pricing templates. Members inherit these settings.</p>

        <?php if (empty($data["groups"])): ?>
            <p class="text-muted">No discount groups defined.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Group Name</th>
                        <th>Members</th>
                        <th>Overrides</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["groups"] as $group): ?>
                    <tr>
                        <td><strong><?php echo h(
                            $group["name"]
                        ); ?></strong></td>
                        <td><?php echo $group["member_count"]; ?> customers</td>
                        <td><?php echo $group[
                            "override_count"
                        ]; ?> services</td>
                        <td class="text-right">
                            <a href="?action=pricing_group_edit&group_id=<?php echo $group[
                                "id"
                            ]; ?>" class="btn btn-sm">Edit Pricing</a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
    </div>
<?php
} /**
 * Render group services list (select which service to edit)
 */
function render_pricing_group_services($data)
{
    render_header("Group Pricing - " . h($data["group"]["name"])); ?>
    <div class="card">
        <h2 style="display: flex; justify-content: space-between; align-items: center;">
            <?php echo h($data["group"]["name"]); ?> - Service Pricing
            <span style="font-size: 12px; font-weight: normal;">
                <a href="javascript:void(0)" onclick="expandAll()" class="btn btn-sm">Expand All</a>
                <a href="javascript:void(0)" onclick="collapseAll()" class="btn btn-sm">Collapse All</a>
            </span>
        </h2>
        <p class="text-muted mb-20">Select a service to override pricing. Inherited values come from System Defaults.</p>

        <?php foreach ($data["services"] as $service): ?>
        <div class="tier-section" style="border: 1px solid #eee; border-radius: 4px; margin-bottom: 15px; overflow: hidden;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #f8f9fa; cursor: pointer;" onclick="toggleTiers('group-<?php echo $service[
                "id"
            ]; ?>')">
                <div>
                    <strong><?php echo h($service["name"]); ?></strong>
                    <?php if ($service["has_override"]): ?>
                        <span style="color: #27ae60; margin-left: 15px;">Overridden</span>
                    <?php else: ?>
                        <span class="text-muted" style="margin-left: 15px;">Inherited</span>
                    <?php endif; ?>
                    <?php if (!empty($service["tiers"])): ?>
                        <span class="text-muted" style="margin-left: 15px;">
                            $<?php echo number_format(
                                $service["tiers"][count($service["tiers"]) - 1][
                                    "price_per_inquiry"
                                ],
                                2
                            ); ?>
                            - $<?php echo number_format(
                                $service["tiers"][0]["price_per_inquiry"],
                                2
                            ); ?>
                        </span>
                    <?php endif; ?>
                </div>
                <div>
                    <span class="toggle-icon" id="icon-group-<?php echo $service[
                        "id"
                    ]; ?>" style="margin-right: 10px; color: #999;">&#9650;</span>
                    <a href="?action=pricing_group_edit&group_id=<?php echo $data[
                        "group"
                    ]["id"]; ?>&service_id=<?php echo $service[
    "id"
]; ?>" class="btn btn-sm" onclick="event.stopPropagation();">
                        <?php echo $service["has_override"]
                            ? "Edit"
                            : "Override"; ?>
                    </a>
                </div>
            </div>
            <div class="tier-content" id="tiers-group-<?php echo $service[
                "id"
            ]; ?>" style="padding: 0 15px 15px 15px;">
                <?php if (!empty($service["tiers"])): ?>
                <table style="margin-top: 10px; font-size: 13px;">
                    <thead>
                        <tr>
                            <th style="padding: 6px 10px;">Volume Start</th>
                            <th style="padding: 6px 10px;">Volume End</th>
                            <th style="padding: 6px 10px;">Price Per Inquiry</th>
                            <th style="padding: 6px 10px;">Source</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($service["tiers"] as $tier): ?>
                        <tr>
                            <td style="padding: 6px 10px;"><?php echo number_format(
                                $tier["volume_start"]
                            ); ?></td>
                            <td style="padding: 6px 10px;"><?php echo $tier[
                                "volume_end"
                            ] !== null
                                ? number_format($tier["volume_end"])
                                : "<em>Unlimited</em>"; ?></td>
                            <td style="padding: 6px 10px;">$<?php echo number_format(
                                $tier["price_per_inquiry"],
                                4
                            ); ?></td>
                            <td style="padding: 6px 10px;">
                                <?php if ($tier["source"] === "group"): ?>
                                    <span style="color: #27ae60;">Group</span>
                                <?php else: ?>
                                    <span class="text-muted">Default</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
                <?php else: ?>
                    <p class="text-muted" style="margin-top: 10px;">No tiers defined.</p>
                <?php endif; ?>
            </div>
        </div>
        <?php endforeach; ?>
    </div>

    <script>
    function toggleTiers(id) {
        var el = document.getElementById('tiers-' + id);
        var icon = document.getElementById('icon-' + id);
        if (el.style.display === 'none') {
            el.style.display = 'block';
            icon.innerHTML = '&#9650;';
        } else {
            el.style.display = 'none';
            icon.innerHTML = '&#9660;';
        }
    }
    function expandAll() {
        var contents = document.querySelectorAll('.tier-content');
        var icons = document.querySelectorAll('.toggle-icon');
        for (var i = 0; i < contents.length; i++) {
            contents[i].style.display = 'block';
        }
        for (var i = 0; i < icons.length; i++) {
            icons[i].innerHTML = '&#9650;';
        }
    }
    function collapseAll() {
        var contents = document.querySelectorAll('.tier-content');
        var icons = document.querySelectorAll('.toggle-icon');
        for (var i = 0; i < contents.length; i++) {
            contents[i].style.display = 'none';
        }
        for (var i = 0; i < icons.length; i++) {
            icons[i].innerHTML = '&#9660;';
        }
    }
    </script>

    <div class="breadcrumb"><a href="?action=pricing_groups">Groups</a><span>/</span><?php echo h($data["group"]["name"]); ?></div>
<?php
}
/**
 * Render group tier edit form
 */ function render_pricing_group_edit($data)
{
    render_header("Edit Group Pricing - " . h($data["group"]["name"])); ?>
    <div class="card">
        <h2><?php echo h(
            $data["group"]["name"]
        ); ?>: <?php echo h($data["service"]["name"]); ?></h2>

        <?php if ($data["has_override"]): ?>
            <p class="text-muted mb-20">
                <span style="color: #27ae60;">This group has custom pricing.</span>
                Modify tiers below or clear to inherit from defaults.
            </p>
        <?php else: ?>
            <p class="text-muted mb-20">
                Currently inheriting from System Defaults. Save to create a group override.
            </p>
        <?php endif; ?>

        <form method="post" id="tier-form">
            <table id="tiers-table">
                <thead>
                    <tr>
                        <th>Volume Start</th>
                        <th>Volume End</th>
                        <th>Price Per Inquiry</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (empty($data["tiers"])): ?>
                    <tr class="tier-row">
                        <td><input type="number" name="volume_start[]" class="form-control" value="0" min="0" required></td>
                        <td><input type="number" name="volume_end[]" class="form-control" placeholder="Unlimited" min="0"></td>
                        <td><input type="number" name="price_per_inquiry[]" class="form-control" step="0.01" min="0" required></td>
                        <td><button type="button" class="btn btn-sm" onclick="removeRow(this)">Remove</button></td>
                    </tr>
                    <?php else: ?>
                        <?php foreach ($data["tiers"] as $tier): ?>
                        <tr class="tier-row">
                            <td><input type="number" name="volume_start[]" class="form-control" value="<?php echo h(
                                $tier["volume_start"]
                            ); ?>" min="0" required></td>
                            <td><input type="number" name="volume_end[]" class="form-control" value="<?php echo $tier[
                                "volume_end"
                            ] !== null
                                ? h($tier["volume_end"])
                                : ""; ?>" placeholder="Unlimited" min="0"></td>
                            <td><input type="number" name="price_per_inquiry[]" class="form-control" value="<?php echo h(
                                $tier["price_per_inquiry"]
                            ); ?>" step="0.01" min="0" required></td>
                            <td><button type="button" class="btn btn-sm" onclick="removeRow(this)">Remove</button></td>
                        </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>

            <div style="margin: 15px 0;">
                <button type="button" class="btn" onclick="addRow()">+ Add Tier</button>
            </div>

            <div style="margin-top: 20px;">
                <button type="submit" name="form_action" value="save" class="btn btn-success">Save Group Pricing</button>
                <?php if ($data["has_override"]): ?>
                    <button type="submit" name="form_action" value="clear" class="btn" onclick="return confirm('Clear override and inherit from defaults?')">Clear Override</button>
                <?php endif; ?>
                <a href="?action=pricing_group_edit&group_id=<?php echo $data[
                    "group"
                ]["id"]; ?>" class="btn">Cancel</a>
            </div>
        </form>
    </div>

    <script>
    function addRow() {
        var tbody = document.querySelector('#tiers-table tbody');
        var lastRow = tbody.querySelector('.tier-row:last-child');
        var nextStart = 0;

        if (lastRow) {
            var endInput = lastRow.querySelector('input[name="volume_end[]"]');
            if (endInput.value) {
                nextStart = parseInt(endInput.value) + 1;
            }
        }

        var row = document.createElement('tr');
        row.className = 'tier-row';
        row.innerHTML = '<td><input type="number" name="volume_start[]" class="form-control" value="' + nextStart + '" min="0" required></td>' +
            '<td><input type="number" name="volume_end[]" class="form-control" placeholder="Unlimited" min="0"></td>' +
            '<td><input type="number" name="price_per_inquiry[]" class="form-control" step="0.01" min="0" required></td>' +
            '<td><button type="button" class="btn btn-sm" onclick="removeRow(this)">Remove</button></td>';
        tbody.appendChild(row);
    }

    function removeRow(btn) {
        var rows = document.querySelectorAll('.tier-row');
        if (rows.length > 1) {
            btn.closest('tr').remove();
        }
    }
    </script>

    <p style="margin-top: 20px;"><a href="?action=pricing_group_edit&group_id=<?php echo $data[
        "group"
    ]["id"]; ?>">&larr; Back to Services</a></p>
<?php
} /**
 * Render customers list
 */
function render_pricing_customers($data)
{
    render_header("Customers - Pricing"); ?>
    <div class="card">
        <h2>Customer Pricing</h2>

        <?php
        $search_val = isset($data["search"]) ? $data["search"] : "";
        render_search_bar("pricing_customers", [
            "search" => $search_val,
            "placeholder" => "Search customers or groups...",
            "filters" => [
                [
                    "name" => "status",
                    "options" => [
                        "active" => "Active",
                        "paused" => "Paused",
                        "decommissioned" => "Decommissioned",
                        "all" => "All Statuses"
                    ],
                    "current" => $data["status_filter"]
                ]
            ]
        ]);
        ?>

        <?php if (empty($data["customers"])): ?>
            <p class="text-muted">No customers found.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Discount Group</th>
                        <th>Status</th>
                        <th>Contract Start</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["customers"] as $customer): ?>
                    <tr>
                        <td><strong><?php echo h(
                            $customer["name"]
                        ); ?></strong></td>
                        <td><?php echo $customer["group_name"]
                            ? h($customer["group_name"])
                            : '<span class="text-muted">None</span>'; ?></td>
                        <td>
                            <?php
                            $status_class = "";
                            if ($customer["status"] === "active") {
                                $status_class = "color: #27ae60;";
                            } elseif ($customer["status"] === "paused") {
                                $status_class = "color: #f39c12;";
                            } else {
                                $status_class = "color: #e74c3c;";
                            }
                            ?>
                            <span style="<?php echo $status_class; ?>"><?php echo ucfirst(
    $customer["status"]
); ?></span>
                        </td>
                        <td><?php echo $customer["contract_start_date"]
                            ? h($customer["contract_start_date"])
                            : "-"; ?></td>
                        <td class="text-right">
                            <a href="?action=customer_pricing&id=<?php echo $customer[
                                "id"
                            ]; ?>" class="btn btn-sm btn-info">View</a>
                            <a href="?action=pricing_customer_edit&customer_id=<?php echo $customer[
                                "id"
                            ]; ?>" class="btn btn-sm">Edit</a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

            <?php
            $pag_params = ["status" => $data["status_filter"]];
            if (!empty($data["search"])) {
                $pag_params["search"] = $data["search"];
            }
            render_pagination($data["pagination"], "?action=pricing_customers", $pag_params);
            ?>
        <?php endif; ?>
    </div>
<?php
}

/**
 * Render customer services list (select which service to edit)
 */
function render_pricing_customer_services($data)
{
    render_header("Customer Pricing - " . h($data["customer"]["name"])); ?>
    <div class="card">
        <h2><?php echo h($data["customer"]["name"]); ?></h2>
        <p class="text-muted mb-20">
            <?php if ($data["customer"]["group_name"]): ?>
                Group: <strong><?php echo h(
                    $data["customer"]["group_name"]
                ); ?></strong> |
            <?php else: ?>
                <span style="color: #e67e22;">No discount group (inherits from defaults)</span> |
            <?php endif; ?>
            Status:
            <?php
            $status_class = "";
            if ($data["customer"]["status"] === "active") {
                $status_class = "color: #27ae60;";
            } elseif ($data["customer"]["status"] === "paused") {
                $status_class = "color: #f39c12;";
            } else {
                $status_class = "color: #e74c3c;";
            }
            ?>
            <span style="<?php echo $status_class; ?>"><?php echo ucfirst($data["customer"]["status"]); ?></span>
            <?php if ($data["customer"]["contract_start_date"]): ?>
                | Contract: <?php echo h(
                    $data["customer"]["contract_start_date"]
                ); ?>
            <?php endif; ?>
        </p>

        <div style="margin-bottom: 20px;">
            <a href="?action=pricing_customer_edit&customer_id=<?php echo $data[
                "customer"
            ][
                "id"
            ]; ?>&tab=services" class="btn <?php echo $data["tab"] === "services" ? "btn-success" : ""; ?>">Service Pricing</a>
            <a href="?action=pricing_customer_edit&customer_id=<?php echo $data[
                "customer"
            ][
                "id"
            ]; ?>&tab=settings" class="btn <?php echo $data["tab"] === "settings" ? "btn-success" : ""; ?>">Settings</a>
            <a href="?action=escalator_edit&customer_id=<?php echo $data[
                "customer"
            ]["id"]; ?>" class="btn">Escalators</a>
        </div>
    </div>

    <div class="card">
        <h2 style="display: flex; justify-content: space-between; align-items: center;">
            Service Pricing
            <span style="font-size: 12px; font-weight: normal;">
                <a href="javascript:void(0)" onclick="expandAll()" class="btn btn-sm">Expand All</a>
                <a href="javascript:void(0)" onclick="collapseAll()" class="btn btn-sm">Collapse All</a>
            </span>
        </h2>
        <p class="text-muted mb-20">Select a service to override pricing. Inherited values show their source.</p>

        <?php foreach ($data["services"] as $service): ?>
        <?php
        $source_label = $service["source"];
        $source_style = "";
        if ($service["source"] === "customer") {
            $source_label = "Customer";
            $source_style = "color: #27ae60; font-weight: bold;";
        } elseif ($service["source"] === "group") {
            $source_label = "Group";
            $source_style = "color: #3498db;";
        } else {
            $source_label = "Default";
            $source_style = "color: #999;";
        }
        ?>
        <div class="tier-section" style="border: 1px solid #eee; border-radius: 4px; margin-bottom: 15px; overflow: hidden;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #f8f9fa; cursor: pointer;" onclick="toggleTiers('cust-<?php echo $service[
                "id"
            ]; ?>')">
                <div>
                    <strong><?php echo h($service["name"]); ?></strong>
                    <?php if ($service["has_override"]): ?>
                        <span style="color: #27ae60; margin-left: 15px;">Overridden</span>
                    <?php else: ?>
                        <span class="text-muted" style="margin-left: 15px;">Inherited</span>
                    <?php endif; ?>
                    <span style="<?php echo $source_style; ?> margin-left: 10px;">(<?php echo $source_label; ?>)</span>
                    <?php if (!empty($service["tiers"])): ?>
                        <span class="text-muted" style="margin-left: 15px;">
                            $<?php echo number_format(
                                $service["tiers"][count($service["tiers"]) - 1][
                                    "price_per_inquiry"
                                ],
                                2
                            ); ?>
                            - $<?php echo number_format(
                                $service["tiers"][0]["price_per_inquiry"],
                                2
                            ); ?>
                        </span>
                    <?php endif; ?>
                </div>
                <div>
                    <span class="toggle-icon" id="icon-cust-<?php echo $service[
                        "id"
                    ]; ?>" style="margin-right: 10px; color: #999;">&#9650;</span>
                    <a href="?action=pricing_customer_edit&customer_id=<?php echo $data[
                        "customer"
                    ]["id"]; ?>&service_id=<?php echo $service[
    "id"
]; ?>" class="btn btn-sm" onclick="event.stopPropagation();">
                        <?php echo $service["has_override"]
                            ? "Edit"
                            : "Override"; ?>
                    </a>
                </div>
            </div>
            <div class="tier-content" id="tiers-cust-<?php echo $service[
                "id"
            ]; ?>" style="padding: 0 15px 15px 15px;">
                <?php if (!empty($service["tiers"])): ?>
                <table style="margin-top: 10px; font-size: 13px;">
                    <thead>
                        <tr>
                            <th style="padding: 6px 10px;">Volume Start</th>
                            <th style="padding: 6px 10px;">Volume End</th>
                            <th style="padding: 6px 10px;">Price Per Inquiry</th>
                            <th style="padding: 6px 10px;">Source</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($service["tiers"] as $tier): ?>
                        <tr>
                            <td style="padding: 6px 10px;"><?php echo number_format(
                                $tier["volume_start"]
                            ); ?></td>
                            <td style="padding: 6px 10px;"><?php echo $tier[
                                "volume_end"
                            ] !== null
                                ? number_format($tier["volume_end"])
                                : "<em>Unlimited</em>"; ?></td>
                            <td style="padding: 6px 10px;">$<?php echo number_format(
                                $tier["price_per_inquiry"],
                                4
                            ); ?></td>
                            <td style="padding: 6px 10px;">
                                <?php if ($tier["source"] === "customer"): ?>
                                    <span style="color: #27ae60;">Customer</span>
                                <?php elseif ($tier["source"] === "group"): ?>
                                    <span style="color: #3498db;">Group</span>
                                <?php else: ?>
                                    <span class="text-muted">Default</span>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
                <?php else: ?>
                    <p class="text-muted" style="margin-top: 10px;">No tiers defined.</p>
                <?php endif; ?>
            </div>
        </div>
        <?php endforeach; ?>
    </div>

    <script>
    function toggleTiers(id) {
        var el = document.getElementById('tiers-' + id);
        var icon = document.getElementById('icon-' + id);
        if (el.style.display === 'none') {
            el.style.display = 'block';
            icon.innerHTML = '&#9650;';
        } else {
            el.style.display = 'none';
            icon.innerHTML = '&#9660;';
        }
    }
    function expandAll() {
        var contents = document.querySelectorAll('.tier-content');
        var icons = document.querySelectorAll('.toggle-icon');
        for (var i = 0; i < contents.length; i++) {
            contents[i].style.display = 'block';
        }
        for (var i = 0; i < icons.length; i++) {
            icons[i].innerHTML = '&#9650;';
        }
    }
    function collapseAll() {
        var contents = document.querySelectorAll('.tier-content');
        var icons = document.querySelectorAll('.toggle-icon');
        for (var i = 0; i < contents.length; i++) {
            contents[i].style.display = 'none';
        }
        for (var i = 0; i < icons.length; i++) {
            icons[i].innerHTML = '&#9660;';
        }
    }
    </script>

    <div class="breadcrumb"><a href="?action=pricing_customers">Customers</a><span>/</span><?php echo h($data["customer"]["name"]); ?></div>
<?php
} /**
 * Render customer tier edit form
 */
function render_pricing_customer_edit($data)
{
    render_header("Edit Customer Pricing - " . h($data["customer"]["name"])); ?>
    <div class="card">
        <h2><?php echo h(
            $data["customer"]["name"]
        ); ?>: <?php echo h($data["service"]["name"]); ?></h2>

        <?php if ($data["has_override"]): ?>
            <p class="text-muted mb-20">
                <span style="color: #27ae60;">This customer has custom pricing.</span>
                Modify tiers below or clear to inherit from <?php echo $data[
                    "customer"
                ]["group_name"]
                    ? "group"
                    : "defaults"; ?>.
            </p>
        <?php else: ?>
            <p class="text-muted mb-20">
                Currently inheriting from
                <strong style="color: <?php echo $data["source"] === "group"
                    ? "#3498db"
                    : "#999"; ?>;">
                    <?php echo $data["source"] === "group"
                        ? $data["customer"]["group_name"] . " (Group)"
                        : "System Defaults"; ?>
                </strong>.
                Save to create a customer override.
            </p>
        <?php endif; ?>

        <form method="post" id="tier-form">
            <table id="tiers-table">
                <thead>
                    <tr>
                        <th>Volume Start</th>
                        <th>Volume End</th>
                        <th>Price Per Inquiry</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (empty($data["tiers"])): ?>
                    <tr class="tier-row">
                        <td><input type="number" name="volume_start[]" class="form-control" value="0" min="0" required></td>
                        <td><input type="number" name="volume_end[]" class="form-control" placeholder="Unlimited" min="0"></td>
                        <td><input type="number" name="price_per_inquiry[]" class="form-control" step="0.01" min="0" required></td>
                        <td><button type="button" class="btn btn-sm" onclick="removeRow(this)">Remove</button></td>
                    </tr>
                    <?php else: ?>
                        <?php foreach ($data["tiers"] as $tier): ?>
                        <tr class="tier-row">
                            <td><input type="number" name="volume_start[]" class="form-control" value="<?php echo h(
                                $tier["volume_start"]
                            ); ?>" min="0" required></td>
                            <td><input type="number" name="volume_end[]" class="form-control" value="<?php echo $tier[
                                "volume_end"
                            ] !== null
                                ? h($tier["volume_end"])
                                : ""; ?>" placeholder="Unlimited" min="0"></td>
                            <td><input type="number" name="price_per_inquiry[]" class="form-control" value="<?php echo h(
                                $tier["price_per_inquiry"]
                            ); ?>" step="0.01" min="0" required></td>
                            <td><button type="button" class="btn btn-sm" onclick="removeRow(this)">Remove</button></td>
                        </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>

            <div style="margin: 15px 0;">
                <button type="button" class="btn" onclick="addRow()">+ Add Tier</button>
            </div>

            <div style="margin-top: 20px;">
                <button type="submit" name="form_action" value="save" class="btn btn-success">Save Customer Pricing</button>
                <?php if ($data["has_override"]): ?>
                    <button type="submit" name="form_action" value="clear" class="btn" onclick="return confirm('Clear override and inherit from <?php echo $data[
                        "customer"
                    ]["group_name"]
                        ? "group"
                        : "defaults"; ?>?')">Clear Override</button>
                <?php endif; ?>
                <a href="?action=pricing_customer_edit&customer_id=<?php echo $data[
                    "customer"
                ]["id"]; ?>" class="btn">Cancel</a>
            </div>
        </form>
    </div>

    <script>
    function addRow() {
        var tbody = document.querySelector('#tiers-table tbody');
        var lastRow = tbody.querySelector('.tier-row:last-child');
        var nextStart = 0;

        if (lastRow) {
            var endInput = lastRow.querySelector('input[name="volume_end[]"]');
            if (endInput.value) {
                nextStart = parseInt(endInput.value) + 1;
            }
        }

        var row = document.createElement('tr');
        row.className = 'tier-row';
        row.innerHTML = '<td><input type="number" name="volume_start[]" class="form-control" value="' + nextStart + '" min="0" required></td>' +
            '<td><input type="number" name="volume_end[]" class="form-control" placeholder="Unlimited" min="0"></td>' +
            '<td><input type="number" name="price_per_inquiry[]" class="form-control" step="0.01" min="0" required></td>' +
            '<td><button type="button" class="btn btn-sm" onclick="removeRow(this)">Remove</button></td>';
        tbody.appendChild(row);
    }

    function removeRow(btn) {
        var rows = document.querySelectorAll('.tier-row');
        if (rows.length > 1) {
            btn.closest('tr').remove();
        }
    }
    </script>

    <p style="margin-top: 20px;"><a href="?action=pricing_customer_edit&customer_id=<?php echo $data[
        "customer"
    ]["id"]; ?>">&larr; Back to Services</a></p>
<?php
} /**
 * Render customer settings form (monthly minimum, annualized, etc.)
 */
function render_pricing_customer_settings($data)
{
    render_header("Customer Settings - " . h($data["customer"]["name"])); ?>
    <div class="card">
        <h2><?php echo h($data["customer"]["name"]); ?></h2>
        <p class="text-muted mb-20">
            <?php if ($data["customer"]["group_name"]): ?>
                Group: <strong><?php echo h(
                    $data["customer"]["group_name"]
                ); ?></strong> |
            <?php else: ?>
                <span style="color: #e67e22;">No discount group</span> |
            <?php endif; ?>
            Status:
            <?php
            $status_class = "";
            if ($data["customer"]["status"] === "active") {
                $status_class = "color: #27ae60;";
            } elseif ($data["customer"]["status"] === "paused") {
                $status_class = "color: #f39c12;";
            } else {
                $status_class = "color: #e74c3c;";
            }
            ?>
            <span style="<?php echo $status_class; ?>"><?php echo ucfirst($data["customer"]["status"]); ?></span>
        </p>

        <div style="margin-bottom: 20px;">
            <a href="?action=pricing_customer_edit&customer_id=<?php echo $data[
                "customer"
            ][
                "id"
            ]; ?>&tab=services" class="btn <?php echo $data["tab"] === "services" ? "btn-success" : ""; ?>">Service Pricing</a>
            <a href="?action=pricing_customer_edit&customer_id=<?php echo $data[
                "customer"
            ][
                "id"
            ]; ?>&tab=settings" class="btn <?php echo $data["tab"] === "settings" ? "btn-success" : ""; ?>">Settings</a>
            <a href="?action=escalator_edit&customer_id=<?php echo $data[
                "customer"
            ]["id"]; ?>" class="btn">Escalators</a>
        </div>
    </div>

    <div class="card">
        <h2>Customer Settings</h2>

        <form method="post">
            <div class="form-group">
                <label for="lms_id">LMS (Loan Management System) <span style="color: #dc3545;">*</span></label>
                <select name="lms_id" id="lms_id" class="form-control" style="width: 300px;">
                    <option value="">-- Select LMS --</option>
                    <?php foreach ($data["all_lms"] as $lms): ?>
                    <option value="<?php echo $lms["id"]; ?>" <?php echo $data[
    "customer"
]["lms_id"] == $lms["id"]
    ? "selected"
    : ""; ?>>
                        <?php echo h($lms["name"]); ?>
                    </option>
                    <?php endforeach; ?>
                </select>
                <small class="text-muted">Required for billing calculations. <a href="?action=lms&sync=1">Sync LMS list</a> if empty.</small>
                <?php if (empty($data["customer"]["lms_id"])): ?>
                <div style="margin-top: 8px; padding: 10px; background: #f8d7da; border-radius: 4px; font-size: 13px; color: #721c24;">
                    <strong>Warning:</strong> This customer has no LMS assigned. LMS is required for revenue/commission calculations.
                </div>
                <?php endif; ?>
            </div>

            <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">

            <div class="form-group">
                <label for="monthly_minimum">Monthly Minimum ($)</label>
                <input type="number" name="monthly_minimum" id="monthly_minimum" class="form-control"
                        value="<?php echo $data["settings"][
                            "monthly_minimum"
                        ] !== null
                            ? h($data["settings"]["monthly_minimum"])
                            : ""; ?>"
                        step="0.01" min="0" placeholder="No minimum">
                <small class="text-muted">Leave empty for no minimum charge. When set, if the customer's monthly usage is below this amount, a "gap" line item will be added to bring the invoice total to this minimum.</small>
                <?php if (
                    $data["settings"]["monthly_minimum"] &&
                    $data["settings"]["monthly_minimum"] > 0
                ): ?>
                <div style="margin-top: 8px; padding: 10px; background: #e8f4fd; border-radius: 4px; font-size: 13px;">
                    <strong>Current Minimum:</strong> $<?php echo number_format(
                        $data["settings"]["monthly_minimum"],
                        2
                    ); ?>/month
                    <br><span class="text-muted">If monthly usage &lt; $<?php echo number_format(
                        $data["settings"]["monthly_minimum"],
                        2
                    ); ?>, a gap line item will be added.</span>
                </div>
                <?php endif; ?>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="uses_annualized" value="1"
                            <?php echo $data["settings"]["uses_annualized"]
                                ? "checked"
                                : ""; ?>>
                    Uses Annualized Tiers
                </label>
                <small class="text-muted" style="display: block;">Enable volume calculation over a look-back period.</small>
            </div>

            <div class="form-group">
                <label for="annualized_start_date">Annualized Start Date</label>
                <input type="date" name="annualized_start_date" id="annualized_start_date" class="form-control"
                        value="<?php echo $data["settings"][
                            "annualized_start_date"
                        ]
                            ? h($data["settings"]["annualized_start_date"])
                            : ""; ?>">
                <small class="text-muted">When annualized tier calculation begins.</small>
            </div>

            <div class="form-group">
                <label for="look_period_months">Look Period (Months)</label>
                <input type="number" name="look_period_months" id="look_period_months" class="form-control"
                        value="<?php echo $data["settings"][
                            "look_period_months"
                        ] !== null
                            ? h($data["settings"]["look_period_months"])
                            : ""; ?>"
                        min="1" max="12" placeholder="e.g., 6">
                <small class="text-muted">Number of months to look back for volume calculation.</small>
            </div>

            <div style="margin-top: 20px;">
                <button type="submit" class="btn btn-success">Save Settings</button>
                <a href="?action=pricing_customer_edit&customer_id=<?php echo $data[
                    "customer"
                ]["id"]; ?>" class="btn">Cancel</a>
            </div>
        </form>
    </div>

    <div class="breadcrumb" style="margin-top: 20px;"><a href="?action=pricing_customers">Customers</a><span>/</span>Edit Tiers</div>
<?php
}
/**
 * Render escalators list (customers with escalators)
 */
function render_escalators($data)
{
    render_header("Escalators"); ?>
    <div class="card">
        <h2>Customer Escalators</h2>
        <p class="text-muted mb-20">Annual price increases scheduled per customer contract.</p>

        <?php
        $search_val = isset($data["search"]) ? $data["search"] : "";
        render_search_bar("escalators", [
            "search" => $search_val,
            "placeholder" => "Search customers..."
        ]);
        ?>

        <?php if (empty($data["customers"])): ?>
            <p class="text-muted">No customers have escalators configured.</p>
            <p><a href="?action=pricing_customers" class="btn">Go to Customers</a> to add escalators to a customer.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Group</th>
                        <th>Start Date</th>
                        <th>Years Defined</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["customers"] as $customer): ?>
                    <tr>
                        <td><strong><?php echo h(
                            $customer["name"]
                        ); ?></strong></td>
                        <td><?php echo $customer["group_name"]
                            ? h($customer["group_name"])
                            : '<span class="text-muted">None</span>'; ?></td>
                        <td><?php echo isset($customer["start_date"])
                            ? h($customer["start_date"])
                            : "-"; ?></td>
                        <td><?php echo $customer[
                            "escalator_count"
                        ]; ?> years</td>
                        <td class="text-right">
                            <a href="?action=escalator_edit&customer_id=<?php echo $customer[
                                "id"
                            ]; ?>" class="btn btn-sm">Edit</a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

            <?php
            $pag_params = [];
            if (!empty($data["search"])) {
                $pag_params["search"] = $data["search"];
            }
            render_pagination($data["pagination"], "?action=escalators", $pag_params);
            ?>
        <?php endif; ?>
    </div>

    <div class="card">
        <h2>Add Escalators</h2>
        <p class="text-muted">To add escalators to a customer, go to their customer pricing page.</p>
        <a href="?action=pricing_customers" class="btn">Go to Customers</a>
    </div>
<?php
} /**
 * Render escalator edit form for a customer
 */
function render_escalator_edit($data)
{
    render_header("Edit Escalators - " . h($data["customer"]["name"]));
    $start_date = "";
    if (!empty($data["escalators"])) {
        $start_date = $data["escalators"][0]["escalator_start_date"];
    } elseif ($data["customer"]["contract_start_date"]) {
        $start_date = $data["customer"]["contract_start_date"];
    }
    ?>
    <div class="card">
        <h2><?php echo h($data["customer"]["name"]); ?> - Escalators</h2>
        <p class="text-muted mb-20">
            Define annual price increases. Year 1 typically has 0% (base contract year).
            Use the Delay button to push an escalator back by 1 month.
        </p>

        <form method="post" id="escalator-form">
            <div class="form-group">
                <label for="escalator_start_date">Escalator Start Date</label>
                <input type="date" name="escalator_start_date" id="escalator_start_date" class="form-control"
                        value="<?php echo h($start_date); ?>" required>
                <small class="text-muted">Usually the contract start date. Escalators apply annually from this date.</small>
            </div>

            <table id="escalator-table" style="margin-top: 20px;">
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Percentage Increase (%)</th>
                        <th>Fixed Adjustment ($)</th>
                        <th>Total Delay</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <?php if (empty($data["escalators"])): ?>
                    <tr class="escalator-row">
                        <td><input type="number" name="year_number[]" class="form-control" value="1" min="1" required readonly style="width: 80px;"></td>
                        <td><input type="number" name="escalator_percentage[]" class="form-control" value="0" step="0.1" min="0"></td>
                        <td><input type="number" name="fixed_adjustment[]" class="form-control" value="0" step="0.01"></td>
                        <td><span class="text-muted">-</span></td>
                        <td><button type="button" class="btn btn-sm" onclick="removeEscalatorRow(this)">Remove</button></td>
                    </tr>
                    <?php else: ?>
                        <?php foreach ($data["escalators"] as $esc): ?>
                        <tr class="escalator-row">
                            <td><input type="number" name="year_number[]" class="form-control" value="<?php echo h(
                                $esc["year_number"]
                            ); ?>" min="1" required readonly style="width: 80px;"></td>
                            <td><input type="number" name="escalator_percentage[]" class="form-control" value="<?php echo h(
                                $esc["escalator_percentage"]
                            ); ?>" step="0.1" min="0"></td>
                            <td><input type="number" name="fixed_adjustment[]" class="form-control" value="<?php echo h(
                                $esc["fixed_adjustment"]
                            ); ?>" step="0.01"></td>
                            <td>
                                <?php if ($esc["total_delay"] > 0): ?>
                                    <span style="color: #e67e22;"><?php echo $esc[
                                        "total_delay"
                                    ]; ?> month<?php echo $esc["total_delay"] >
 1
     ? "s"
     : ""; ?></span>
                                <?php else: ?>
                                    <span class="text-muted">-</span>
                                <?php endif; ?>
                                <a href="?action=escalator_delay&customer_id=<?php echo $data[
                                    "customer"
                                ]["id"]; ?>&year_number=<?php echo $esc[
    "year_number"
]; ?>"
                                    class="btn btn-sm" style="margin-left: 5px;"
                                    onclick="return confirm('Add 1 month delay to Year <?php echo $esc[
                                        "year_number"
                                    ]; ?>?')">+1 Month</a>
                            </td>
                            <td><button type="button" class="btn btn-sm" onclick="removeEscalatorRow(this)">Remove</button></td>
                        </tr>
                        <?php endforeach; ?>
                    <?php endif; ?>
                </tbody>
            </table>

            <div style="margin: 15px 0;">
                <button type="button" class="btn" onclick="addEscalatorRow()">+ Add Year</button>
            </div>

            <div style="margin-top: 20px;">
                <button type="submit" class="btn btn-success">Save Escalators</button>
                <a href="?action=escalators" class="btn">Cancel</a>
            </div>
        </form>
    </div>

    <script>
    function addEscalatorRow() {
        var tbody = document.querySelector('#escalator-table tbody');
        var rows = tbody.querySelectorAll('.escalator-row');
        var nextYear = rows.length + 1;

        // Find max year
        rows.forEach(function(row) {
            var yearInput = row.querySelector('input[name="year_number[]"]');
            if (yearInput && parseInt(yearInput.value) >= nextYear) {
                nextYear = parseInt(yearInput.value) + 1;
            }
        });

        var row = document.createElement('tr');
        row.className = 'escalator-row';
        row.innerHTML = '<td><input type="number" name="year_number[]" class="form-control" value="' + nextYear + '" min="1" required readonly style="width: 80px;"></td>' +
            '<td><input type="number" name="escalator_percentage[]" class="form-control" value="0" step="0.1" min="0"></td>' +
            '<td><input type="number" name="fixed_adjustment[]" class="form-control" value="0" step="0.01"></td>' +
            '<td><span class="text-muted">-</span>' +
            '<a href="?action=escalator_delay&customer_id=<?php echo $data[
                "customer"
            ][
                "id"
            ]; ?>&year_number=' + nextYear + '" class="btn btn-sm" style="margin-left: 5px;" onclick="return confirm(\'Add 1 month delay to Year ' + nextYear + '?\')">+1 Month</a></td>' +
            '<td><button type="button" class="btn btn-sm" onclick="removeEscalatorRow(this)">Remove</button></td>';
        tbody.appendChild(row);
    }

    function removeEscalatorRow(btn) {
        var rows = document.querySelectorAll('.escalator-row');
        if (rows.length > 1) {
            btn.closest('tr').remove();
        }
    }
    </script>

    <div class="breadcrumb" style="margin-top: 20px;"><a href="?action=escalators">Escalators</a><span>/</span>Edit</div>
<?php
} /**
 * Render business rules list (customers with rules)
 */
function render_business_rules($data)
{
    render_header("Business Rules"); ?>
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Business Rules by Customer</h2>
            <a href="?action=business_rules_all" class="btn btn-info">View All Rules</a>
        </div>
        <p class="text-muted mb-20">Rules are synced from the remote database. You can mask/unmask rules to control billing behavior.</p>

        <?php
        $search_val = isset($data["search"]) ? $data["search"] : "";
        render_search_bar("business_rules", [
            "search" => $search_val,
            "placeholder" => "Search customers..."
        ]);
        ?>

        <?php if (empty($data["customers"])): ?>
            <p class="text-muted">No customers have business rules configured.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Group</th>
                        <th>Total Rules</th>
                        <th>Masked</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["customers"] as $customer): ?>
                    <tr>
                        <td><strong><?php echo h(
                            $customer["name"]
                        ); ?></strong></td>
                        <td><?php echo $customer["group_name"]
                            ? h($customer["group_name"])
                            : '<span class="text-muted">None</span>'; ?></td>
                        <td><?php echo $customer["rule_count"]; ?> rules</td>
                        <td>
                            <?php if ($customer["masked_count"] > 0): ?>
                                <span style="color: #e67e22;"><?php echo $customer[
                                    "masked_count"
                                ]; ?> masked</span>
                            <?php else: ?>
                                <span class="text-muted">None</span>
                            <?php endif; ?>
                        </td>
                        <td class="text-right">
                            <a href="?action=business_rule_edit&customer_id=<?php echo $customer[
                                "id"
                            ]; ?>" class="btn btn-sm">Manage</a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

            <?php
            $pag_params = [];
            if (!empty($data["search"])) {
                $pag_params["search"] = $data["search"];
            }
            render_pagination($data["pagination"], "?action=business_rules", $pag_params);
            ?>
        <?php endif; ?>
    </div>
<?php
}

/**
 * Render all business rules view
 */
function render_business_rules_all($data)
{
    render_header("All Business Rules"); ?>
    <div class="breadcrumb"><a href="?action=business_rules">Rules by Customer</a><span>/</span>All Rules</div>

    <div class="card">
        <h2>All Business Rules</h2>

        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 4px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold;"><?php echo $data["stats"]["total_rules"]; ?></div>
                <div style="color: #666; font-size: 13px;">Total Rules</div>
            </div>
            <div style="flex: 1; background: #fff3cd; padding: 15px; border-radius: 4px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #856404;"><?php echo $data["stats"]["masked_rules"]; ?></div>
                <div style="color: #666; font-size: 13px;">Masked Rules</div>
            </div>
            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 4px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold;"><?php echo $data["stats"]["customers_with_rules"]; ?></div>
                <div style="color: #666; font-size: 13px;">Customers</div>
            </div>
        </div>

        <?php
        render_search_bar("business_rules_all", [
            "search" => $data["search"],
            "placeholder" => "Search rules or customers...",
            "filters" => [
                [
                    "name" => "masked",
                    "options" => [
                        "" => "All Rules",
                        "1" => "Masked Only",
                        "0" => "Unmasked Only"
                    ],
                    "current" => $data["filter_masked"]
                ]
            ]
        ]);
        ?>

        <?php if (empty($data["rules"])): ?>
            <p class="text-muted">No rules found.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Rule Name</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["rules"] as $rule): ?>
                    <tr style="<?php echo $rule["is_masked"] ? "background: #fff3cd;" : ""; ?>">
                        <td>
                            <a href="?action=business_rule_edit&customer_id=<?php echo $rule["customer_id"]; ?>"><?php echo h($rule["customer_name"]); ?></a>
                            <?php if ($rule["customer_status"] !== "active"): ?>
                                <span class="badge badge-<?php echo $rule["customer_status"] === "paused" ? "warning" : "default"; ?>"><?php echo $rule["customer_status"]; ?></span>
                            <?php endif; ?>
                        </td>
                        <td><code style="font-size: 12px;"><?php echo h($rule["rule_name"]); ?></code></td>
                        <td class="text-muted" style="font-size: 12px;"><?php echo h($rule["rule_description"] ?: "-"); ?></td>
                        <td>
                            <?php if ($rule["is_masked"]): ?>
                                <span class="badge badge-warning">Masked</span>
                            <?php else: ?>
                                <span class="badge badge-success">Active</span>
                            <?php endif; ?>
                        </td>
                        <td class="text-right">
                            <a href="?action=business_rule_toggle&customer_id=<?php echo $rule["customer_id"]; ?>&rule=<?php echo urlencode($rule["rule_name"]); ?>&return=all" class="btn btn-sm">
                                <?php echo $rule["is_masked"] ? "Unmask" : "Mask"; ?>
                            </a>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

            <?php
            $pag_params = [];
            if (!empty($data["search"])) {
                $pag_params["search"] = $data["search"];
            }
            if ($data["filter_masked"] !== null) {
                $pag_params["masked"] = $data["filter_masked"];
            }
            render_pagination($data["pagination"], "?action=business_rules_all", $pag_params);
            ?>
        <?php endif; ?>
    </div>
<?php
}

/**
 * Render business rule edit for a customer
 */
function render_business_rule_edit($data)
{
    render_header("Business Rules - " . h($data["customer"]["name"])); ?>
    <div class="card">
        <h2><?php echo h($data["customer"]["name"]); ?> - Business Rules</h2>
        <p class="text-muted mb-20">
            Masked rules are excluded from billing calculations. Toggle a rule's status using the buttons below.
        </p>

        <?php if (empty($data["rules"])): ?>
            <p class="text-muted">No business rules defined for this customer.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Rule Name</th>
                        <th>Description</th>
                        <th>Status</th>
                        <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["rules"] as $rule): ?>
                    <tr>
                        <td><strong><?php echo h(
                            $rule["rule_name"]
                        ); ?></strong></td>
                        <td><?php echo $rule["rule_description"]
                            ? h($rule["rule_description"])
                            : '<span class="text-muted">No description</span>'; ?></td>
                        <td>
                            <?php if ($rule["is_masked"]): ?>
                                <span style="color: #e67e22; font-weight: bold;">MASKED</span>
                            <?php else: ?>
                                <span style="color: #27ae60;">Active</span>
                            <?php endif; ?>
                        </td>
                        <td class="text-right">
                            <?php if ($rule["is_masked"]): ?>
                                <a href="?action=business_rule_toggle&customer_id=<?php echo $data[
                                    "customer"
                                ]["id"]; ?>&rule_name=<?php echo urlencode(
    $rule["rule_name"]
); ?>&mask_action=unmask"
                                    class="btn btn-sm btn-success"
                                    onclick="return confirm('Unmask this rule? It will be included in billing.')">Unmask</a>
                            <?php else: ?>
                                <a href="?action=business_rule_toggle&customer_id=<?php echo $data[
                                    "customer"
                                ]["id"]; ?>&rule_name=<?php echo urlencode(
    $rule["rule_name"]
); ?>&mask_action=mask"
                                    class="btn btn-sm"
                                    onclick="return confirm('Mask this rule? It will be excluded from billing.')">Mask</a>
                            <?php endif; ?>
                        </td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>
        <?php endif; ?>
    </div>

    <div class="breadcrumb"><a href="?action=business_rules">Rules</a><span>/</span><?php echo h($data["customer"]["name"]); ?></div>
<?php
}
/**
 * Render history/audit trail
 */ function render_history($data)
{
    render_header("History - Audit Trail"); ?>
    <div class="card">
        <h2>Change History</h2>
        <p class="text-muted mb-20">Audit trail of all configuration changes. Data is append-only with effective dates.</p>

        <form method="get" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
            <input type="hidden" name="action" value="history">

            <label>Category:</label>
            <select name="filter" class="form-control" style="width: auto;">
                <option value="all" <?php echo $data["filter"] === "all"
                    ? "selected"
                    : ""; ?>>All Changes</option>
                <option value="pricing" <?php echo $data["filter"] === "pricing"
                    ? "selected"
                    : ""; ?>>Pricing Tiers</option>
                <option value="settings" <?php echo $data["filter"] ===
                "settings"
                    ? "selected"
                    : ""; ?>>Customer Settings</option>
                <option value="escalators" <?php echo $data["filter"] ===
                "escalators"
                    ? "selected"
                    : ""; ?>>Escalators</option>
                <option value="rules" <?php echo $data["filter"] === "rules"
                    ? "selected"
                    : ""; ?>>Business Rules</option>
            </select>

            <label>Customer:</label>
            <select name="customer_id" class="form-control" style="width: auto;">
                <option value="">All Customers</option>
                <?php foreach ($data["customers"] as $customer): ?>
                    <option value="<?php echo $customer[
                        "id"
                    ]; ?>" <?php echo $data["customer_id"] == $customer["id"]
    ? "selected"
    : ""; ?>>
                        <?php echo h($customer["name"]); ?>
                    </option>
                <?php endforeach; ?>
            </select>

            <button type="submit" class="btn">Filter</button>
        </form>

        <?php if (empty($data["history"])): ?>
            <p class="text-muted">No history records found.</p>
        <?php else: ?>
            <table>
                <thead>
                    <tr>
                        <th>Date/Time</th>
                        <th>Category</th>
                        <th>Effective Date</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <?php foreach ($data["history"] as $item): ?>
                    <tr>
                        <td style="white-space: nowrap;"><?php echo h(
                            $item["date"]
                        ); ?></td>
                        <td>
                            <?php
                            $cat_colors = [
                                "pricing" => "#3498db",
                                "settings" => "#9b59b6",
                                "escalators" => "#e67e22",
                                "rules" => "#1abc9c",
                            ];
                            $cat_color = isset($cat_colors[$item["category"]])
                                ? $cat_colors[$item["category"]]
                                : "#999";
                            ?>
                            <span style="background: <?php echo $cat_color; ?>; color: #fff; padding: 2px 8px; border-radius: 3px; font-size: 11px; text-transform: uppercase;">
                                <?php echo h($item["category"]); ?>
                            </span>
                        </td>
                        <td style="white-space: nowrap;"><?php echo h(
                            $item["effective_date"]
                        ); ?></td>
                        <td><?php echo h($item["description"]); ?></td>
                    </tr>
                    <?php endforeach; ?>
                </tbody>
            </table>

            <?php
            $pag_params = ["filter" => $data["filter"]];
            if ($data["customer_id"]) {
                $pag_params["customer_id"] = $data["customer_id"];
            }
            render_pagination($data["pagination"], "?action=history", $pag_params);
            ?>
        <?php endif; ?>
    </div>
<?php render_footer();
}

/**
 * Render billing calendar year view
 */
function render_calendar($data)
{
    render_header("Billing Calendar - " . $data["year"]); ?>
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Billing Calendar <?php echo $data["year"]; ?></h2>
            <div>
                <a href="?action=calendar&year=<?php echo $data["year"] -
                    1; ?>" class="btn btn-sm">&larr; <?php echo $data["year"] - 1; ?></a>
                <a href="?action=calendar&year=<?php echo date(
                    "Y"
                ); ?>" class="btn btn-sm">Today</a>
                <a href="?action=calendar&year=<?php echo $data["year"] +
                    1; ?>" class="btn btn-sm"><?php echo $data["year"] + 1; ?> &rarr;</a>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
            <?php foreach ($data["months"] as $month): ?>
            <a href="?action=calendar_month&year=<?php echo $month[
                "year"
            ]; ?>&month=<?php echo $month["month"]; ?>"
                style="text-decoration: none; color: inherit;">
                <div style="border: 2px solid <?php if ($month["is_current"]) {
                    echo "#007bff";
                } elseif ($month["is_complete"]) {
                    echo "#28a745";
                } elseif ($month["is_past"]) {
                    echo "#dc3545";
                } else {
                    echo "#ddd";
                } ?>; border-radius: 8px; padding: 15px; text-align: center; background: <?php if (
    $month["is_complete"]
) {
    echo "#d4edda";
} elseif ($month["is_current"]) {
    echo "#e3f2fd";
} else {
    echo "#fff";
} ?>; transition: transform 0.1s; cursor: pointer;"
                    onmouseover="this.style.transform='scale(1.02)'"
                    onmouseout="this.style.transform='scale(1)'">

                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">
                        <?php echo $month["month_name"]; ?>
                    </div>

                    <div style="display: flex; justify-content: center; gap: 10px; font-size: 12px;">
                        <?php if ($month["event_count"] > 0): ?>
                            <span style="background: #e67e22; color: white; padding: 2px 6px; border-radius: 10px;">
                                <?php echo $month[
                                    "event_count"
                                ]; ?> event<?php echo $month["event_count"] > 1
     ? "s"
     : ""; ?>
                            </span>
                        <?php endif; ?>

                        <?php if ($month["warning_count"] > 0): ?>
                            <span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 10px;">
                                <?php echo $month[
                                    "warning_count"
                                ]; ?> warning<?php echo $month[
     "warning_count"
 ] > 1
     ? "s"
     : ""; ?>
                            </span>
                        <?php endif; ?>
                    </div>

                    <div style="margin-top: 8px; font-size: 11px; color: #666;">
                        <?php if ($month["is_complete"]): ?>
                            <span style="color: #28a745;">&#10003; Complete</span>
                        <?php elseif ($month["is_past"]): ?>
                            <span style="color: #dc3545;">&#9888; Incomplete</span>
                        <?php elseif ($month["is_current"]): ?>
                            <span style="color: #007bff;">&#9679; Current Month</span>
                        <?php else: ?>
                            <span>Upcoming</span>
                        <?php endif; ?>
                    </div>
                </div>
            </a>
            <?php endforeach; ?>
        </div>

        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; flex: 1; min-width: 150px; text-align: center; margin-bottom: 20px;">
            <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">Progress Summary</div>
            <div style="display: flex; justify-content: space-around; font-size: 14px;">
                <span>Completed: <strong style="color: #28a745;"><?php echo $data[
                    "completed_months"
                ]; ?></strong></span>
                <span>Escalators: <strong style="color: #e67e22;"><?php echo $data[
                    "total_escalators"
                ]; ?></strong></span>
                <span>Resets: <strong style="color: #3498db;"><?php echo $data[
                    "total_resets"
                ]; ?></strong></span>
            </div>
            <a href="?action=calendar_month&year=<?php echo $data[
                "next_incomplete"
            ][
                "year"
            ]; ?>&month=<?php echo $data["next_incomplete"]["month"]; ?>"
                class="btn btn-sm btn-success" style="margin-top: 10px;">
                &#9989; What's Next? (<?php echo date(
                    "F Y",
                    mktime(
                        0,
                        0,
                        0,
                        $data["next_incomplete"]["month"],
                        1,
                        $data["next_incomplete"]["year"]
                    )
                ); ?>)
            </a>
        </div>

        <div class="card">
            <h3>Legend</h3>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 13px;">
                <div><span style="display: inline-block; width: 20px; height: 20px; background: #d4edda; border: 2px solid #28a745; border-radius: 3px; vertical-align: middle; margin-right: 5px;"></span> Complete (monthly report ingested)</div>
                <div><span style="display: inline-block; width: 20px; height: 20px; background: #e3f2fd; border: 2px solid #007bff; border-radius: 3px; vertical-align: middle; margin-right: 5px;"></span> Current Month</div>
                <div><span style="display: inline-block; width: 20px; height: 20px; background: #fff; border: 2px solid #dc3545; border-radius: 3px; vertical-align: middle; margin-right: 5px;"></span> Past &amp; Incomplete</div>
                <div><span style="display: inline-block; width: 20px; height: 20px; background: #fff; border: 2px solid #ddd; border-radius: 3px; vertical-align: middle; margin-right: 5px;"></span> Upcoming</div>
            </div>
        </div>
    </div>
<?php render_footer();
}
/**
 * Render billing calendar month checklist view
 */ function render_calendar_month($data)
{
    render_header(
        $data["month_name"] . " " . $data["year"] . " - Billing Checklist"
    ); ?>
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <a href="?action=calendar&year=<?php echo $data[
                    "year"
                ]; ?>" style="color: #666; text-decoration: none;">&larr; Back to Calendar</a>
                <h2 style="margin: 10px 0 0 0;">
                    <?php echo $data[
                        "month_name"
                    ]; ?> <?php echo $data["year"]; ?> Checklist
                    <?php if ($data["is_complete"]): ?>
                        <span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; margin-left: 10px;">COMPLETE</span>
                    <?php elseif ($data["is_current"]): ?>
                        <span style="background: #007bff; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; margin-left: 10px;">CURRENT</span>
                    <?php endif; ?>
                </h2>
            </div>
            <div>
                <a href="?action=calendar_month&year=<?php echo $data["prev"][
                    "year"
                ]; ?>&month=<?php echo $data["prev"]["month"]; ?>" class="btn btn-sm">&larr; Prev</a>
                <a href="?action=calendar_month&year=<?php echo date(
                    "Y"
                ); ?>&month=<?php echo date("n"); ?>" class="btn btn-sm">Today</a>
                <a href="?action=calendar_month&year=<?php echo $data["next"][
                    "year"
                ]; ?>&month=<?php echo $data["next"]["month"]; ?>" class="btn btn-sm">Next &rarr;</a>
            </div>
        </div>

        <?php if ($data["total_items"] === 0): ?>
            <div style="text-align: center; padding: 40px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 10px;">&#10003;</div>
                <div style="font-size: 18px;">No special items for this month</div>
                <div style="font-size: 13px; margin-top: 5px;">Standard billing should proceed normally</div>
            </div>
        <?php else: ?>

            <?php if (!empty($data["checklist"]["warnings"])): ?>
            <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #721c24;">&#9888; Warnings (<?php echo count(
                    $data["checklist"]["warnings"]
                ); ?>)</h3>
                <ul style="margin: 0; padding-left: 20px;">
                    <?php foreach ($data["checklist"]["warnings"] as $item): ?>
                        <li style="margin-bottom: 5px;">
                            <?php echo h($item["message"]); ?>
                            <?php if ($item["customer_id"]): ?>
                                <a href="?action=pricing_customer_edit&customer_id=<?php echo $item[
                                    "customer_id"
                                ]; ?>" style="font-size: 11px;">[view]</a>
                            <?php endif; ?>
                        </li>
                    <?php endforeach; ?>
                </ul>
            </div>
            <?php endif; ?>

            <?php if (!empty($data["checklist"]["whats_excluded"])): ?>
            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #856404;">&#10007; What's Excluded (<?php echo count(
                    $data["checklist"]["whats_excluded"]
                ); ?>)</h3>
                <p style="margin: 0 0 10px 0; font-size: 12px; color: #856404;">These customers will NOT be billed this month:</p>
                <ul style="margin: 0; padding-left: 20px;">
                    <?php foreach (
                        $data["checklist"]["whats_excluded"]
                        as $item
                    ): ?>
                        <li style="margin-bottom: 5px;">
                            <?php echo h($item["message"]); ?>
                            <a href="?action=pricing_customer_edit&customer_id=<?php echo $item[
                                "customer_id"
                            ]; ?>" style="font-size: 11px;">[view]</a>
                        </li>
                    <?php endforeach; ?>
                </ul>
            </div>
            <?php endif; ?>

            <?php if (!empty($data["checklist"]["whats_new"])): ?>
            <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #155724;">&#9733; What's New (<?php echo count(
                    $data["checklist"]["whats_new"]
                ); ?>)</h3>
                <p style="margin: 0 0 10px 0; font-size: 12px; color: #155724;">New customers added since last month - verify they are set up correctly:</p>
                <ul style="margin: 0; padding-left: 20px;">
                    <?php foreach ($data["checklist"]["whats_new"] as $item): ?>
                        <li style="margin-bottom: 5px;">
                            <?php echo h($item["message"]); ?>
                            <a href="?action=pricing_customer_edit&customer_id=<?php echo $item[
                                "customer_id"
                            ]; ?>" style="font-size: 11px;">[view config]</a>
                        </li>
                    <?php endforeach; ?>
                </ul>
            </div>
            <?php endif; ?>

            <?php if (!empty($data["checklist"]["whats_changing"])): ?>
            <div style="background: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #856404;">&#8593; What's Changing (<?php echo count(
                    $data["checklist"]["whats_changing"]
                ); ?>)</h3>
                <p style="margin: 0 0 10px 0; font-size: 12px; color: #856404;">Price changes taking effect this month:</p>
                <table style="width: 100%; font-size: 13px;">
                    <thead>
                        <tr style="text-align: left;">
                            <th>Type</th>
                            <th>Description</th>
                            <th>Effective</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach (
                            $data["checklist"]["whats_changing"]
                            as $item
                        ): ?>
                        <tr>
                            <td>
                                <span style="background: <?php echo $item[
                                    "type"
                                ] === "escalator"
                                    ? "#e67e22"
                                    : "#3498db"; ?>; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; text-transform: uppercase;">
                                    <?php echo h($item["type"]); ?>
                                </span>
                            </td>
                            <td><?php echo h($item["message"]); ?></td>
                            <td><?php echo h($item["effective_date"]); ?></td>
                            <td><a href="?action=pricing_customer_edit&customer_id=<?php echo $item[
                                "customer_id"
                            ]; ?>" style="font-size: 11px;">[view]</a></td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
            <?php endif; ?>

            <?php if (!empty($data["checklist"]["whats_different"])): ?>
            <div style="background: #e2e3e5; border: 1px solid #d6d8db; border-radius: 5px; padding: 15px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #383d41;">&#9881; Config Changes (<?php echo count(
                    $data["checklist"]["whats_different"]
                ); ?>)</h3>
                <p style="margin: 0 0 10px 0; font-size: 12px; color: #383d41;">Configuration changes made since last month:</p>
                <ul style="margin: 0; padding-left: 20px; font-size: 13px;">
                    <?php foreach (
                        array_slice(
                            $data["checklist"]["whats_different"],
                            0,
                            10
                        )
                        as $item
                    ): ?>
                        <li style="margin-bottom: 3px;">
                            <?php echo h($item["message"]); ?>
                            <span style="color: #999; font-size: 11px;">(<?php echo h(
                                $item["date"]
                            ); ?>)</span>
                        </li>
                    <?php endforeach; ?>
                    <?php if (
                        count($data["checklist"]["whats_different"]) > 10
                    ): ?>
                        <li style="color: #666;">...and <?php echo count(
                            $data["checklist"]["whats_different"]
                        ) - 10; ?> more</li>
                    <?php endif; ?>
                </ul>
            </div>
            <?php endif; ?>

        <?php endif; ?>
    </div>

    <?php if ($data["mtd"]["report_count"] > 0): ?>
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">Month-to-Date Summary</h3>
            <a href="?action=mtd_dashboard&year=<?php echo $data[
                "year"
            ]; ?>&month=<?php echo $data[
    "month"
]; ?>" class="btn btn-sm">View Full Dashboard &rarr;</a>
        </div>
        <p style="font-size: 12px; color: #666; margin: 10px 0 15px 0;">Based on <?php echo $data[
            "mtd"
        ]["report_count"]; ?> daily report(s), latest: <?php echo h(
     $data["mtd"]["latest_date"]
 ); ?></p>
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; flex: 1; min-width: 120px;">
                <div style="font-size: 24px; font-weight: bold;"><?php echo number_format(
                    $data["mtd"]["customer_count"]
                ); ?></div>
                <div style="color: #666; font-size: 12px;">Customers Billed</div>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; flex: 1; min-width: 120px;">
                <div style="font-size: 24px; font-weight: bold;"><?php echo number_format(
                    $data["mtd"]["total_transactions"]
                ); ?></div>
                <div style="color: #666; font-size: 12px;">Transactions</div>
            </div>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; flex: 1; min-width: 120px;">
                <div style="font-size: 24px; font-weight: bold;">$<?php echo number_format(
                    $data["mtd"]["total_revenue"],
                    2
                ); ?></div>
                <div style="color: #666; font-size: 12px;">Revenue MTD</div>
            </div>
        </div>
    </div>
    <?php endif; ?>

    <div class="card">
        <h3>Final Output</h3>
        <p>When ready, generate the monthly billing report:</p>
        <a href="?action=generation" class="btn btn-success">Go to Report Generation</a>
    </div>
<?php render_footer();
}
/**
 * Render Month-to-Date Dashboard
 */ function render_mtd_dashboard($data)
{
    render_header(
        "MTD Dashboard - " . $data["month_name"] . " " . $data["year"]
    ); ?>
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <a href="?action=calendar&year=<?php echo $data[
                    "year"
                ]; ?>" style="color: #666; text-decoration: none;">&larr; Back to Calendar</a>
                <h2 style="margin: 10px 0 0 0;">
                    <?php echo $data[
                        "month_name"
                    ]; ?> <?php echo $data["year"]; ?> - Month to Date
                    <?php if ($data["is_current"]): ?>
                        <span style="background: #007bff; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; margin-left: 10px;">LIVE</span>
                    <?php endif; ?>
                </h2>
                <?php if ($data["through_day"] > 0): ?>
                    <p style="color: #666; font-size: 13px; margin-top: 5px;">Data through day <?php echo $data[
                        "through_day"
                    ]; ?> (<?php echo $data["mtd"][
     "report_count"
 ]; ?> daily reports)</p>
                <?php endif; ?>
            </div>
            <div>
                <a href="?action=mtd_dashboard&year=<?php echo $data["prev"][
                    "year"
                ]; ?>&month=<?php echo $data["prev"]["month"]; ?>" class="btn btn-sm">&larr; Prev</a>
                <a href="?action=mtd_dashboard&year=<?php echo date(
                    "Y"
                ); ?>&month=<?php echo date("n"); ?>" class="btn btn-sm">Today</a>
                <a href="?action=mtd_dashboard&year=<?php echo $data["next"][
                    "year"
                ]; ?>&month=<?php echo $data["next"]["month"]; ?>" class="btn btn-sm">Next &rarr;</a>
            </div>
        </div>

        <?php if ($data["mtd"]["report_count"] == 0): ?>
            <div style="text-align: center; padding: 60px; color: #666;">
                <div style="font-size: 48px; margin-bottom: 15px;">&#128202;</div>
                <div style="font-size: 18px;">No daily reports for this month yet</div>
                <div style="font-size: 13px; margin-top: 5px;">Daily reports are automatically ingested to populate this dashboard</div>
                <div style="margin-top: 20px;">
                    <a href="?action=ingestion" class="btn">Go to Ingestion</a>
                </div>
            </div>
        <?php else: ?>

            <!-- Key Metrics -->
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 28px; font-weight: bold; color: #28a745;">$<?php echo number_format(
                        $data["mtd"]["total_revenue"],
                        2
                    ); ?></div>
                    <div style="color: #666; font-size: 12px; margin-top: 5px;">Revenue MTD</div>
                    <?php if ($data["prev_mtd"]["total_revenue"] > 0): ?>
                        <div style="font-size: 12px; margin-top: 8px; color: <?php echo $data[
                            "revenue_change"
                        ] >= 0
                            ? "#28a745"
                            : "#dc3545"; ?>;">
                            <?php echo $data["revenue_change"] >= 0
                                ? "&#9650;"
                                : "&#9660;"; ?>
                            <?php echo abs(
                                round($data["revenue_change"], 1)
                            ); ?>% vs last month
                        </div>
                    <?php endif; ?>
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 28px; font-weight: bold; color: #3498db;"><?php echo number_format(
                        $data["mtd"]["total_transactions"]
                    ); ?></div>
                    <div style="color: #666; font-size: 12px; margin-top: 5px;">Transactions MTD</div>
                    <?php if ($data["prev_mtd"]["total_transactions"] > 0): ?>
                        <div style="font-size: 12px; margin-top: 8px; color: <?php echo $data[
                            "trans_change"
                        ] >= 0
                            ? "#28a745"
                            : "#dc3545"; ?>;">
                            <?php echo $data["trans_change"] >= 0
                                ? "&#9650;"
                                : "&#9660;"; ?>
                            <?php echo abs(
                                round($data["trans_change"], 1)
                            ); ?>% vs last month
                        </div>
                    <?php endif; ?>
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 28px; font-weight: bold; color: #9b59b6;"><?php echo number_format(
                        $data["mtd"]["customer_count"]
                    ); ?></div>
                    <div style="color: #666; font-size: 12px; margin-top: 5px;">Active Customers</div>
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
                    <?php
                    $avg_per_day =
                        $data["through_day"] > 0
                            ? $data["mtd"]["total_revenue"] /
                                $data["through_day"]
                            : 0;
                    $days_in_month = date(
                        "t",
                        mktime(0, 0, 0, $data["month"], 1, $data["year"])
                    );
                    $projected = $avg_per_day * $days_in_month;
                    ?>
                    <div style="font-size: 28px; font-weight: bold; color: #e67e22;">$<?php echo number_format(
                        $projected,
                        2
                    ); ?></div>
                    <div style="color: #666; font-size: 12px; margin-top: 5px;">Projected Month End</div>
                    <div style="font-size: 11px; color: #999; margin-top: 5px;">Based on $<?php echo number_format(
                        $avg_per_day,
                        2
                    ); ?>/day avg</div>
                </div>
            </div>

            <!-- Daily Breakdown Chart (Text-based) -->
            <h3 style="margin-bottom: 15px;">Daily Revenue</h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 30px; overflow-x: auto;">
                <?php
                $max_revenue = 0;
                foreach ($data["cumulative"] as $day) {
                    if ($day["daily_revenue"] > $max_revenue) {
                        $max_revenue = $day["daily_revenue"];
                    }
                }
                ?>
                <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <th style="text-align: left; padding: 5px; width: 80px;">Date</th>
                            <th style="text-align: left; padding: 5px;">Revenue</th>
                            <th style="text-align: right; padding: 5px; width: 100px;">Amount</th>
                            <th style="text-align: right; padding: 5px; width: 100px;">Cumulative</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($data["cumulative"] as $day): ?>
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 5px;"><?php echo substr(
                                $day["date"],
                                5
                            ); ?></td>
                            <td style="padding: 5px;">
                                <?php $bar_width =
                                    $max_revenue > 0
                                        ? ($day["daily_revenue"] /
                                                $max_revenue) *
                                            100
                                        : 0; ?>
                                <div style="background: #28a745; height: 16px; width: <?php echo $bar_width; ?>%; min-width: 2px; border-radius: 2px;"></div>
                            </td>
                            <td style="text-align: right; padding: 5px;">$<?php echo number_format(
                                $day["daily_revenue"],
                                2
                            ); ?></td>
                            <td style="text-align: right; padding: 5px; color: #666;">$<?php echo number_format(
                                $day["cumulative_revenue"],
                                2
                            ); ?></td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>

            <!-- Service Breakdown -->
            <?php if (!empty($data["services"])): ?>
            <h3 style="margin-bottom: 15px;">Revenue by Service</h3>
            <div style="margin-bottom: 30px;">
                <table>
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th class="text-right">Transactions</th>
                            <th class="text-right">Revenue</th>
                            <th class="text-right">% of Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach ($data["services"] as $svc): ?>
                        <tr>
                            <td><?php echo h(
                                $svc["service_name"] ?: "(Unknown)"
                            ); ?></td>
                            <td class="text-right"><?php echo number_format(
                                $svc["transactions"]
                            ); ?></td>
                            <td class="text-right">$<?php echo number_format(
                                $svc["revenue"],
                                2
                            ); ?></td>
                            <td class="text-right">
                                <?php
                                $pct =
                                    $data["mtd"]["total_revenue"] > 0
                                        ? ($svc["revenue"] /
                                                $data["mtd"]["total_revenue"]) *
                                            100
                                        : 0;
                                echo number_format($pct, 1) . "%";
                                ?>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                    </tbody>
                </table>
            </div>
            <?php endif; ?>

            <!-- Top Customers -->
            <?php if (!empty($data["customers"])): ?>
            <h3 style="margin-bottom: 15px;">Top Customers</h3>
            <div style="margin-bottom: 20px;">
                <table>
                    <thead>
                        <tr>
                            <th>Customer</th>
                            <th class="text-right">Transactions</th>
                            <th class="text-right">Revenue</th>
                            <th class="text-right">% of Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php foreach (
                            array_slice($data["customers"], 0, 15)
                            as $cust
                        ): ?>
                        <tr>
                            <td>
                                <?php if ($cust["customer_id"]): ?>
                                    <a href="?action=pricing_customer_edit&customer_id=<?php echo $cust[
                                        "customer_id"
                                    ]; ?>">
                                        <?php echo h(
                                            $cust["customer_name"] ?:
                                            "Customer #" . $cust["customer_id"]
                                        ); ?>
                                    </a>
                                <?php else: ?>
                                    <?php echo h(
                                        $cust["customer_name"] ?: "(Unknown)"
                                    ); ?>
                                <?php endif; ?>
                            </td>
                            <td class="text-right"><?php echo number_format(
                                $cust["transactions"]
                            ); ?></td>
                            <td class="text-right">$<?php echo number_format(
                                $cust["revenue"],
                                2
                            ); ?></td>
                            <td class="text-right">
                                <?php
                                $pct =
                                    $data["mtd"]["total_revenue"] > 0
                                        ? ($cust["revenue"] /
                                                $data["mtd"]["total_revenue"]) *
                                            100
                                        : 0;
                                echo number_format($pct, 1) . "%";
                                ?>
                            </td>
                        </tr>
                        <?php endforeach; ?>
                        <?php if (count($data["customers"]) > 15): ?>
                        <tr>
                            <td colspan="4" style="text-align: center; color: #666; font-style: italic;">
                                ...and <?php echo count($data["customers"]) -
                                    15; ?> more customers
                            </td>
                        </tr>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
            <?php endif; ?>

        <?php endif; ?>
    </div>

    <div style="display: flex; gap: 15px;">
        <a href="?action=calendar_month&year=<?php echo $data[
            "year"
        ]; ?>&month=<?php echo $data["month"]; ?>" class="btn">View Month Checklist</a>
        <a href="?action=ingestion" class="btn">Manage Reports</a>
    </div>
<?php render_footer();
} /**
 * Render export options page
 */
function render_export()
{
    render_header("Export Data"); ?>
    <div class="card">
        <h2>Export Configuration Data</h2>
        <p class="text-muted mb-20">Download current configuration data as CSV files for backup or reporting.</p>

        <table>
            <thead>
                <tr>
                    <th>Export Type</th>
                    <th>Description</th>
                    <th class="text-right">Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Pricing Tiers</strong></td>
                    <td>All current pricing tiers (defaults, group overrides, customer overrides)</td>
                    <td class="text-right">
                        <a href="?action=export_pricing" class="btn btn-sm btn-success">Download CSV</a>
                    </td>
                </tr>
                <tr>
                    <td><strong>Customer Settings</strong></td>
                    <td>Customer configurations (monthly minimum, annualized settings)</td>
                    <td class="text-right">
                        <a href="?action=export_settings" class="btn btn-sm btn-success">Download CSV</a>
                    </td>
                </tr>
                <tr>
                    <td><strong>Escalators</strong></td>
                    <td>Annual price escalators with delays</td>
                    <td class="text-right">
                        <a href="?action=export_escalators" class="btn btn-sm btn-success">Download CSV</a>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <h2>Upload Configuration</h2>
        <p class="text-muted">Upload a configuration CSV file to submit for processing by the cron job.</p>
        <a href="?action=upload_config" class="btn">Upload Config CSV</a>
    </div>
<?php
} // ============================================================
// END PHASE 4
// ============================================================
// ============================================================
// PHASE 5: MOCK DATA & BOOTSTRAP
// Test data generation and application entry point
// ============================================================
/**
 * Initialize mock data for testing
 * Creates directories and sample CSV files
 * Only runs when MOCK_MODE is true
 */
function init_mock_data()
{
    if (!MOCK_MODE) {
        return;
    } // Use the shared path (which returns test_shared in mock mode)
    $base = get_shared_path();
    // Create directories
    $dirs = [
        $base,
        $base . "/generated",
        $base . "/pending",
        $base . "/archive",
    ];
    foreach ($dirs as $dir) {
        if (!is_dir($dir)) {
            mkdir($dir, 0755, true);
        }
    } // Create sample report files (simulating cron output)
    $sample_reports = [
        [
            "filename" => "report_2026-01-15_100000.csv",
            "headers" => [
                "id",
                "customer_name",
                "email",
                "status",
                "amount",
                "date",
            ],
            "rows" => [
                [
                    "id" => "1001",
                    "customer_name" => "Acme Corp",
                    "email" => "billing@acme.com",
                    "status" => "pending",
                    "amount" => "5000.00",
                    "date" => "2026-01-15",
                ],
                [
                    "id" => "1002",
                    "customer_name" => "Globex Inc",
                    "email" => "ap@globex.com",
                    "status" => "approved",
                    "amount" => "12500.00",
                    "date" => "2026-01-15",
                ],
                [
                    "id" => "1003",
                    "customer_name" => "Initech",
                    "email" => "invoices@initech.com",
                    "status" => "pending",
                    "amount" => "3200.00",
                    "date" => "2026-01-15",
                ],
                [
                    "id" => "1004",
                    "customer_name" => "Umbrella Corp",
                    "email" => "finance@umbrella.com",
                    "status" => "rejected",
                    "amount" => "8900.00",
                    "date" => "2026-01-15",
                ],
                [
                    "id" => "1005",
                    "customer_name" => "Stark Industries",
                    "email" => "pay@stark.com",
                    "status" => "pending",
                    "amount" => "45000.00",
                    "date" => "2026-01-15",
                ],
            ],
        ],
        [
            "filename" => "report_2026-01-14_100000.csv",
            "headers" => [
                "id",
                "customer_name",
                "email",
                "status",
                "amount",
                "date",
            ],
            "rows" => [
                [
                    "id" => "0998",
                    "customer_name" => "Wayne Enterprises",
                    "email" => "accounts@wayne.com",
                    "status" => "approved",
                    "amount" => "75000.00",
                    "date" => "2026-01-14",
                ],
                [
                    "id" => "0999",
                    "customer_name" => "Oscorp",
                    "email" => "billing@oscorp.com",
                    "status" => "pending",
                    "amount" => "18000.00",
                    "date" => "2026-01-14",
                ],
                [
                    "id" => "1000",
                    "customer_name" => "LexCorp",
                    "email" => "finance@lexcorp.com",
                    "status" => "approved",
                    "amount" => "22000.00",
                    "date" => "2026-01-14",
                ],
            ],
        ],
        [
            "filename" => "report_2026-01-13_100000.csv",
            "headers" => [
                "id",
                "customer_name",
                "email",
                "status",
                "amount",
                "date",
            ],
            "rows" => [
                [
                    "id" => "0995",
                    "customer_name" => "Cyberdyne",
                    "email" => "ap@cyberdyne.com",
                    "status" => "approved",
                    "amount" => "150000.00",
                    "date" => "2026-01-13",
                ],
                [
                    "id" => "0996",
                    "customer_name" => "Tyrell Corp",
                    "email" => "invoices@tyrell.com",
                    "status" => "pending",
                    "amount" => "88000.00",
                    "date" => "2026-01-13",
                ],
            ],
        ],
    ];
    foreach ($sample_reports as $report) {
        $filepath = $base . "/generated/" . $report["filename"];
        if (!file_exists($filepath)) {
            csv_write($filepath, $report["rows"], $report["headers"]);
        }
    } // Create sample archived config (historical)
    $sample_configs = [
        [
            "filename" => "config_2026-01-14_120000.csv",
            "headers" => ["id", "action", "notes"],
            "rows" => [
                [
                    "id" => "0998",
                    "action" => "approve",
                    "notes" => "Verified by finance",
                ],
                [
                    "id" => "1000",
                    "action" => "approve",
                    "notes" => "Standard processing",
                ],
            ],
        ],
        [
            "filename" => "config_2026-01-13_140000.csv",
            "headers" => ["id", "action", "notes"],
            "rows" => [
                [
                    "id" => "0995",
                    "action" => "approve",
                    "notes" => "Priority client",
                ],
            ],
        ],
    ];
    foreach ($sample_configs as $config) {
        $filepath = $base . "/archive/" . $config["filename"];
        if (!file_exists($filepath)) {
            csv_write($filepath, $config["rows"], $config["headers"]);
        }
    } // Create one pending config
    $pending_config = [
        "filename" => "config_2026-01-15_143000.csv",
        "headers" => ["id", "action", "notes"],
        "rows" => [
            [
                "id" => "1001",
                "action" => "approve",
                "notes" => "Ready for processing",
            ],
            ["id" => "1003", "action" => "approve", "notes" => ""],
            [
                "id" => "1005",
                "action" => "hold",
                "notes" => "Awaiting verification",
            ],
        ],
    ];
    $filepath = $base . "/pending/" . $pending_config["filename"];
    if (!file_exists($filepath)) {
        csv_write(
            $filepath,
            $pending_config["rows"],
            $pending_config["headers"]
        );
    }
} // ------------------------------------------------------------
// RUN APPLICATION
// ------------------------------------------------------------
// Initialize mock data if in mock mode
init_mock_data(); // Initialize SQLite and seed mock data
sqlite_db();
sqlite_seed_mock_data(); // Start session for flash messages
if (session_status() === PHP_SESSION_NONE) {
    session_start();
} // Route the request
route(); // ============================================================
// END PHASE 5
// ============================================================
